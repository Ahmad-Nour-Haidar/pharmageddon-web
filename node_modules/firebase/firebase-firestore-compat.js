!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("@firebase/app-compat"),require("@firebase/app")):"function"==typeof define&&define.amd?define(["@firebase/app-compat","@firebase/app"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).firebase,e.firebase.INTERNAL.modularAPIs)}(this,function(Kg,$g){"use strict";try{!(function(){function e(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var l,t=e(Kg);function n(t){const n=[];let r=0;for(let i=0;i<t.length;i++){let e=t.charCodeAt(i);e<128?n[r++]=e:(e<2048?n[r++]=e>>6|192:(55296==(64512&e)&&i+1<t.length&&56320==(64512&t.charCodeAt(i+1))?(e=65536+((1023&e)<<10)+(1023&t.charCodeAt(++i)),n[r++]=e>>18|240,n[r++]=e>>12&63|128):n[r++]=e>>12|224,n[r++]=e>>6&63|128),n[r++]=63&e|128)}return n}const r={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(n,e){if(!Array.isArray(n))throw Error("encodeByteArray takes an array as a parameter");this.init_();var r=e?this.byteToCharMapWebSafe_:this.byteToCharMap_;const i=[];for(let h=0;h<n.length;h+=3){var s=n[h],a=h+1<n.length,o=a?n[h+1]:0,u=h+2<n.length,c=u?n[h+2]:0;let e=(15&o)<<2|c>>6,t=63&c;u||(t=64,a||(e=64)),i.push(r[s>>2],r[(3&s)<<4|o>>4],r[e],r[t])}return i.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(n(e),t)},decodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):function(e){const t=[];let n=0,r=0;for(;n<e.length;){var i,s,a=e[n++];a<128?t[r++]=String.fromCharCode(a):191<a&&a<224?(i=e[n++],t[r++]=String.fromCharCode((31&a)<<6|63&i)):239<a&&a<365?(s=((7&a)<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++])-65536,t[r++]=String.fromCharCode(55296+(s>>10)),t[r++]=String.fromCharCode(56320+(1023&s))):(i=e[n++],s=e[n++],t[r++]=String.fromCharCode((15&a)<<12|(63&i)<<6|63&s))}return t.join("")}(this.decodeStringToByteArray(e,t))},decodeStringToByteArray(e,t){this.init_();var n=t?this.charToByteMapWebSafe_:this.charToByteMap_;const r=[];for(let u=0;u<e.length;){var i=n[e.charAt(u++)],s=u<e.length?n[e.charAt(u)]:0;++u;var a=u<e.length?n[e.charAt(u)]:64;++u;var o=u<e.length?n[e.charAt(u)]:64;if(++u,null==i||null==s||null==a||null==o)throw new c;r.push(i<<2|s>>4),64!==a&&(r.push(s<<4&240|a>>2),64!==o&&r.push(a<<6&192|o))}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}};class c extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const o=function(e){return e=e,t=n(e),r.encodeByteArray(t,!0).replace(/\./g,"");var t};const i=()=>function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("Unable to locate global object.")}().__FIREBASE_DEFAULTS__,s=()=>{if("undefined"!=typeof document){let e;try{e=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch(e){return}var t=e&&function(e){try{return r.decodeString(e,!0)}catch(e){console.error("base64Decode failed: ",e)}return null}(e[1]);return t&&JSON.parse(t)}},a=()=>{try{return i()||(()=>{if("undefined"!=typeof process&&void 0!==process.env){var e=process.env.__FIREBASE_DEFAULTS__;return e?JSON.parse(e):void 0}})()||s()}catch(e){return void console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${e}`)}};function u(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}function h(){return!function(){var e=null===(e=a())||void 0===e?void 0:e.forceEnvironment;if("node"===e)return 1;if("browser"!==e)try{return"[object process]"===Object.prototype.toString.call(global.process)}catch(e){return}}()&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}class d extends Error{constructor(e,t,n){super(t),this.code=e,this.customData=n,this.name="FirebaseError",Object.setPrototypeOf(this,d.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,f.prototype.create)}}class f{constructor(e,t,n){this.service=e,this.serviceName=t,this.errors=n}create(e,...t){var r,n=t[0]||{},i=`${this.service}/${e}`,s=this.errors[e],s=s?(r=n,s.replace(g,(e,t)=>{var n=r[t];return null!=n?String(n):`<${t}?>`})):"Error",s=`${this.serviceName}: ${s} (${i}).`;return new d(i,s,n)}}const g=/\{\$([^}]+)}/g;function m(e){return e&&e._delegate?e._delegate:e}class p{constructor(e,t,n){this.name=e,this.instanceFactory=t,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}($d=l=l||{})[$d.DEBUG=0]="DEBUG",$d[$d.VERBOSE=1]="VERBOSE",$d[$d.INFO=2]="INFO",$d[$d.WARN=3]="WARN",$d[$d.ERROR=4]="ERROR",$d[$d.SILENT=5]="SILENT";const y={debug:l.DEBUG,verbose:l.VERBOSE,info:l.INFO,warn:l.WARN,error:l.ERROR,silent:l.SILENT},v=l.INFO,w={[l.DEBUG]:"log",[l.VERBOSE]:"log",[l.INFO]:"info",[l.WARN]:"warn",[l.ERROR]:"error"},_=(e,t,...n)=>{if(!(t<e.logLevel)){var r=(new Date).toISOString(),i=w[t];if(!i)throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`);console[i](`[${r}]  ${e.name}:`,...n)}};var b,I="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},E={},T=I||self;function S(e){var t=typeof e;return"array"==(t="object"!=t?t:e?Array.isArray(e)?"array":t:"null")||"object"==t&&"number"==typeof e.length}function x(e){var t=typeof e;return"object"==t&&null!=e||"function"==t}var D="closure_uid_"+(1e9*Math.random()>>>0),C=0;function A(e,t,n){return e.call.apply(e.bind,arguments)}function N(t,n,e){if(!t)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var e=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(e,r),t.apply(n,e)}}return function(){return t.apply(n,arguments)}}function k(e,t,n){return(k=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?A:N).apply(null,arguments)}function R(t){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}function M(e,s){function t(){}t.prototype=s.prototype,e.$=s.prototype,e.prototype=new t,(e.prototype.constructor=e).ac=function(e,t,n){for(var r=Array(arguments.length-2),i=2;i<arguments.length;i++)r[i-2]=arguments[i];return s.prototype[t].apply(e,r)}}function L(){this.s=this.s,this.o=this.o}L.prototype.s=!1,L.prototype.sa=function(){var e;!this.s&&(this.s=!0,this.N(),0)&&(e=this,Object.prototype.hasOwnProperty.call(e,D)&&e[D]||(e[D]=++C))},L.prototype.N=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const O=Array.prototype.indexOf?function(e,t){return Array.prototype.indexOf.call(e,t,void 0)}:function(e,t){if("string"==typeof e)return"string"!=typeof t||1!=t.length?-1:e.indexOf(t,0);for(let n=0;n<e.length;n++)if(n in e&&e[n]===t)return n;return-1};function F(t){var n=t.length;if(0<n){const r=Array(n);for(let e=0;e<n;e++)r[e]=t[e];return r}return[]}function P(t){for(let e=1;e<arguments.length;e++){var n=arguments[e];if(S(n)){var r=t.length||0,i=n.length||0;t.length=r+i;for(let e=0;e<i;e++)t[r+e]=n[e]}else t.push(n)}}function V(e,t){this.type=e,this.g=this.target=t,this.defaultPrevented=!1}V.prototype.h=function(){this.defaultPrevented=!0};var B=function(){if(!T.addEventListener||!Object.defineProperty)return!1;var e=!1,t=Object.defineProperty({},"passive",{get:function(){e=!0}});try{var n=()=>{};T.addEventListener("test",n,t),T.removeEventListener("test",n,t)}catch(e){}return e}();function q(e){return/^[\s\xa0]*$/.test(e)}function U(){var e=T.navigator;return(e=e&&e.userAgent)?e:""}function z(e){return-1!=U().indexOf(e)}function G(e){return G[" "](e),e}G[" "]=function(){};var j,K=z("Opera"),$=z("Trident")||z("MSIE"),Q=z("Edge"),W=Q||$,H=z("Gecko")&&!(-1!=U().toLowerCase().indexOf("webkit")&&!z("Edge"))&&!(z("Trident")||z("MSIE"))&&!z("Edge"),Y=-1!=U().toLowerCase().indexOf("webkit")&&!z("Edge");function X(){var e=T.document;return e?e.documentMode:void 0}e:{var J="",Z=(Z=U(),H?/rv:([^\);]+)(\)|;)/.exec(Z):Q?/Edge\/([\d\.]+)/.exec(Z):$?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(Z):Y?/WebKit\/(\S+)/.exec(Z):K?/(?:Version)[ \/]?(\S+)/.exec(Z):void 0);if(Z&&(J=Z?Z[1]:""),$){Z=X();if(null!=Z&&Z>parseFloat(J)){j=String(Z);break e}}j=J}var ee=T.document&&$&&(X()||parseInt(j,10))||void 0;function te(e,t){if(V.call(this,e?e.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,e){var n=this.type=e.type,r=e.changedTouches&&e.changedTouches.length?e.changedTouches[0]:null;if(this.target=e.target||e.srcElement,this.g=t,t=e.relatedTarget){if(H){e:{try{G(t.nodeName);var i=!0;break e}catch(e){}i=!1}i||(t=null)}}else"mouseover"==n?t=e.fromElement:"mouseout"==n&&(t=e.toElement);this.relatedTarget=t,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==e.clientX?e.clientX:e.pageX,this.clientY=void 0!==e.clientY?e.clientY:e.pageY,this.screenX=e.screenX||0,this.screenY=e.screenY||0),this.button=e.button,this.key=e.key||"",this.ctrlKey=e.ctrlKey,this.altKey=e.altKey,this.shiftKey=e.shiftKey,this.metaKey=e.metaKey,this.pointerId=e.pointerId||0,this.pointerType="string"==typeof e.pointerType?e.pointerType:ne[e.pointerType]||"",this.state=e.state,(this.i=e).defaultPrevented&&te.$.h.call(this)}}M(te,V);var ne={2:"touch",3:"pen",4:"mouse"};te.prototype.h=function(){te.$.h.call(this);var e=this.i;e.preventDefault?e.preventDefault():e.returnValue=!1};var re="closure_listenable_"+(1e6*Math.random()|0),ie=0;function se(e,t,n,r,i){this.listener=e,this.proxy=null,this.src=t,this.type=n,this.capture=!!r,this.la=i,this.key=++ie,this.fa=this.ia=!1}function ae(e){e.fa=!0,e.listener=null,e.proxy=null,e.src=null,e.la=null}function oe(e,t,n){for(const r in e)t.call(n,e[r],r,e)}function ue(e){const t={};for(const n in e)t[n]=e[n];return t}const ce="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function he(t){let n,r;for(let i=1;i<arguments.length;i++){for(n in r=arguments[i])t[n]=r[n];for(let e=0;e<ce.length;e++)n=ce[e],Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}}function le(e){this.src=e,this.g={},this.h=0}function de(e,t){var n,r,i,s=t.type;s in e.g&&(n=e.g[s],(i=0<=(r=O(n,t)))&&Array.prototype.splice.call(n,r,1),i&&(ae(t),0==e.g[s].length&&(delete e.g[s],e.h--)))}function fe(e,t,n,r){for(var i=0;i<e.length;++i){var s=e[i];if(!s.fa&&s.listener==t&&s.capture==!!n&&s.la==r)return i}return-1}le.prototype.add=function(e,t,n,r,i){var s=e.toString();(e=this.g[s])||(e=this.g[s]=[],this.h++);var a=fe(e,t,r,i);return-1<a?(t=e[a],n||(t.ia=!1)):((t=new se(t,this.src,s,!!r,i)).ia=n,e.push(t)),t};var ge="closure_lm_"+(1e6*Math.random()|0),me={};function pe(e,t,n,r,i){if(r&&r.once)return function e(t,n,r,i,s){if(Array.isArray(n)){for(var a=0;a<n.length;a++)e(t,n[a],r,i,s);return null}r=Ee(r);return t&&t[re]?t.P(n,r,x(i)?!!i.capture:!!i,s):ye(t,n,r,!0,i,s)}(e,t,n,r,i);if(Array.isArray(t)){for(var s=0;s<t.length;s++)pe(e,t[s],n,r,i);return null}return n=Ee(n),e&&e[re]?e.O(t,n,x(r)?!!r.capture:!!r,i):ye(e,t,n,!1,r,i)}function ye(e,t,n,r,i,s){if(!t)throw Error("Invalid event type");var a=x(i)?!!i.capture:!!i,o=be(e);if(o||(e[ge]=o=new le(e)),(n=o.add(t,n,r,a,s)).proxy)return n;if(r=function(){const n=_e;return function e(t){return n.call(e.src,e.listener,t)}}(),(n.proxy=r).src=e,r.listener=n,e.addEventListener)void 0===(i=!B?a:i)&&(i=!1),e.addEventListener(t.toString(),r,i);else if(e.attachEvent)e.attachEvent(we(t.toString()),r);else{if(!e.addListener||!e.removeListener)throw Error("addEventListener and attachEvent are unavailable.");e.addListener(r)}return n}function ve(e){var t,n,r;"number"!=typeof e&&e&&!e.fa&&((t=e.src)&&t[re]?de(t.i,e):(n=e.type,r=e.proxy,t.removeEventListener?t.removeEventListener(n,r,e.capture):t.detachEvent?t.detachEvent(we(n),r):t.addListener&&t.removeListener&&t.removeListener(r),(n=be(t))?(de(n,e),0==n.h&&(n.src=null,t[ge]=null)):ae(e)))}function we(e){return e in me?me[e]:me[e]="on"+e}function _e(e,t){var n,r;return e=!!e.fa||(t=new te(t,this),n=e.listener,r=e.la||e.src,e.ia&&ve(e),n.call(r,t))}function be(e){return(e=e[ge])instanceof le?e:null}var Ie="__closure_events_fn_"+(1e9*Math.random()>>>0);function Ee(t){return"function"==typeof t?t:(t[Ie]||(t[Ie]=function(e){return t.handleEvent(e)}),t[Ie])}function Te(){L.call(this),this.i=new le(this),(this.S=this).J=null}function Se(e,t){var n,r=e.J;if(r)for(n=[];r;r=r.J)n.push(r);if(e=e.S,r=t.type||t,"string"==typeof t?t=new V(t,e):t instanceof V?t.target=t.target||e:(a=t,he(t=new V(r,e),a)),a=!0,n)for(var i=n.length-1;0<=i;i--)var s=t.g=n[i],a=xe(s,r,!0,t)&&a;if(a=xe(s=t.g=e,r,!0,t)&&a,a=xe(s,r,!1,t)&&a,n)for(i=0;i<n.length;i++)a=xe(s=t.g=n[i],r,!1,t)&&a}function xe(e,t,n,r){if(!(t=e.i.g[String(t)]))return!0;t=t.concat();for(var i=!0,s=0;s<t.length;++s){var a,o,u=t[s];u&&!u.fa&&u.capture==n&&(a=u.listener,o=u.la||u.src,u.ia&&de(e.i,u),i=!1!==a.call(o,r)&&i)}return i&&!r.defaultPrevented}M(Te,L),Te.prototype[re]=!0,Te.prototype.removeEventListener=function(e,t,n,r){!function e(t,n,r,i,s){if(Array.isArray(n))for(var a=0;a<n.length;a++)e(t,n[a],r,i,s);else i=x(i)?!!i.capture:!!i,r=Ee(r),t&&t[re]?(t=t.i,(n=String(n).toString())in t.g&&-1<(r=fe(a=t.g[n],r,i,s))&&(ae(a[r]),Array.prototype.splice.call(a,r,1),0==a.length&&(delete t.g[n],t.h--))):(t=t&&be(t))&&(n=t.g[n.toString()],(r=(t=-1)<(t=n?fe(n,r,i,s):t)?n[t]:null)&&ve(r))}(this,e,t,n,r)},Te.prototype.N=function(){if(Te.$.N.call(this),this.i){var e,t=this.i;for(e in t.g){for(var n=t.g[e],r=0;r<n.length;r++)ae(n[r]);delete t.g[e],t.h--}}this.J=null},Te.prototype.O=function(e,t,n,r){return this.i.add(String(e),t,!1,n,r)},Te.prototype.P=function(e,t,n,r){return this.i.add(String(e),t,!0,n,r)};var De=T.JSON.stringify;var Ce=new class{constructor(e,t){this.i=e,this.j=t,this.h=0,this.g=null}get(){let e;return 0<this.h?(this.h--,e=this.g,this.g=e.next,e.next=null):e=this.i(),e}}(()=>new Ae,e=>e.reset());class Ae{constructor(){this.next=this.g=this.h=null}set(e,t){this.h=e,this.g=t,this.next=null}reset(){this.next=this.g=this.h=null}}let Ne,ke=!1,Re=new class{constructor(){this.h=this.g=null}add(e,t){const n=Ce.get();n.set(e,t),this.h?this.h.next=n:this.g=n,this.h=n}},Me=()=>{const e=T.Promise.resolve(void 0);Ne=()=>{e.then(Le)}};var Le=()=>{for(var e;e=function(){var e=Re;let t=null;return e.g&&(t=e.g,e.g=e.g.next,e.g||(e.h=null),t.next=null),t}();){try{e.h.call(e.g)}catch(e){!function(e){T.setTimeout(()=>{throw e},0)}(e)}var t=Ce;t.j(e),t.h<100&&(t.h++,e.next=t.g,t.g=e)}ke=!1};function Oe(e,t){Te.call(this),this.h=e||1,this.g=t||T,this.j=k(this.qb,this),this.l=Date.now()}function Fe(e){e.ga=!1,e.T&&(e.g.clearTimeout(e.T),e.T=null)}function Pe(e,t,n){if("function"==typeof e)n&&(e=k(e,n));else{if(!e||"function"!=typeof e.handleEvent)throw Error("Invalid listener argument");e=k(e.handleEvent,e)}return 2147483647<Number(t)?-1:T.setTimeout(e,t||0)}M(Oe,Te),(b=Oe.prototype).ga=!1,b.T=null,b.qb=function(){var e;this.ga&&(0<(e=Date.now()-this.l)&&e<.8*this.h?this.T=this.g.setTimeout(this.j,this.h-e):(this.T&&(this.g.clearTimeout(this.T),this.T=null),Se(this,"tick"),this.ga&&(Fe(this),this.start())))},b.start=function(){this.ga=!0,this.T||(this.T=this.g.setTimeout(this.j,this.h),this.l=Date.now())},b.N=function(){Oe.$.N.call(this),Fe(this),delete this.g};class Ve extends L{constructor(e,t){super(),this.m=e,this.j=t,this.h=null,this.i=!1,this.g=null}l(e){this.h=arguments,this.g?this.i=!0:function e(t){t.g=Pe(()=>{t.g=null,t.i&&(t.i=!1,e(t))},t.j);var n=t.h;t.h=null,t.m.apply(null,n)}(this)}N(){super.N(),this.g&&(T.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function Be(e){L.call(this),this.h=e,this.g={}}M(Be,L);var qe=[];function Ue(e,t,n,r){Array.isArray(n)||(n&&(qe[0]=n.toString()),n=qe);for(var i=0;i<n.length;i++){var s=pe(t,n[i],r||e.handleEvent,!1,e.h||e);if(!s)break;e.g[s.key]=s}}function ze(e){oe(e.g,function(e,t){this.g.hasOwnProperty(t)&&ve(e)},e),e.g={}}function Ge(){this.g=!0}function je(e,t,n,r){e.info(function(){return"XMLHTTP TEXT ("+t+"): "+function(e,t){if(!e.g)return t;if(!t)return null;try{var n=JSON.parse(t);if(n)for(e=0;e<n.length;e++)if(Array.isArray(n[e])){var r=n[e];if(!(r.length<2)){var i=r[1];if(Array.isArray(i)&&!(i.length<1)){var s=i[0];if("noop"!=s&&"stop"!=s&&"close"!=s)for(var a=1;a<i.length;a++)i[a]=""}}}return De(n)}catch(e){return t}}(e,n)+(r?" "+r:"")})}Be.prototype.N=function(){Be.$.N.call(this),ze(this)},Be.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},Ge.prototype.Ea=function(){this.g=!1},Ge.prototype.info=function(){};var Ke={},$e=null;function Qe(){return $e=$e||new Te}function We(e){V.call(this,Ke.Ta,e)}function He(){var e=Qe();Se(e,new We(e))}function Ye(e,t){V.call(this,Ke.STAT_EVENT,e),this.stat=t}function Xe(e){var t=Qe();Se(t,new Ye(t,e))}function Je(e,t){V.call(this,Ke.Ua,e),this.size=t}function Ze(e,t){if("function"!=typeof e)throw Error("Fn must not be null and must be a function");return T.setTimeout(function(){e()},t)}Ke.Ta="serverreachability",M(We,V),Ke.STAT_EVENT="statevent",M(Ye,V),Ke.Ua="timingevent",M(Je,V);var et={NO_ERROR:0,rb:1,Eb:2,Db:3,yb:4,Cb:5,Fb:6,Qa:7,TIMEOUT:8,Ib:9},tt={wb:"complete",Sb:"success",Ra:"error",Qa:"abort",Kb:"ready",Lb:"readystatechange",TIMEOUT:"timeout",Gb:"incrementaldata",Jb:"progress",zb:"downloadprogress",$b:"uploadprogress"};function nt(){}function rt(e){return e.h||(e.h=e.i())}function it(){}nt.prototype.h=null;I={OPEN:"a",vb:"b",Ra:"c",Hb:"d"};function st(){V.call(this,"d")}function at(){V.call(this,"c")}function ot(){}function ut(e,t,n,r){this.l=e,this.j=t,this.m=n,this.W=r||1,this.U=new Be(this),this.P=lt,this.V=new Oe(e=W?125:void 0),this.I=null,this.i=!1,this.u=this.B=this.A=this.L=this.G=this.Y=this.C=null,this.F=[],this.g=null,this.o=0,this.s=this.v=null,this.ca=-1,this.J=!1,this.O=0,this.M=null,this.ba=this.K=this.aa=this.S=!1,this.h=new ct}function ct(){this.i=null,this.g="",this.h=!1}M(st,V),M(at,V),M(ot,nt),ot.prototype.g=function(){return new XMLHttpRequest},ot.prototype.i=function(){return{}};var ht=new ot,lt=45e3,dt={},ft={};function gt(e,t,n){e.L=1,e.A=Rt(Dt(t)),e.u=n,e.S=!0,mt(e,null)}function mt(e,t){e.G=Date.now(),vt(e),e.B=Dt(e.A);var a,o,u,c,h,l,n=e.B,r=e.W;Array.isArray(r)||(r=[String(r)]),Kt(n.i,"t",r),e.o=0,n=e.l.J,e.h=new ct,e.g=Kn(e.l,n?t:null,!e.u),0<e.O&&(e.M=new Ve(k(e.Pa,e,e.g),e.O)),Ue(e.U,e.g,"readystatechange",e.nb),t=e.I?ue(e.I):{},e.u?(e.v||(e.v="POST"),t["Content-Type"]="application/x-www-form-urlencoded",e.g.ha(e.B,e.v,e.u,t)):(e.v="GET",e.g.ha(e.B,e.v,null,t)),He(),a=e.j,o=e.v,u=e.B,c=e.m,h=e.W,l=e.u,a.info(function(){if(a.g)if(l)for(var e="",t=l.split("&"),n=0;n<t.length;n++){var r,i,s=t[n].split("=");1<s.length&&(r=s[0],s=s[1],e=2<=(i=r.split("_")).length&&"type"==i[1]?e+(r+"=")+s+"&":e+(r+"=redacted&"))}else e=null;else e=l;return"XMLHTTP REQ ("+c+") [attempt "+h+"]: "+o+"\n"+u+"\n"+e})}function pt(e){return e.g&&("GET"==e.v&&2!=e.L&&e.l.Ha)}function yt(e,t,n){let r=!0,i;for(;!e.J&&e.o<n.length;){if(a=n,u=o=void 0,o=(s=e).o,(i=-1==(u=a.indexOf("\n",o))?ft:(o=Number(a.substring(o,u)),isNaN(o)?dt:(u+=1)+o>a.length?ft:(a=a.slice(u,u+o),s.o=u+o,a)))==ft){4==t&&(e.s=4,Xe(14),r=!1),je(e.j,e.m,null,"[Incomplete Response]");break}if(i==dt){e.s=4,Xe(15),je(e.j,e.m,n,"[Invalid Chunk]"),r=!1;break}je(e.j,e.m,i,null),Et(e,i)}var s,a,o,u;pt(e)&&0!=e.o&&(e.h.g=e.h.g.slice(e.o),e.o=0),4!=t||0!=n.length||e.h.h||(e.s=1,Xe(16),r=!1),e.i=e.i&&r,r?0<n.length&&!e.ba&&(e.ba=!0,(t=e.l).g==e&&t.ca&&!t.M&&(t.l.info("Great, no buffering proxy detected. Bytes received: "+n.length),Pn(t),t.M=!0,Xe(11))):(je(e.j,e.m,n,"[Invalid Chunked Response]"),It(e),bt(e))}function vt(e){e.Y=Date.now()+e.P,wt(e,e.P)}function wt(e,t){if(null!=e.C)throw Error("WatchDog timer not null");e.C=Ze(k(e.lb,e),t)}function _t(e){e.C&&(T.clearTimeout(e.C),e.C=null)}function bt(e){0==e.l.H||e.J||qn(e.l,e)}function It(e){_t(e);var t=e.M;t&&"function"==typeof t.sa&&t.sa(),e.M=null,Fe(e.V),ze(e.U),e.g&&(t=e.g,e.g=null,t.abort(),t.sa())}function Et(e,t){try{var n=e.l;if(0!=n.H&&(n.g==e||Xt(n.i,e)))if(!e.K&&Xt(n.i,e)&&3==n.H){try{var r=n.Ja.g.parse(t)}catch(e){r=null}if(Array.isArray(r)&&3==r.length){var i=r;if(0==i[0]){e:if(!n.u){if(n.g){if(!(n.g.G+3e3<e.G))break e;Bn(n),An(n)}Fn(n),Xe(18)}}else n.Fa=i[1],0<n.Fa-n.V&&i[2]<37500&&n.G&&0==n.A&&!n.v&&(n.v=Ze(k(n.ib,n),6e3));if(Yt(n.i)<=1&&n.oa){try{n.oa()}catch(e){}n.oa=void 0}}else zn(n,11)}else if(!e.K&&n.g!=e||Bn(n),!q(t))for(i=n.Ja.g.parse(t),t=0;t<i.length;t++){var s=i[t];if(n.V=s[0],s=s[1],2==n.H)if("c"==s[0]){n.K=s[1],n.pa=s[2];var a=s[3];null!=a&&(n.ra=a,n.l.info("VER="+n.ra));var o=s[4];null!=o&&(n.Ga=o,n.l.info("SVER="+n.Ga));var u,c,h=s[5];null!=h&&"number"==typeof h&&0<h&&(r=1.5*h,n.L=r,n.l.info("backChannelRequestTimeoutMs_="+r)),r=n;const g=e.g;if(g){const m=g.g?g.g.getResponseHeader("X-Client-Wire-Protocol"):null;m&&((u=r.i).g||-1==m.indexOf("spdy")&&-1==m.indexOf("quic")&&-1==m.indexOf("h2")||(u.j=u.l,u.g=new Set,u.h&&(Jt(u,u.h),u.h=null))),!r.F||(c=g.g?g.g.getResponseHeader("X-HTTP-Session-Id"):null)&&(r.Da=c,kt(r.I,r.F,c))}n.H=3,n.h&&n.h.Ba(),n.ca&&(n.S=Date.now()-e.G,n.l.info("Handshake RTT: "+n.S+"ms"));var l,d,f=e;(r=n).wa=jn(r,r.J?r.pa:null,r.Y),f.K?(Zt(r.i,f),l=f,(d=r.L)&&l.setTimeout(d),l.C&&(_t(l),vt(l)),r.g=f):On(r),0<n.j.length&&kn(n)}else"stop"!=s[0]&&"close"!=s[0]||zn(n,7);else 3==n.H&&("stop"==s[0]||"close"==s[0]?"stop"==s[0]?zn(n,7):Cn(n):"noop"!=s[0]&&n.h&&n.h.Aa(s),n.A=0)}He()}catch(e){}}function Tt(e,t){if(e.forEach&&"function"==typeof e.forEach)e.forEach(t,void 0);else if(S(e)||"string"==typeof e)Array.prototype.forEach.call(e,t,void 0);else for(var n=function(e){if(e.ta&&"function"==typeof e.ta)return e.ta();if(!e.Z||"function"!=typeof e.Z){if("undefined"!=typeof Map&&e instanceof Map)return Array.from(e.keys());if(!("undefined"!=typeof Set&&e instanceof Set)){if(S(e)||"string"==typeof e){var t=[];e=e.length;for(var n=0;n<e;n++)t.push(n);return t}t=[],n=0;for(const r in e)t[n++]=r;return t}}}(e),r=function(e){if(e.Z&&"function"==typeof e.Z)return e.Z();if("undefined"!=typeof Map&&e instanceof Map||"undefined"!=typeof Set&&e instanceof Set)return Array.from(e.values());if("string"==typeof e)return e.split("");if(S(e)){for(var t=[],n=e.length,r=0;r<n;r++)t.push(e[r]);return t}for(r in t=[],n=0,e)t[n++]=e[r];return t}(e),i=r.length,s=0;s<i;s++)t.call(void 0,r[s],n&&n[s],e)}(b=ut.prototype).setTimeout=function(e){this.P=e},b.nb=function(e){e=e.target;const t=this.M;t&&3==In(e)?t.l():this.Pa(e)},b.Pa=function(e){try{if(e==this.g)e:{var t=In(this.g),n=this.g.Ia();this.g.da();if(!(t<3)&&(3!=t||W||this.g&&(this.h.h||this.g.ja()||En(this.g)))){this.J||4!=t||7==n||He(),_t(this);var r=this.g.da();this.ca=r;t:if(pt(this)){var i=En(this.g);e="";var s=i.length,a=4==In(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){It(this),bt(this);var o="";break t}this.h.i=new T.TextDecoder}for(n=0;n<s;n++)this.h.h=!0,e+=this.h.i.decode(i[n],{stream:a&&n==s-1});i.length=0,this.h.g+=e,this.o=0,o=this.h.g}else o=this.g.ja();if(this.i=200==r,l=this.j,d=this.v,f=this.B,g=this.m,m=this.W,p=t,y=r,l.info(function(){return"XMLHTTP RESP ("+g+") [ attempt "+m+"]: "+d+"\n"+f+"\n"+p+" "+y}),this.i){if(this.aa&&!this.K){t:{if(this.g){var u,c=this.g;if((u=c.g?c.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!q(u)){var h=u;break t}}h=null}if(!(r=h)){this.i=!1,this.s=3,Xe(12),It(this),bt(this);break e}je(this.j,this.m,r,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,Et(this,r)}this.S?(yt(this,t,o),W&&this.i&&3==t&&(Ue(this.U,this.V,"tick",this.mb),this.V.start())):(je(this.j,this.m,o,null),Et(this,o)),4==t&&It(this),this.i&&!this.J&&(4==t?qn(this.l,this):(this.i=!1,vt(this)))}else(function(e){const t={};e=(e.g&&2<=In(e)&&e.g.getAllResponseHeaders()||"").split("\r\n");for(let i=0;i<e.length;i++)if(!q(e[i])){var n=function(e){var t=1;e=e.split(":");const n=[];for(;0<t&&e.length;)n.push(e.shift()),t--;return e.length&&n.push(e.join(":")),n}(e[i]),r=n[0];if("string"==typeof(n=n[1])){n=n.trim();const s=t[r]||[];t[r]=s,s.push(n)}}!function(e,t){for(const n in e)t.call(void 0,e[n],n,e)}(t,function(e){return e.join(", ")})})(this.g),400==r&&0<o.indexOf("Unknown SID")?(this.s=3,Xe(12)):(this.s=0,Xe(13)),It(this),bt(this)}}}catch(e){}var l,d,f,g,m,p,y},b.mb=function(){var e,t;this.g&&(e=In(this.g),t=this.g.ja(),this.o<t.length&&(_t(this),yt(this,e,t),this.i&&4!=e&&vt(this)))},b.cancel=function(){this.J=!0,It(this)},b.lb=function(){this.C=null;var e,t,n=Date.now();0<=n-this.Y?(e=this.j,t=this.B,e.info(function(){return"TIMEOUT: "+t}),2!=this.L&&(He(),Xe(17)),It(this),this.s=2,bt(this)):wt(this,this.Y-n)};var St=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function xt(e){var t,n;this.g=this.s=this.j="",this.m=null,this.o=this.l="",this.h=!1,e instanceof xt?(this.h=e.h,Ct(this,e.j),this.s=e.s,this.g=e.g,At(this,e.m),this.l=e.l,t=e.i,(n=new Ut).i=t.i,t.g&&(n.g=new Map(t.g),n.h=t.h),Nt(this,n),this.o=e.o):e&&(t=String(e).match(St))?(this.h=!1,Ct(this,t[1]||"",!0),this.s=Mt(t[2]||""),this.g=Mt(t[3]||"",!0),At(this,t[4]),this.l=Mt(t[5]||"",!0),Nt(this,t[6]||"",!0),this.o=Mt(t[7]||"")):(this.h=!1,this.i=new Ut(null,this.h))}function Dt(e){return new xt(e)}function Ct(e,t,n){e.j=n?Mt(t,!0):t,e.j&&(e.j=e.j.replace(/:$/,""))}function At(e,t){if(t){if(t=Number(t),isNaN(t)||t<0)throw Error("Bad port number "+t);e.m=t}else e.m=null}function Nt(e,t,n){var r,i;t instanceof Ut?(e.i=t,r=e.i,(i=e.h)&&!r.j&&(zt(r),r.i=null,r.g.forEach(function(e,t){var n=t.toLowerCase();t!=n&&(Gt(this,t),Kt(this,n,e))},r)),r.j=i):(n||(t=Lt(t,Bt)),e.i=new Ut(t,e.h))}function kt(e,t,n){e.i.set(t,n)}function Rt(e){return kt(e,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),e}function Mt(e,t){return e?t?decodeURI(e.replace(/%25/g,"%2525")):decodeURIComponent(e):""}function Lt(e,t,n){return"string"==typeof e?(e=encodeURI(e).replace(t,Ot),e=n?e.replace(/%25([0-9a-fA-F]{2})/g,"%$1"):e):null}function Ot(e){return"%"+((e=e.charCodeAt(0))>>4&15).toString(16)+(15&e).toString(16)}xt.prototype.toString=function(){var e=[],t=this.j;t&&e.push(Lt(t,Ft,!0),":");var n=this.g;return!n&&"file"!=t||(e.push("//"),(t=this.s)&&e.push(Lt(t,Ft,!0),"@"),e.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&e.push(":",String(n))),(n=this.l)&&(this.g&&"/"!=n.charAt(0)&&e.push("/"),e.push(Lt(n,"/"==n.charAt(0)?Vt:Pt,!0))),(n=this.i.toString())&&e.push("?",n),(n=this.o)&&e.push("#",Lt(n,qt)),e.join("")};var Ft=/[#\/\?@]/g,Pt=/[#\?:]/g,Vt=/[#\?]/g,Bt=/[#\?@]/g,qt=/#/g;function Ut(e,t){this.h=this.g=null,this.i=e||null,this.j=!!t}function zt(n){n.g||(n.g=new Map,n.h=0,n.i&&function(e,t){if(e){e=e.split("&");for(var n=0;n<e.length;n++){var r,i=e[n].indexOf("="),s=null;0<=i?(r=e[n].substring(0,i),s=e[n].substring(i+1)):r=e[n],t(r,s?decodeURIComponent(s.replace(/\+/g," ")):"")}}}(n.i,function(e,t){n.add(decodeURIComponent(e.replace(/\+/g," ")),t)}))}function Gt(e,t){zt(e),t=$t(e,t),e.g.has(t)&&(e.i=null,e.h-=e.g.get(t).length,e.g.delete(t))}function jt(e,t){return zt(e),t=$t(e,t),e.g.has(t)}function Kt(e,t,n){Gt(e,t),0<n.length&&(e.i=null,e.g.set($t(e,t),F(n)),e.h+=n.length)}function $t(e,t){return t=String(t),t=e.j?t.toLowerCase():t}(b=Ut.prototype).add=function(e,t){zt(this),this.i=null,e=$t(this,e);var n=this.g.get(e);return n||this.g.set(e,n=[]),n.push(t),this.h+=1,this},b.forEach=function(n,r){zt(this),this.g.forEach(function(e,t){e.forEach(function(e){n.call(r,e,t,this)},this)},this)},b.ta=function(){zt(this);const t=Array.from(this.g.values()),n=Array.from(this.g.keys()),r=[];for(let s=0;s<n.length;s++){var i=t[s];for(let e=0;e<i.length;e++)r.push(n[s])}return r},b.Z=function(t){zt(this);let n=[];if("string"==typeof t)jt(this,t)&&(n=n.concat(this.g.get($t(this,t))));else{t=Array.from(this.g.values());for(let e=0;e<t.length;e++)n=n.concat(t[e])}return n},b.set=function(e,t){return zt(this),this.i=null,jt(this,e=$t(this,e))&&(this.h-=this.g.get(e).length),this.g.set(e,[t]),this.h+=1,this},b.get=function(e,t){return e&&0<(e=this.Z(e)).length?String(e[0]):t},b.toString=function(){if(this.i)return this.i;if(!this.g)return"";const e=[],t=Array.from(this.g.keys());for(var n=0;n<t.length;n++)for(var r=t[n],i=encodeURIComponent(String(r)),s=this.Z(r),r=0;r<s.length;r++){var a=i;""!==s[r]&&(a+="="+encodeURIComponent(String(s[r]))),e.push(a)}return this.i=e.join("&")};var Qt=class{constructor(e,t){this.g=e,this.map=t}};function Wt(e){this.l=e||10,e=T.PerformanceNavigationTiming?0<(e=T.performance.getEntriesByType("navigation")).length&&("hq"==e[0].nextHopProtocol||"h2"==e[0].nextHopProtocol):!!(T.g&&T.g.Ka&&T.g.Ka()&&T.g.Ka().dc),this.j=e?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function Ht(e){return e.h||e.g&&e.g.size>=e.j}function Yt(e){return e.h?1:e.g?e.g.size:0}function Xt(e,t){return e.h?e.h==t:e.g&&e.g.has(t)}function Jt(e,t){e.g?e.g.add(t):e.h=t}function Zt(e,t){e.h&&e.h==t?e.h=null:e.g&&e.g.has(t)&&e.g.delete(t)}function en(t){if(null!=t.h)return t.i.concat(t.h.F);if(null==t.g||0===t.g.size)return F(t.i);{let e=t.i;for(const n of t.g.values())e=e.concat(n.F);return e}}Wt.prototype.cancel=function(){if(this.i=en(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const e of this.g.values())e.cancel();this.g.clear()}};var tn,nn=class{stringify(e){return T.JSON.stringify(e,void 0)}parse(e){return T.JSON.parse(e,void 0)}};function rn(){this.g=new nn}function sn(e,t,n,r,i){try{t.onload=null,t.onerror=null,t.onabort=null,t.ontimeout=null,i(r)}catch(e){}}function an(e){this.l=e.ec||null,this.j=e.ob||!1}function on(e,t){Te.call(this),this.F=e,this.u=t,this.m=void 0,this.readyState=un,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}M(an,nt),an.prototype.g=function(){return new on(this.l,this.j)},an.prototype.i=(tn={},function(){return tn}),M(on,Te);var un=0;function cn(e){e.j.read().then(e.Xa.bind(e)).catch(e.ka.bind(e))}function hn(e){e.readyState=4,e.l=null,e.j=null,e.A=null,ln(e)}function ln(e){e.onreadystatechange&&e.onreadystatechange.call(e)}(b=on.prototype).open=function(e,t){if(this.readyState!=un)throw this.abort(),Error("Error reopening a connection");this.C=e,this.B=t,this.readyState=1,ln(this)},b.send=function(e){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const t={headers:this.v,method:this.C,credentials:this.m,cache:void 0};e&&(t.body=e),(this.F||T).fetch(new Request(this.B,t)).then(this.$a.bind(this),this.ka.bind(this))},b.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,hn(this)),this.readyState=un},b.$a=function(e){if(this.g&&(this.l=e,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=e.headers,this.readyState=2,ln(this)),this.g&&(this.readyState=3,ln(this),this.g)))if("arraybuffer"===this.responseType)e.arrayBuffer().then(this.Ya.bind(this),this.ka.bind(this));else if(void 0!==T.ReadableStream&&"body"in e){if(this.j=e.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;cn(this)}else e.text().then(this.Za.bind(this),this.ka.bind(this))},b.Xa=function(e){var t;this.g&&(this.u&&e.value?this.response.push(e.value):this.u||(t=e.value||new Uint8Array(0),(t=this.A.decode(t,{stream:!e.done}))&&(this.response=this.responseText+=t)),(e.done?hn:ln)(this),3==this.readyState&&cn(this))},b.Za=function(e){this.g&&(this.response=this.responseText=e,hn(this))},b.Ya=function(e){this.g&&(this.response=e,hn(this))},b.ka=function(){this.g&&hn(this)},b.setRequestHeader=function(e,t){this.v.append(e,t)},b.getResponseHeader=function(e){return this.h&&this.h.get(e.toLowerCase())||""},b.getAllResponseHeaders=function(){if(!this.h)return"";const e=[],t=this.h.entries();for(var n=t.next();!n.done;)n=n.value,e.push(n[0]+": "+n[1]),n=t.next();return e.join("\r\n")},Object.defineProperty(on.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(e){this.m=e?"include":"same-origin"}});var dn=T.JSON.parse;function fn(e){Te.call(this),this.headers=new Map,this.u=e||null,this.h=!1,this.C=this.g=null,this.I="",this.m=0,this.j="",this.l=this.G=this.v=this.F=!1,this.B=0,this.A=null,this.K=gn,this.L=this.M=!1}M(fn,Te);var gn="",mn=/^https?$/i,pn=["POST","PUT"];function yn(e,t){e.h=!1,e.g&&(e.l=!0,e.g.abort(),e.l=!1),e.j=t,e.m=5,vn(e),_n(e)}function vn(e){e.F||(e.F=!0,Se(e,"complete"),Se(e,"error"))}function wn(e){if(e.h&&void 0!==E&&(!e.C[1]||4!=In(e)||2!=e.da()))if(e.v&&4==In(e))Pe(e.La,0,e);else if(Se(e,"readystatechange"),4==In(e)){e.h=!1;try{var t,n,r,i=e.da();e:switch(i){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var s=!0;break e;default:s=!1}if((t=s)||((n=0===i)&&(!(r=String(e.I).match(St)[1]||null)&&T.self&&T.self.location&&(r=T.self.location.protocol.slice(0,-1)),n=!mn.test(r?r.toLowerCase():"")),t=n),t)Se(e,"complete"),Se(e,"success");else{e.m=6;try{var a=2<In(e)?e.g.statusText:""}catch(e){a=""}e.j=a+" ["+e.da()+"]",vn(e)}}finally{_n(e)}}}function _n(e,t){if(e.g){bn(e);const n=e.g,r=e.C[0]?()=>{}:null;e.g=null,e.C=null,t||Se(e,"ready");try{n.onreadystatechange=r}catch(e){}}}function bn(e){e.g&&e.L&&(e.g.ontimeout=null),e.A&&(T.clearTimeout(e.A),e.A=null)}function In(e){return e.g?e.g.readyState:0}function En(e){try{if(!e.g)return null;if("response"in e.g)return e.g.response;switch(e.K){case gn:case"text":return e.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in e.g)return e.g.mozResponseArrayBuffer}return null}catch(e){return null}}function Tn(e){let n="";return oe(e,function(e,t){n+=t,n+=":",n+=e,n+="\r\n"}),n}function Sn(e,t,n){e:{for(r in n){var r=!1;break e}r=!0}r||(n=Tn(n),"string"==typeof e?null!=n&&encodeURIComponent(String(n)):kt(e,t,n))}function xn(e,t,n){return n&&n.internalChannelParams&&n.internalChannelParams[e]||t}function Dn(e){this.Ga=0,this.j=[],this.l=new Ge,this.pa=this.wa=this.I=this.Y=this.g=this.Da=this.F=this.na=this.o=this.U=this.s=null,this.fb=this.W=0,this.cb=xn("failFast",!1,e),this.G=this.v=this.u=this.m=this.h=null,this.aa=!0,this.Fa=this.V=-1,this.ba=this.A=this.C=0,this.ab=xn("baseRetryDelayMs",5e3,e),this.hb=xn("retryDelaySeedMs",1e4,e),this.eb=xn("forwardChannelMaxRetries",2,e),this.xa=xn("forwardChannelRequestTimeoutMs",2e4,e),this.va=e&&e.xmlHttpFactory||void 0,this.Ha=e&&e.useFetchStreams||!1,this.L=void 0,this.J=e&&e.supportsCrossDomainXhr||!1,this.K="",this.i=new Wt(e&&e.concurrentRequestLimit),this.Ja=new rn,this.P=e&&e.fastHandshake||!1,this.O=e&&e.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.bb=e&&e.bc||!1,e&&e.Ea&&this.l.Ea(),e&&e.forceLongPolling&&(this.aa=!1),this.ca=!this.P&&this.aa&&e&&e.detectBufferingProxy||!1,this.qa=void 0,e&&e.longPollingTimeout&&0<e.longPollingTimeout&&(this.qa=e.longPollingTimeout),this.oa=void 0,this.S=0,this.M=!1,this.ma=this.B=null}function Cn(e){if(Nn(e),3==e.H){var t=e.W++,n=Dt(e.I);if(kt(n,"SID",e.K),kt(n,"RID",t),kt(n,"TYPE","terminate"),Mn(e,n),(t=new ut(e,e.l,t)).L=2,t.A=Rt(Dt(n)),n=!1,T.navigator&&T.navigator.sendBeacon)try{n=T.navigator.sendBeacon(t.A.toString(),"")}catch(e){}!n&&T.Image&&((new Image).src=t.A,n=!0),n||(t.g=Kn(t.l,null),t.g.ha(t.A)),t.G=Date.now(),vt(t)}Gn(e)}function An(e){e.g&&(Pn(e),e.g.cancel(),e.g=null)}function Nn(e){An(e),e.u&&(T.clearTimeout(e.u),e.u=null),Bn(e),e.i.cancel(),e.m&&("number"==typeof e.m&&T.clearTimeout(e.m),e.m=null)}function kn(e){var t;Ht(e.i)||e.m||(e.m=!0,t=e.Na,Ne||Me(),ke||(Ne(),ke=!0),Re.add(t,e),e.C=0)}function Rn(e,t){var n=t?t.m:e.W++,r=Dt(e.I);kt(r,"SID",e.K),kt(r,"RID",n),kt(r,"AID",e.V),Mn(e,r),e.o&&e.s&&Sn(r,e.o,e.s),n=new ut(e,e.l,n,e.C+1),null===e.o&&(n.I=e.s),t&&(e.j=t.F.concat(e.j)),t=Ln(e,n,1e3),n.setTimeout(Math.round(.5*e.xa)+Math.round(.5*e.xa*Math.random())),Jt(e.i,n),gt(n,r,t)}function Mn(e,n){e.na&&oe(e.na,function(e,t){kt(n,t,e)}),e.h&&Tt({},function(e,t){kt(n,t,e)})}function Ln(e,t,r){r=Math.min(e.j.length,r);var i=e.h?k(e.h.Va,e.h,e):null;e:{var s=e.j;let n=-1;for(;;){const u=["count="+r];-1==n?0<r?(n=s[0].g,u.push("ofs="+n)):n=0:u.push("ofs="+n);let e=!0;for(let t=0;t<r;t++){var a=s[t].g,o=s[t].map;if((a-=n)<0)n=Math.max(0,s[t].g-100),e=!1;else try{!function(e,r,t){const i=t||"";try{Tt(e,function(e,t){let n=e;x(e)&&(n=De(e)),r.push(i+t+"="+encodeURIComponent(n))})}catch(e){throw r.push(i+"type="+encodeURIComponent("_badmap")),e}}(o,u,"req"+a+"_")}catch(e){i&&i(o)}}if(e){i=u.join("&");break e}}}return e=e.j.splice(0,r),t.F=e,i}function On(e){var t;e.g||e.u||(e.ba=1,t=e.Ma,Ne||Me(),ke||(Ne(),ke=!0),Re.add(t,e),e.A=0)}function Fn(e){return!(e.g||e.u||3<=e.A)&&(e.ba++,e.u=Ze(k(e.Ma,e),Un(e,e.A)),e.A++,1)}function Pn(e){null!=e.B&&(T.clearTimeout(e.B),e.B=null)}function Vn(e){e.g=new ut(e,e.l,"rpc",e.ba),null===e.o&&(e.g.I=e.s),e.g.O=0;var t=Dt(e.wa);kt(t,"RID","rpc"),kt(t,"SID",e.K),kt(t,"AID",e.V),kt(t,"CI",e.G?"0":"1"),!e.G&&e.qa&&kt(t,"TO",e.qa),kt(t,"TYPE","xmlhttp"),Mn(e,t),e.o&&e.s&&Sn(t,e.o,e.s),e.L&&e.g.setTimeout(e.L);var n=e.g;e=e.pa,n.L=1,n.A=Rt(Dt(t)),n.u=null,n.S=!0,mt(n,e)}function Bn(e){null!=e.v&&(T.clearTimeout(e.v),e.v=null)}function qn(e,t){var n,r,i,s=null;if(e.g==t){Bn(e),Pn(e),e.g=null;var a=2}else{if(!Xt(e.i,t))return;s=t.F,Zt(e.i,t),a=1}if(0!=e.H)if(t.i)1==a?(s=t.u?t.u.length:0,t=Date.now()-t.G,n=e.C,Se(a=Qe(),new Je(a,s)),kn(e)):On(e);else if(3==(n=t.s)||0==n&&0<t.ca||(1!=a||(i=t,Yt((r=e).i)>=r.i.j-(r.m?1:0)||(r.m?(r.j=i.F.concat(r.j),0):1==r.H||2==r.H||r.C>=(r.cb?0:r.eb)||(r.m=Ze(k(r.Na,r,i),Un(r,r.C)),r.C++,0))))&&(2!=a||!Fn(e)))switch(s&&0<s.length&&(t=e.i,t.i=t.i.concat(s)),n){case 1:zn(e,5);break;case 4:zn(e,10);break;case 3:zn(e,6);break;default:zn(e,2)}}function Un(e,t){let n=e.ab+Math.floor(Math.random()*e.hb);return e.isActive()||(n*=2),n*t}function zn(e,t){var n,r;e.l.info("Error code "+t),2==t?(n=null,e.h&&(n=null),r=k(e.pb,e),n||(n=new xt("//www.google.com/images/cleardot.gif"),T.location&&"http"==T.location.protocol||Ct(n,"https"),Rt(n)),function(e,t){var n=new Ge;if(T.Image){const r=new Image;r.onload=R(sn,n,r,"TestLoadImage: loaded",!0,t),r.onerror=R(sn,n,r,"TestLoadImage: error",!1,t),r.onabort=R(sn,n,r,"TestLoadImage: abort",!1,t),r.ontimeout=R(sn,n,r,"TestLoadImage: timeout",!1,t),T.setTimeout(function(){r.ontimeout&&r.ontimeout()},1e4),r.src=e}else t(!1)}(n.toString(),r)):Xe(2),e.H=0,e.h&&e.h.za(t),Gn(e),Nn(e)}function Gn(e){var t;e.H=0,e.ma=[],e.h&&(0==(t=en(e.i)).length&&0==e.j.length||(P(e.ma,t),P(e.ma,e.j),e.i.i.length=0,F(e.j),e.j.length=0),e.h.ya())}function jn(e,t,n){var r,i,s=n instanceof xt?Dt(n):new xt(n);return""!=s.g?(t&&(s.g=t+"."+s.g),At(s,s.m)):(s=(r=T.location).protocol,t=t?t+"."+r.hostname:r.hostname,r=+r.port,i=new xt(null),s&&Ct(i,s),t&&(i.g=t),r&&At(i,r),n&&(i.l=n),s=i),n=e.F,t=e.Da,n&&t&&kt(s,n,t),kt(s,"VER",e.ra),Mn(e,s),s}function Kn(e,t,n){if(t&&!e.J)throw Error("Can't create secondary domain capable XhrIo object.");return(t=e.Ha&&!e.va?new fn(new an({ob:n})):new fn(e.va)).Oa(e.J),t}function $n(){}function Qn(){if($&&!(10<=Number(ee)))throw Error("Environmental error: no available transport.")}function Wn(e,t){Te.call(this),this.g=new Dn(t),this.l=e,this.h=t&&t.messageUrlParams||null,e=t&&t.messageHeaders||null,t&&t.clientProtocolHeaderRequired&&(e?e["X-Client-Protocol"]="webchannel":e={"X-Client-Protocol":"webchannel"}),this.g.s=e,e=t&&t.initMessageHeaders||null,t&&t.messageContentType&&(e?e["X-WebChannel-Content-Type"]=t.messageContentType:e={"X-WebChannel-Content-Type":t.messageContentType}),t&&t.Ca&&(e?e["X-WebChannel-Client-Profile"]=t.Ca:e={"X-WebChannel-Client-Profile":t.Ca}),this.g.U=e,(e=t&&t.cc)&&!q(e)&&(this.g.o=e),this.A=t&&t.supportsCrossDomainXhr||!1,this.v=t&&t.sendRawJson||!1,(t=t&&t.httpSessionIdParam)&&!q(t)&&(this.g.F=t,null!==(e=this.h)&&t in e&&(t in(e=this.h)&&delete e[t])),this.j=new Xn(this)}function Hn(e){st.call(this),e.__headers__&&(this.headers=e.__headers__,this.statusCode=e.__status__,delete e.__headers__,delete e.__status__);var t=e.__sm__;if(t){e:{for(const n in t){e=n;break e}e=void 0}(this.i=e)&&(e=this.i,t=null!==t&&e in t?t[e]:void 0),this.data=t}else this.data=e}function Yn(){at.call(this),this.status=1}function Xn(e){this.g=e}function Jn(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.m=Array(this.blockSize),this.i=this.h=0,this.reset()}function Zn(e,t,n){n=n||0;var r=Array(16);if("string"==typeof t)for(var i=0;i<16;++i)r[i]=t.charCodeAt(n++)|t.charCodeAt(n++)<<8|t.charCodeAt(n++)<<16|t.charCodeAt(n++)<<24;else for(i=0;i<16;++i)r[i]=t[n++]|t[n++]<<8|t[n++]<<16|t[n++]<<24;t=e.g[0],n=e.g[1];var i=e.g[2],s=e.g[3],a=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=n+((a=t+(s^n&(i^s))+r[0]+3614090360&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[1]+3905402710&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[2]+606105819&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[3]+3250441966&4294967295)<<22&4294967295|a>>>10))+((a=t+(s^n&(i^s))+r[4]+4118548399&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[5]+1200080426&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[6]+2821735955&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[7]+4249261313&4294967295)<<22&4294967295|a>>>10))+((a=t+(s^n&(i^s))+r[8]+1770035416&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[9]+2336552879&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[10]+4294925233&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[11]+2304563134&4294967295)<<22&4294967295|a>>>10))+((a=t+(s^n&(i^s))+r[12]+1804603682&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[13]+4254626195&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[14]+2792965006&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[15]+1236535329&4294967295)<<22&4294967295|a>>>10))+((a=t+(i^s&(n^i))+r[1]+4129170786&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[6]+3225465664&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[11]+643717713&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[0]+3921069994&4294967295)<<20&4294967295|a>>>12))+((a=t+(i^s&(n^i))+r[5]+3593408605&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[10]+38016083&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[15]+3634488961&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[4]+3889429448&4294967295)<<20&4294967295|a>>>12))+((a=t+(i^s&(n^i))+r[9]+568446438&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[14]+3275163606&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[3]+4107603335&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[8]+1163531501&4294967295)<<20&4294967295|a>>>12))+((a=t+(i^s&(n^i))+r[13]+2850285829&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[2]+4243563512&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[7]+1735328473&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[12]+2368359562&4294967295)<<20&4294967295|a>>>12))+((a=t+(n^i^s)+r[5]+4294588738&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[8]+2272392833&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[11]+1839030562&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[14]+4259657740&4294967295)<<23&4294967295|a>>>9))+((a=t+(n^i^s)+r[1]+2763975236&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[4]+1272893353&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[7]+4139469664&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[10]+3200236656&4294967295)<<23&4294967295|a>>>9))+((a=t+(n^i^s)+r[13]+681279174&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[0]+3936430074&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[3]+3572445317&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[6]+76029189&4294967295)<<23&4294967295|a>>>9))+((a=t+(n^i^s)+r[9]+3654602809&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[12]+3873151461&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[15]+530742520&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[2]+3299628645&4294967295)<<23&4294967295|a>>>9))+((a=t+(i^(n|~s))+r[0]+4096336452&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[7]+1126891415&4294967295)<<10&4294967295|a>>>22))+((a=i+(t^(s|~n))+r[14]+2878612391&4294967295)<<15&4294967295|a>>>17))+((a=n+(s^(i|~t))+r[5]+4237533241&4294967295)<<21&4294967295|a>>>11))+((a=t+(i^(n|~s))+r[12]+1700485571&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[3]+2399980690&4294967295)<<10&4294967295|a>>>22))+((a=i+(t^(s|~n))+r[10]+4293915773&4294967295)<<15&4294967295|a>>>17))+((a=n+(s^(i|~t))+r[1]+2240044497&4294967295)<<21&4294967295|a>>>11))+((a=t+(i^(n|~s))+r[8]+1873313359&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[15]+4264355552&4294967295)<<10&4294967295|a>>>22))+((a=i+(t^(s|~n))+r[6]+2734768916&4294967295)<<15&4294967295|a>>>17))+((a=n+(s^(i|~t))+r[13]+1309151649&4294967295)<<21&4294967295|a>>>11))+((s=(t=n+((a=t+(i^(n|~s))+r[4]+4149444226&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[11]+3174756917&4294967295)<<10&4294967295|a>>>22))^((i=s+((a=i+(t^(s|~n))+r[2]+718787259&4294967295)<<15&4294967295|a>>>17))|~t))+r[9]+3951481745&4294967295;e.g[0]=e.g[0]+t&4294967295,e.g[1]=e.g[1]+(i+(a<<21&4294967295|a>>>11))&4294967295,e.g[2]=e.g[2]+i&4294967295,e.g[3]=e.g[3]+s&4294967295}function er(e,t){this.h=t;for(var n=[],r=!0,i=e.length-1;0<=i;i--){var s=0|e[i];r&&s==t||(n[i]=s,r=!1)}this.g=n}(b=fn.prototype).Oa=function(e){this.M=e},b.ha=function(e,t,n,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.I+"; newUri="+e);t=t?t.toUpperCase():"GET",this.I=e,this.j="",this.m=0,this.F=!1,this.h=!0,this.g=(this.u||ht).g(),this.C=this.u?rt(this.u):rt(ht),this.g.onreadystatechange=k(this.La,this);try{this.G=!0,this.g.open(t,String(e),!0),this.G=!1}catch(e){return void yn(this,e)}if(e=n||"",n=new Map(this.headers),r)if(Object.getPrototypeOf(r)===Object.prototype)for(var i in r)n.set(i,r[i]);else{if("function"!=typeof r.keys||"function"!=typeof r.get)throw Error("Unknown input type for opt_headers: "+String(r));for(const u of r.keys())n.set(u,r.get(u))}r=Array.from(n.keys()).find(e=>"content-type"==e.toLowerCase()),i=T.FormData&&e instanceof T.FormData,0<=O(pn,t)&&!r&&!i&&n.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(var[s,a]of n)this.g.setRequestHeader(s,a);this.K&&(this.g.responseType=this.K),"withCredentials"in this.g&&this.g.withCredentials!==this.M&&(this.g.withCredentials=this.M);try{bn(this),0<this.B&&((this.L=(o=this.g,$&&"number"==typeof o.timeout&&void 0!==o.ontimeout))?(this.g.timeout=this.B,this.g.ontimeout=k(this.ua,this)):this.A=Pe(this.ua,this.B,this)),this.v=!0,this.g.send(e),this.v=!1}catch(e){yn(this,e)}var o},b.ua=function(){void 0!==E&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,Se(this,"timeout"),this.abort(8))},b.abort=function(e){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=e||7,Se(this,"complete"),Se(this,"abort"),_n(this))},b.N=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),_n(this,!0)),fn.$.N.call(this)},b.La=function(){this.s||(this.G||this.v||this.l?wn(this):this.kb())},b.kb=function(){wn(this)},b.isActive=function(){return!!this.g},b.da=function(){try{return 2<In(this)?this.g.status:-1}catch(e){return-1}},b.ja=function(){try{return this.g?this.g.responseText:""}catch(e){return""}},b.Wa=function(e){if(this.g){var t=this.g.responseText;return e&&0==t.indexOf(e)&&(t=t.substring(e.length)),dn(t)}},b.Ia=function(){return this.m},b.Sa=function(){return"string"==typeof this.j?this.j:String(this.j)},(b=Dn.prototype).ra=8,b.H=1,b.Na=function(t){if(this.m)if(this.m=null,1==this.H){if(!t){this.W=Math.floor(1e5*Math.random()),t=this.W++;const s=new ut(this,this.l,t);let e=this.s;if(this.U&&(e?(e=ue(e),he(e,this.U)):e=this.U),null!==this.o||this.O||(s.I=e,e=null),this.P)e:{for(var n=0,r=0;r<this.j.length;r++){var i=this.j[r];if("__data__"in i.map&&"string"==typeof(i=i.map.__data__)?i=i.length:i=void 0,void 0===i)break;if(4096<(n+=i)){n=r;break e}if(4096===n||r===this.j.length-1){n=r+1;break e}}n=1e3}else n=1e3;n=Ln(this,s,n),kt(r=Dt(this.I),"RID",t),kt(r,"CVER",22),this.F&&kt(r,"X-HTTP-Session-Id",this.F),Mn(this,r),e&&(this.O?n="headers="+encodeURIComponent(String(Tn(e)))+"&"+n:this.o&&Sn(r,this.o,e)),Jt(this.i,s),this.bb&&kt(r,"TYPE","init"),this.P?(kt(r,"$req",n),kt(r,"SID","null"),s.aa=!0,gt(s,r,null)):gt(s,r,n),this.H=2}}else 3==this.H&&(t?Rn(this,t):0==this.j.length||Ht(this.i)||Rn(this))},b.Ma=function(){var e;this.u=null,Vn(this),this.ca&&!(this.M||null==this.g||this.S<=0)&&(e=2*this.S,this.l.info("BP detection timer enabled: "+e),this.B=Ze(k(this.jb,this),e))},b.jb=function(){this.B&&(this.B=null,this.l.info("BP detection timeout reached."),this.l.info("Buffering proxy detected and switch to long-polling!"),this.G=!1,this.M=!0,Xe(10),An(this),Vn(this))},b.ib=function(){null!=this.v&&(this.v=null,An(this),Fn(this),Xe(19))},b.pb=function(e){e?(this.l.info("Successfully pinged google.com"),Xe(2)):(this.l.info("Failed to ping google.com"),Xe(1))},b.isActive=function(){return!!this.h&&this.h.isActive(this)},(b=$n.prototype).Ba=function(){},b.Aa=function(){},b.za=function(){},b.ya=function(){},b.isActive=function(){return!0},b.Va=function(){},Qn.prototype.g=function(e,t){return new Wn(e,t)},M(Wn,Te),Wn.prototype.m=function(){this.g.h=this.j,this.A&&(this.g.J=!0);var e=this.g,t=this.l,n=this.h||void 0;Xe(0),e.Y=t,e.na=n||{},e.G=e.aa,e.I=jn(e,null,e.Y),kn(e)},Wn.prototype.close=function(){Cn(this.g)},Wn.prototype.u=function(e){var t,n=this.g;"string"==typeof e?((t={}).__data__=e,e=t):this.v&&((t={}).__data__=De(e),e=t),n.j.push(new Qt(n.fb++,e)),3==n.H&&kn(n)},Wn.prototype.N=function(){this.g.h=null,delete this.j,Cn(this.g),delete this.g,Wn.$.N.call(this)},M(Hn,st),M(Yn,at),M(Xn,$n),Xn.prototype.Ba=function(){Se(this.g,"a")},Xn.prototype.Aa=function(e){Se(this.g,new Hn(e))},Xn.prototype.za=function(e){Se(this.g,new Yn)},Xn.prototype.ya=function(){Se(this.g,"b")},M(Jn,function(){this.blockSize=-1}),Jn.prototype.reset=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.i=this.h=0},Jn.prototype.j=function(e,t){for(var n=(t=void 0===t?e.length:t)-this.blockSize,r=this.m,i=this.h,s=0;s<t;){if(0==i)for(;s<=n;)Zn(this,e,s),s+=this.blockSize;if("string"==typeof e){for(;s<t;)if(r[i++]=e.charCodeAt(s++),i==this.blockSize){Zn(this,r),i=0;break}}else for(;s<t;)if(r[i++]=e[s++],i==this.blockSize){Zn(this,r),i=0;break}}this.h=i,this.i+=t},Jn.prototype.l=function(){var e=Array((this.h<56?this.blockSize:2*this.blockSize)-this.h);e[0]=128;for(var t=1;t<e.length-8;++t)e[t]=0;for(var n=8*this.i,t=e.length-8;t<e.length;++t)e[t]=255&n,n/=256;for(this.j(e),e=Array(16),t=n=0;t<4;++t)for(var r=0;r<32;r+=8)e[n++]=this.g[t]>>>r&255;return e};var tr={};function nr(e){return-128<=e&&e<128?(t=e,n=function(e){return new er([0|e],e<0?-1:0)},r=tr,Object.prototype.hasOwnProperty.call(r,t)?r[t]:r[t]=n(t)):new er([0|e],e<0?-1:0);var t,n,r}function rr(e){if(isNaN(e)||!isFinite(e))return sr;if(e<0)return hr(rr(-e));for(var t=[],n=1,r=0;n<=e;r++)t[r]=e/n|0,n*=ir;return new er(t,0)}var ir=4294967296,sr=nr(0),ar=nr(1),or=nr(16777216);function ur(e){if(0==e.h){for(var t=0;t<e.g.length;t++)if(0!=e.g[t])return;return 1}}function cr(e){return-1==e.h}function hr(e){for(var t=e.g.length,n=[],r=0;r<t;r++)n[r]=~e.g[r];return new er(n,~e.h).add(ar)}function lr(e,t){return e.add(hr(t))}function dr(e,t){for(;(65535&e[t])!=e[t];)e[t+1]+=e[t]>>>16,e[t]&=65535,t++}function fr(e,t){this.g=e,this.h=t}function gr(e,t){if(ur(t))throw Error("division by zero");if(ur(e))return new fr(sr,sr);if(cr(e))return t=gr(hr(e),t),new fr(hr(t.g),hr(t.h));if(cr(t))return t=gr(e,hr(t)),new fr(hr(t.g),t.h);if(30<e.g.length){if(cr(e)||cr(t))throw Error("slowDivide_ only works with positive integers.");for(var n=ar,r=t;r.X(e)<=0;)n=mr(n),r=mr(r);for(var i=pr(n,1),s=pr(r,1),r=pr(r,2),n=pr(n,2);!ur(r);){var a=s.add(r);a.X(e)<=0&&(i=i.add(n),s=a),r=pr(r,1),n=pr(n,1)}return t=lr(e,i.R(t)),new fr(i,t)}for(i=sr;0<=e.X(t);){for(n=Math.max(1,Math.floor(e.ea()/t.ea())),r=(r=Math.ceil(Math.log(n)/Math.LN2))<=48?1:Math.pow(2,r-48),a=(s=rr(n)).R(t);cr(a)||0<a.X(e);)a=(s=rr(n-=r)).R(t);ur(s)&&(s=ar),i=i.add(s),e=lr(e,a)}return new fr(i,e)}function mr(e){for(var t=e.g.length+1,n=[],r=0;r<t;r++)n[r]=e.D(r)<<1|e.D(r-1)>>>31;return new er(n,e.h)}function pr(e,t){var n=t>>5;t%=32;for(var r=e.g.length-n,i=[],s=0;s<r;s++)i[s]=0<t?e.D(s+n)>>>t|e.D(s+n+1)<<32-t:e.D(s+n);return new er(i,e.h)}(b=er.prototype).ea=function(){if(cr(this))return-hr(this).ea();for(var e=0,t=1,n=0;n<this.g.length;n++){var r=this.D(n);e+=(0<=r?r:ir+r)*t,t*=ir}return e},b.toString=function(e){if((e=e||10)<2||36<e)throw Error("radix out of range: "+e);if(ur(this))return"0";if(cr(this))return"-"+hr(this).toString(e);for(var t=rr(Math.pow(e,6)),n=this,r="";;){var i=gr(n,t).g,s=((0<(n=lr(n,i.R(t))).g.length?n.g[0]:n.h)>>>0).toString(e);if(ur(n=i))return s+r;for(;s.length<6;)s="0"+s;r=s+r}},b.D=function(e){return e<0?0:e<this.g.length?this.g[e]:this.h},b.X=function(e){return cr(e=lr(this,e))?-1:ur(e)?0:1},b.abs=function(){return cr(this)?hr(this):this},b.add=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0,i=0;i<=t;i++){var s=r+(65535&this.D(i))+(65535&e.D(i)),a=(s>>>16)+(this.D(i)>>>16)+(e.D(i)>>>16),r=a>>>16;s&=65535,a&=65535,n[i]=a<<16|s}return new er(n,-2147483648&n[n.length-1]?-1:0)},b.R=function(e){if(ur(this)||ur(e))return sr;if(cr(this))return cr(e)?hr(this).R(hr(e)):hr(hr(this).R(e));if(cr(e))return hr(this.R(hr(e)));if(this.X(or)<0&&e.X(or)<0)return rr(this.ea()*e.ea());for(var t=this.g.length+e.g.length,n=[],r=0;r<2*t;r++)n[r]=0;for(r=0;r<this.g.length;r++)for(var i=0;i<e.g.length;i++){var s=this.D(r)>>>16,a=65535&this.D(r),o=e.D(i)>>>16,u=65535&e.D(i);n[2*r+2*i]+=a*u,dr(n,2*r+2*i),n[2*r+2*i+1]+=s*u,dr(n,2*r+2*i+1),n[2*r+2*i+1]+=a*o,dr(n,2*r+2*i+1),n[2*r+2*i+2]+=s*o,dr(n,2*r+2*i+2)}for(r=0;r<t;r++)n[r]=n[2*r+1]<<16|n[2*r];for(r=t;r<2*t;r++)n[r]=0;return new er(n,0)},b.gb=function(e){return gr(this,e).h},b.and=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0;r<t;r++)n[r]=this.D(r)&e.D(r);return new er(n,this.h&e.h)},b.or=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0;r<t;r++)n[r]=this.D(r)|e.D(r);return new er(n,this.h|e.h)},b.xor=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0;r<t;r++)n[r]=this.D(r)^e.D(r);return new er(n,this.h^e.h)},Qn.prototype.createWebChannel=Qn.prototype.g,Wn.prototype.send=Wn.prototype.u,Wn.prototype.open=Wn.prototype.m,et.NO_ERROR=0,et.TIMEOUT=8,et.HTTP_ERROR=6,tt.COMPLETE="complete",(it.EventType=I).OPEN="a",I.CLOSE="b",I.ERROR="c",I.MESSAGE="d",Te.prototype.listen=Te.prototype.O,fn.prototype.listenOnce=fn.prototype.P,fn.prototype.getLastError=fn.prototype.Sa,fn.prototype.getLastErrorCode=fn.prototype.Ia,fn.prototype.getStatus=fn.prototype.da,fn.prototype.getResponseJson=fn.prototype.Wa,fn.prototype.getResponseText=fn.prototype.ja,fn.prototype.send=fn.prototype.ha,fn.prototype.setWithCredentials=fn.prototype.Oa,Jn.prototype.digest=Jn.prototype.l,Jn.prototype.update=Jn.prototype.j,er.prototype.multiply=er.prototype.R,er.prototype.modulo=er.prototype.gb,er.prototype.compare=er.prototype.X,er.prototype.toNumber=er.prototype.ea,er.prototype.getBits=er.prototype.D,er.fromNumber=rr,er.fromString=function e(t,n){if(0==t.length)throw Error("number format error: empty string");if((n=n||10)<2||36<n)throw Error("radix out of range: "+n);if("-"==t.charAt(0))return hr(e(t.substring(1),n));if(0<=t.indexOf("-"))throw Error('number format error: interior "-" character');for(var r=rr(Math.pow(n,8)),i=sr,s=0;s<t.length;s+=8)var a=Math.min(8,t.length-s),o=parseInt(t.substring(s,s+a),n),i=a<8?(a=rr(Math.pow(n,a)),i.R(a).add(rr(o))):(i=i.R(r)).add(rr(o));return i};var yr,vr=Qe,wr=et,_r=tt,br=Ke,Ir=10,Er=11,Tr=it,Sr=fn,xr=Jn,Dr=er;const Cr="@firebase/firestore";class Ar{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}Ar.UNAUTHENTICATED=new Ar(null),Ar.GOOGLE_CREDENTIALS=new Ar("google-credentials-uid"),Ar.FIRST_PARTY=new Ar("first-party-uid"),Ar.MOCK_USER=new Ar("mock-user");let Nr="10.7.1";const kr=new class{constructor(e){this.name=e,this._logLevel=v,this._logHandler=_,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in l))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel="string"==typeof e?y[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,l.DEBUG,...e),this._logHandler(this,l.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,l.VERBOSE,...e),this._logHandler(this,l.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,l.INFO,...e),this._logHandler(this,l.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,l.WARN,...e),this._logHandler(this,l.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,l.ERROR,...e),this._logHandler(this,l.ERROR,...e)}}("@firebase/firestore");function Rr(){return kr.logLevel}function Mr(e,...t){var n;kr.logLevel<=l.DEBUG&&(n=t.map(Fr),kr.debug(`Firestore (${Nr}): ${e}`,...n))}function Lr(e,...t){var n;kr.logLevel<=l.ERROR&&(n=t.map(Fr),kr.error(`Firestore (${Nr}): ${e}`,...n))}function Or(e,...t){var n;kr.logLevel<=l.WARN&&(n=t.map(Fr),kr.warn(`Firestore (${Nr}): ${e}`,...n))}function Fr(t){if("string"==typeof t)return t;try{return JSON.stringify(t)}catch(e){return t}}function Pr(e="Unexpected state"){var t=`FIRESTORE (${Nr}) INTERNAL ASSERTION FAILED: `+e;throw Lr(t),new Error(t)}function Vr(e){e||Pr()}const Br={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class qr extends d{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class Ur{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class zr{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class Gr{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(Ar.UNAUTHENTICATED))}shutdown(){}}class jr{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class Kr{constructor(e){this.t=e,this.currentUser=Ar.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,n){let r=this.i;const i=e=>this.i!==r?(r=this.i,n(e)):Promise.resolve();let s=new Ur;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new Ur,t.enqueueRetryable(()=>i(this.currentUser))};const a=()=>{const e=s;t.enqueueRetryable(async()=>{await e.promise,await i(this.currentUser)})},o=e=>{Mr("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),a()};this.t.onInit(e=>o(e)),setTimeout(()=>{var e;this.auth||((e=this.t.getImmediate({optional:!0}))?o(e):(Mr("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new Ur))},0),a()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then(e=>this.i!==t?(Mr("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(Vr("string"==typeof e.accessToken),new zr(e.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){var e=this.auth&&this.auth.getUid();return Vr(null===e||"string"==typeof e),new Ar(e)}}class $r{constructor(e,t,n){this.l=e,this.h=t,this.P=n,this.type="FirstParty",this.user=Ar.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);var e=this.T();return e&&this.I.set("Authorization",e),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}}class Qr{constructor(e,t,n){this.l=e,this.h=t,this.P=n}getToken(){return Promise.resolve(new $r(this.l,this.h,this.P))}start(e,t){e.enqueueRetryable(()=>t(Ar.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class Wr{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&0<e.length&&this.headers.set("x-firebase-appcheck",this.value)}}class Hr{constructor(e){this.A=e,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(t,n){const r=e=>{null!=e.error&&Mr("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);var t=e.token!==this.R;return this.R=e.token,Mr("FirebaseAppCheckTokenProvider",`Received ${t?"new":"existing"} token.`),t?n(e.token):Promise.resolve()};this.o=e=>{t.enqueueRetryable(()=>r(e))};const i=e=>{Mr("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)};this.A.onInit(e=>i(e)),setTimeout(()=>{var e;this.appCheck||((e=this.A.getImmediate({optional:!0}))?i(e):Mr("FirebaseAppCheckTokenProvider","AppCheck not yet detected"))},0)}getToken(){var e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(e=>e?(Vr("string"==typeof e.token),this.R=e.token,new Wr(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class Yr{static newId(){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=Math.floor(256/t.length)*t.length;let r="";for(;r.length<20;){var i=function(t){const n="undefined"!=typeof self&&(self.crypto||self.msCrypto),r=new Uint8Array(t);if(n&&"function"==typeof n.getRandomValues)n.getRandomValues(r);else for(let e=0;e<t;e++)r[e]=Math.floor(256*Math.random());return r}(40);for(let e=0;e<i.length;++e)r.length<20&&i[e]<n&&(r+=t.charAt(i[e]%t.length))}return r}}function Xr(e,t){return e<t?-1:t<e?1:0}function Jr(e,n,r){return e.length===n.length&&e.every((e,t)=>r(e,n[t]))}function Zr(e){return e+"\0"}class ei{constructor(e,t){if(this.seconds=e,(this.nanoseconds=t)<0)throw new qr(Br.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(1e9<=t)throw new qr(Br.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new qr(Br.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(253402300800<=e)throw new qr(Br.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return ei.fromMillis(Date.now())}static fromDate(e){return ei.fromMillis(e.getTime())}static fromMillis(e){var t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new ei(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?Xr(this.nanoseconds,e.nanoseconds):Xr(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){var e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class ti{constructor(e){this.timestamp=e}static fromTimestamp(e){return new ti(e)}static min(){return new ti(new ei(0,0))}static max(){return new ti(new ei(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class ni{constructor(e,t,n){void 0===t?t=0:t>e.length&&Pr(),void 0===n?n=e.length-t:n>e.length-t&&Pr(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===ni.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof ni?e.forEach(e=>{t.push(e)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return this.construct(this.segments,this.offset+(e=void 0===e?1:e),this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let r=0;r<n;r++){const n=e.get(r),i=t.get(r);if(n<i)return-1;if(n>i)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class ri extends ni{construct(e,t,n){return new ri(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...e){const t=[];for(const n of e){if(0<=n.indexOf("//"))throw new qr(Br.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter(e=>0<e.length))}return new ri(t)}static emptyPath(){return new ri([])}}const ii=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class si extends ni{construct(e,t,n){return new si(e,t,n)}static isValidIdentifier(e){return ii.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),e=!si.isValidIdentifier(e)?"`"+e+"`":e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new si(["__name__"])}static fromServerFormat(e){const t=[];let n="",r=0;var i=()=>{if(0===n.length)throw new qr(Br.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let s=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new qr(Br.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new qr(Br.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?s=!s:"."!==t||s?n+=t:i(),r++}if(i(),s)throw new qr(Br.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new si(t)}static emptyPath(){return new si([])}}class ai{constructor(e){this.path=e}static fromPath(e){return new ai(ri.fromString(e))}static fromName(e){return new ai(ri.fromString(e).popFirst(5))}static empty(){return new ai(ri.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return 2<=this.path.length&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===ri.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return ri.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new ai(new ri(e.slice()))}}class oi{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function ui(e){return e.fields.find(e=>2===e.kind)}function ci(e){return e.fields.filter(e=>2!==e.kind)}oi.UNKNOWN_ID=-1;class hi{constructor(e,t){this.fieldPath=e,this.kind=t}}class li{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new li(0,gi.min())}}function di(e,t){var n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1,r=ti.fromTimestamp(1e9===r?new ei(n+1,0):new ei(n,r));return new gi(r,ai.empty(),t)}function fi(e){return new gi(e.readTime,e.key,-1)}class gi{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new gi(ti.min(),ai.empty(),-1)}static max(){return new gi(ti.max(),ai.empty(),-1)}}function mi(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:(n=ai.comparator(e.documentKey,t.documentKey),0!==n?n:Xr(e.largestBatchId,t.largestBatchId))}const pi="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class yi{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}async function vi(e){if(e.code!==Br.FAILED_PRECONDITION||e.message!==pi)throw e;Mr("LocalStore","Unexpectedly lost primary lease")}class wi{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(e){return this.next(void 0,e)}next(r,i){return this.callbackAttached&&Pr(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(i,this.error):this.wrapSuccess(r,this.result):new wi((t,n)=>{this.nextCallback=e=>{this.wrapSuccess(r,e).next(t,n)},this.catchCallback=e=>{this.wrapFailure(i,e).next(t,n)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{var t=e();return t instanceof wi?t:wi.resolve(t)}catch(e){return wi.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):wi.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):wi.reject(t)}static resolve(n){return new wi((e,t)=>{e(n)})}static reject(n){return new wi((e,t)=>{t(n)})}static waitFor(e){return new wi((t,n)=>{let r=0,i=0,s=!1;e.forEach(e=>{++r,e.next(()=>{++i,s&&i===r&&t()},e=>n(e))}),s=!0,i===r&&t()})}static or(e){let t=wi.resolve(!1);for(const n of e)t=t.next(e=>e?wi.resolve(e):n());return t}static forEach(e,n){const r=[];return e.forEach((e,t)=>{r.push(n.call(this,e,t))}),this.waitFor(r)}static mapArray(o,u){return new wi((t,n)=>{const r=o.length,i=new Array(r);let s=0;for(let e=0;e<r;e++){const a=e;u(o[a]).next(e=>{i[a]=e,++s,s===r&&t(i)},e=>n(e))}})}static doWhile(r,i){return new wi((e,t)=>{const n=()=>{!0===r()?i().next(()=>{n()},t):e()};n()})}}class _i{constructor(n,e){this.action=n,this.transaction=e,this.aborted=!1,this.V=new Ur,this.transaction.oncomplete=()=>{this.V.resolve()},this.transaction.onabort=()=>{e.error?this.V.reject(new Ei(n,e.error)):this.V.resolve()},this.transaction.onerror=e=>{var t=Ci(e.target.error);this.V.reject(new Ei(n,t))}}static open(e,t,n,r){try{return new _i(t,e.transaction(r,n))}catch(e){throw new Ei(t,e)}}get m(){return this.V.promise}abort(e){e&&this.V.reject(e),this.aborted||(Mr("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}g(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){var t=this.transaction.objectStore(e);return new Si(t)}}class bi{constructor(e,t,n){this.name=e,this.version=t,this.p=n,12.2===bi.S(u())&&Lr("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return Mr("SimpleDb","Removing database:",e),xi(window.indexedDB.deleteDatabase(e)).toPromise()}static D(){if(!function(){try{return"object"==typeof indexedDB}catch(e){return}}())return!1;if(bi.C())return!0;const e=u(),t=bi.S(e),n=0<t&&t<10,r=bi.v(e),i=0<r&&r<4.5;return!(0<e.indexOf("MSIE ")||0<e.indexOf("Trident/")||0<e.indexOf("Edge/")||n||i)}static C(){var e;return"undefined"!=typeof process&&"YES"===(null===(e=process.env)||void 0===e?void 0:e.F)}static M(e,t){return e.store(t)}static S(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static v(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async O(s){return this.db||(Mr("SimpleDb","Opening database:",this.name),this.db=await new Promise((n,r)=>{const i=indexedDB.open(this.name,this.version);i.onsuccess=e=>{var t=e.target.result;n(t)},i.onblocked=()=>{r(new Ei(s,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},i.onerror=e=>{var t=e.target.error;"VersionError"===t.name?r(new qr(Br.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===t.name?r(new qr(Br.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+t)):r(new Ei(s,t))},i.onupgradeneeded=e=>{Mr("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);var t=e.target.result;this.p.N(t,i.transaction,e.oldVersion,this.version).next(()=>{Mr("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.B&&(this.db.onversionchange=e=>this.B(e)),this.db}L(t){this.B=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(e,t,n,r){var i="readonly"===t;let s=0;for(;;){++s;try{this.db=await this.O(e);const t=_i.open(this.db,e,i?"readonly":"readwrite",n),s=r(t).next(e=>(t.g(),e)).catch(e=>(t.abort(e),wi.reject(e))).toPromise();return s.catch(()=>{}),await t.m,s}catch(e){const t=e,n="FirebaseError"!==t.name&&s<3;if(Mr("SimpleDb","Transaction failed with error:",t.message,"Retrying:",n),this.close(),!n)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class Ii{constructor(e){this.k=e,this.q=!1,this.K=null}get isDone(){return this.q}get $(){return this.K}set cursor(e){this.k=e}done(){this.q=!0}U(e){this.K=e}delete(){return xi(this.k.delete())}}class Ei extends qr{constructor(e,t){super(Br.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function Ti(e){return"IndexedDbTransactionError"===e.name}class Si{constructor(e){this.store=e}put(e,t){let n;return n=void 0!==t?(Mr("SimpleDb","PUT",this.store.name,e,t),this.store.put(t,e)):(Mr("SimpleDb","PUT",this.store.name,"<auto-key>",e),this.store.put(e)),xi(n)}add(e){return Mr("SimpleDb","ADD",this.store.name,e,e),xi(this.store.add(e))}get(t){return xi(this.store.get(t)).next(e=>(Mr("SimpleDb","GET",this.store.name,t,e=void 0===e?null:e),e))}delete(e){return Mr("SimpleDb","DELETE",this.store.name,e),xi(this.store.delete(e))}count(){return Mr("SimpleDb","COUNT",this.store.name),xi(this.store.count())}W(e,n){var t=this.options(e,n);if(t.index||"function"!=typeof this.store.getAll){const e=this.cursor(t),n=[];return this.G(e,(e,t)=>{n.push(t)}).next(()=>n)}{const e=this.store.getAll(t.range);return new wi((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}})}}j(e,t){const r=this.store.getAll(e,null===t?void 0:t);return new wi((t,n)=>{r.onerror=e=>{n(e.target.error)},r.onsuccess=e=>{t(e.target.result)}})}H(e,t){Mr("SimpleDb","DELETE ALL",this.store.name);const n=this.options(e,t);n.J=!1;var r=this.cursor(n);return this.G(r,(e,t,n)=>n.delete())}Y(e,t){let n;t?n=e:(n={},t=e);var r=this.cursor(n);return this.G(r,t)}Z(i){const e=this.cursor({});return new wi((n,r)=>{e.onerror=e=>{var t=Ci(e.target.error);r(t)},e.onsuccess=e=>{const t=e.target.result;t?i(t.primaryKey,t.value).next(e=>{e?t.continue():n()}):n()}})}G(e,s){const a=[];return new wi((i,t)=>{e.onerror=e=>{t(e.target.error)},e.onsuccess=e=>{const t=e.target.result;if(t){const n=new Ii(t),r=s(t.primaryKey,t.value,n);if(r instanceof wi){const e=r.catch(e=>(n.done(),wi.reject(e)));a.push(e)}n.isDone?i():null===n.$?t.continue():t.continue(n.$)}else i()}}).next(()=>wi.waitFor(a))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.J?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function xi(e){return new wi((n,r)=>{e.onsuccess=e=>{var t=e.target.result;n(t)},e.onerror=e=>{var t=Ci(e.target.error);r(t)}})}let Di=!1;function Ci(e){const t=bi.S(u());if(12.2<=t&&t<13){const t="An internal error was encountered in the Indexed Database server";if(0<=e.message.indexOf(t)){const e=new qr("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return Di||(Di=!0,setTimeout(()=>{throw e},0)),e}}return e}class Ai{constructor(e,t){this.asyncQueue=e,this.X=t,this.task=null}start(){this.ee(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}ee(e){Mr("IndexBackiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,async()=>{this.task=null;try{Mr("IndexBackiller",`Documents written: ${await this.X.te()}`)}catch(e){Ti(e)?Mr("IndexBackiller","Ignoring IndexedDB error during index backfill: ",e):await vi(e)}await this.ee(6e4)})}}class Ni{constructor(e,t){this.localStore=e,this.persistence=t}async te(t=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",e=>this.ne(e,t))}ne(e,t){const n=new Set;let r=t,i=!0;return wi.doWhile(()=>!0===i&&0<r,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(t=>null===t||n.has(t)?void(i=!1):(Mr("IndexBackiller",`Processing collection: ${t}`),this.re(e,t,r).next(e=>{r-=e,n.add(t)})))).next(()=>t-r)}re(r,i,e){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(r,i).next(n=>this.localStore.localDocuments.getNextDocuments(r,i,n,e).next(e=>{const t=e.changes;return this.localStore.indexManager.updateIndexEntries(r,t).next(()=>this.ie(n,e)).next(e=>(Mr("IndexBackiller",`Updating offset: ${e}`),this.localStore.indexManager.updateCollectionGroup(r,i,e))).next(()=>t.size)}))}ie(e,t){let r=e;return t.changes.forEach((e,t)=>{var n=fi(t);0<mi(n,r)&&(r=n)}),new gi(r.readTime,r.documentKey,Math.max(t.batchId,e.largestBatchId))}}class ki{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.se(e),this.oe=e=>t.writeSequenceNumber(e))}se(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){var e=++this.previousValue;return this.oe&&this.oe(e),e}}function Ri(e){return null==e}function Mi(e){return 0===e&&1/e==-1/0}function Li(e){return"number"==typeof e&&Number.isInteger(e)&&!Mi(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}function Oi(e){let t="";for(let n=0;n<e.length;n++)0<t.length&&(t=Fi(t)),t=function(e,t){let n=t;const r=e.length;for(let i=0;i<r;i++){const r=e.charAt(i);switch(r){case"\0":n+="";break;case"":n+="";break;default:n+=r}}return n}(e.get(n),t);return Fi(t)}function Fi(e){return e+""}function Pi(t){const n=t.length;if(Vr(2<=n),2===n)return Vr(""===t.charAt(0)&&""===t.charAt(1)),ri.emptyPath();const __PRIVATE_lastReasonableEscapeIndex=n-2,r=[];let i="";for(let a=0;a<n;){const n=t.indexOf("",a);switch((n<0||n>__PRIVATE_lastReasonableEscapeIndex)&&Pr(),t.charAt(n+1)){case"":var s=t.substring(a,n);let e;0===i.length?e=s:(i+=s,e=i,i=""),r.push(e);break;case"":i+=t.substring(a,n),i+="\0";break;case"":i+=t.substring(a,n+1);break;default:Pr()}a=n+2}return new ri(r)}ki._e=-1;const Vi=["userId","batchId"];function Bi(e,t){return[e,Oi(t)]}function qi(e,t,n){return[e,Oi(t),n]}const Ui={},zi=["prefixPath","collectionGroup","readTime","documentId"],Gi=["prefixPath","collectionGroup","documentId"],ji=["collectionGroup","readTime","prefixPath","documentId"],Ki=["canonicalId","targetId"],$i=["targetId","path"],Qi=["path","targetId"],Wi=["collectionId","parent"],Hi=["indexId","uid"],Yi=["uid","sequenceNumber"],Xi=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],Ji=["indexId","uid","orderedDocumentKey"],Zi=["userId","collectionPath","documentId"],es=["userId","collectionPath","largestBatchId"],ts=["userId","collectionGroup","largestBatchId"],ns=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],rs=[...ns,"documentOverlays"],is=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],ss=is,as=[...ss,"indexConfiguration","indexState","indexEntries"];class os extends yi{constructor(e,t){super(),this.ae=e,this.currentSequenceNumber=t}}function us(e,t){var n=e;return bi.M(n.ae,t)}function cs(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function hs(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function ls(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class ds{constructor(e,t){this.comparator=e,this.root=t||gs.EMPTY}insert(e,t){return new ds(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,gs.BLACK,null,null))}remove(e){return new ds(this.comparator,this.root.remove(e,this.comparator).copy(null,null,gs.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){var n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:0<n&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){var r=this.comparator(e,n.key);if(0===r)return t+n.left.size;n=r<0?n.left:(t+=n.left.size+1,n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(n){this.inorderTraversal((e,t)=>(n(e,t),!1))}toString(){const n=[];return this.inorderTraversal((e,t)=>(n.push(`${e}:${t}`),!1)),`{${n.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new fs(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new fs(this.root,e,this.comparator,!1)}getReverseIterator(){return new fs(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new fs(this.root,e,this.comparator,!0)}}class fs{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let i=1;for(;!e.isEmpty();)if(i=t?n(e.key,t):1,t&&r&&(i*=-1),i<0)e=this.isReverse?e.left:e.right;else{if(0===i){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();var t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return 0<this.nodeStack.length}peek(){if(0===this.nodeStack.length)return null;var e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class gs{constructor(e,t,n,r,i){this.key=e,this.value=t,this.color=null!=n?n:gs.RED,this.left=null!=r?r:gs.EMPTY,this.right=null!=i?i:gs.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,i){return new gs(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=i?i:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;var i=n(e,r.key);return r=i<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===i?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return gs.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return gs.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){var e=this.copy(null,null,gs.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){var e=this.copy(null,null,gs.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){var e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){var e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw Pr();if(this.right.isRed())throw Pr();var e=this.left.check();if(e!==this.right.check())throw Pr();return e+(this.isRed()?0:1)}}gs.EMPTY=null,gs.RED=!0,gs.BLACK=!1,gs.EMPTY=new class{constructor(){this.size=0}get key(){throw Pr()}get value(){throw Pr()}get color(){throw Pr()}get left(){throw Pr()}get right(){throw Pr()}copy(e,t,n,r,i){return this}insert(e,t,n){return new gs(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class ms{constructor(e){this.comparator=e,this.data=new ds(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(n){this.data.inorderTraversal((e,t)=>(n(e),!1))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){var r=n.getNext();if(0<=this.comparator(r.key,e[1]))return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new ps(this.data.getIterator())}getIteratorFrom(e){return new ps(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(e=>{t=t.add(e)}),t}isEqual(e){if(!(e instanceof ms))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const t=[];return this.forEach(e=>{t.push(e)}),t}toString(){const t=[];return this.forEach(e=>t.push(e)),"SortedSet("+t.toString()+")"}copy(e){const t=new ms(this.comparator);return t.data=e,t}}class ps{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function ys(e){return e.hasNext()?e.getNext():void 0}class vs{constructor(e){(this.fields=e).sort(si.comparator)}static empty(){return new vs([])}unionWith(e){let t=new ms(si.comparator);for(const e of this.fields)t=t.add(e);for(const n of e)t=t.add(n);return new vs(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return Jr(this.fields,e.fields,(e,t)=>e.isEqual(t))}}class ws extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class _s{constructor(e){this.binaryString=e}static fromBase64String(e){var t=function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new ws("Invalid base64 string: "+e):e}}(e);return new _s(t)}static fromUint8Array(e){var t=function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new _s(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){return function(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return Xr(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}_s.EMPTY_BYTE_STRING=new _s("");const bs=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Is(t){if(Vr(!!t),"string"!=typeof t)return{seconds:Es(t.seconds),nanos:Es(t.nanos)};{let e=0;var n=bs.exec(t);Vr(!!n),n[1]&&(n=((n=n[1])+"000000000").substr(0,9),e=Number(n));const r=new Date(t);return{seconds:Math.floor(r.getTime()/1e3),nanos:e}}}function Es(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function Ts(e){return"string"==typeof e?_s.fromBase64String(e):_s.fromUint8Array(e)}function Ss(e){var t;return"server_timestamp"===(null===(t=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===t?void 0:t.stringValue)}function xs(e){var t=e.mapValue.fields.__previous_value__;return Ss(t)?xs(t):t}function Ds(e){var t=Is(e.mapValue.fields.__local_write_time__.timestampValue);return new ei(t.seconds,t.nanos)}class Cs{constructor(e,t,n,r,i,s,a,o,u){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=i,this.forceLongPolling=s,this.autoDetectLongPolling=a,this.longPollingOptions=o,this.useFetchStreams=u}}class As{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new As("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof As&&e.projectId===this.projectId&&e.database===this.database}}const Ns={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},ks={nullValue:"NULL_VALUE"};function Rs(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?Ss(e)?4:Ks(e)?9007199254740991:10:Pr()}function Ms(e,t){if(e===t)return!0;var n,r,i=Rs(e);if(i!==Rs(t))return!1;switch(i){case 0:case 9007199254740991:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return Ds(e).isEqual(Ds(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;var n=Is(e.timestampValue),r=Is(t.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return r=t,Ts(e.bytesValue).isEqual(Ts(r.bytesValue));case 7:return e.referenceValue===t.referenceValue;case 8:return n=t,Es((r=e).geoPointValue.latitude)===Es(n.geoPointValue.latitude)&&Es(r.geoPointValue.longitude)===Es(n.geoPointValue.longitude);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return Es(e.integerValue)===Es(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){var n=Es(e.doubleValue),r=Es(t.doubleValue);return n===r?Mi(n)===Mi(r):isNaN(n)&&isNaN(r)}return!1}(e,t);case 9:return Jr(e.arrayValue.values||[],t.arrayValue.values||[],Ms);case 10:return function(e,t){const n=e.mapValue.fields||{},r=t.mapValue.fields||{};if(cs(n)!==cs(r))return!1;for(const e in n)if(n.hasOwnProperty(e)&&(void 0===r[e]||!Ms(n[e],r[e])))return!1;return!0}(e,t);default:return Pr()}}function Ls(e,t){return void 0!==(e.values||[]).find(e=>Ms(e,t))}function Os(e,t){if(e===t)return 0;var n,r,i,s,a=Rs(e),o=Rs(t);if(a!==o)return Xr(a,o);switch(a){case 0:case 9007199254740991:return 0;case 1:return Xr(e.booleanValue,t.booleanValue);case 2:return r=t,i=Es((n=e).integerValue||n.doubleValue),s=Es(r.integerValue||r.doubleValue),i<s?-1:s<i?1:i===s?0:isNaN(i)?isNaN(s)?0:-1:1;case 3:return Fs(e.timestampValue,t.timestampValue);case 4:return Fs(Ds(e),Ds(t));case 5:return Xr(e.stringValue,t.stringValue);case 6:return function(e,t){const n=Ts(e),r=Ts(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){var n=e.split("/"),r=t.split("/");for(let i=0;i<n.length&&i<r.length;i++){const t=Xr(n[i],r[i]);if(0!==t)return t}return Xr(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return n=e.geoPointValue,r=t.geoPointValue,0!==(s=Xr(Es(n.latitude),Es(r.latitude)))?s:Xr(Es(n.longitude),Es(r.longitude));case 9:return function(e,t){var n=e.values||[],r=t.values||[];for(let i=0;i<n.length&&i<r.length;++i){const t=Os(n[i],r[i]);if(t)return t}return Xr(n.length,r.length)}(e.arrayValue,t.arrayValue);case 10:return function(e,t){if(e===Ns.mapValue&&t===Ns.mapValue)return 0;if(e===Ns.mapValue)return 1;if(t===Ns.mapValue)return-1;const n=e.fields||{},r=Object.keys(n),i=t.fields||{},s=Object.keys(i);r.sort(),s.sort();for(let o=0;o<r.length&&o<s.length;++o){const t=Xr(r[o],s[o]);if(0!==t)return t;var a=Os(n[r[o]],i[s[o]]);if(0!==a)return a}return Xr(r.length,s.length)}(e.mapValue,t.mapValue);default:throw Pr()}}function Fs(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return Xr(e,t);var n=Is(e),r=Is(t),i=Xr(n.seconds,r.seconds);return 0!==i?i:Xr(n.nanos,r.nanos)}function Ps(e){return function s(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){const t=Is(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?function(e){return Ts(e).toBase64()}(e.bytesValue):"referenceValue"in e?function(e){return ai.fromName(e).toString()}(e.referenceValue):"geoPointValue"in e?function(e){return`geo(${e.latitude},${e.longitude})`}(e.geoPointValue):"arrayValue"in e?function(e){let t="[",n=!0;for(const r of e.values||[])n?n=!1:t+=",",t+=s(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){const t=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const i of t)r?r=!1:n+=",",n+=`${i}:${s(e.fields[i])}`;return n+"}"}(e.mapValue):Pr()}(e)}function Vs(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function Bs(e){return!!e&&"integerValue"in e}function qs(e){return!!e&&"arrayValue"in e}function Us(e){return e&&"nullValue"in e}function zs(e){return e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function Gs(e){return e&&"mapValue"in e}function js(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const n={mapValue:{fields:{}}};return hs(t.mapValue.fields,(e,t)=>n.mapValue.fields[e]=js(t)),n}if(t.arrayValue){const r={arrayValue:{values:[]}};for(let e=0;e<(t.arrayValue.values||[]).length;++e)r.arrayValue.values[e]=js(t.arrayValue.values[e]);return r}return Object.assign({},t)}function Ks(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}function $s(e,t){var n=Os(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function Qs(e,t){var n=Os(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class Ws{constructor(e){this.value=e}static empty(){return new Ws({mapValue:{}})}field(n){if(n.isEmpty())return this.value;{let e=this.value;for(let t=0;t<n.length-1;++t)if(e=(e.mapValue.fields||{})[n.get(t)],!Gs(e))return null;return e=(e.mapValue.fields||{})[n.lastSegment()],e||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=js(t)}setAll(e){let n=si.emptyPath(),r={},i=[];e.forEach((e,t)=>{if(!n.isImmediateParentOf(t)){const e=this.getFieldsMap(n);this.applyChanges(e,r,i),r={},i=[],n=t.popLast()}e?r[t.lastSegment()]=js(e):i.push(t.lastSegment())});var t=this.getFieldsMap(n);this.applyChanges(t,r,i)}delete(e){const t=this.field(e.popLast());Gs(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return Ms(this.value,e.value)}getFieldsMap(t){let n=this.value;n.mapValue.fields||(n.mapValue={fields:{}});for(let r=0;r<t.length;++r){let e=n.mapValue.fields[t.get(r)];Gs(e)&&e.mapValue.fields||(e={mapValue:{fields:{}}},n.mapValue.fields[t.get(r)]=e),n=e}return n.mapValue.fields}applyChanges(n,e,t){hs(e,(e,t)=>n[e]=t);for(const e of t)delete n[e]}clone(){return new Ws(js(this.value))}}class Hs{constructor(e,t,n,r,i,s,a){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=i,this.data=s,this.documentState=a}static newInvalidDocument(e){return new Hs(e,0,ti.min(),ti.min(),ti.min(),Ws.empty(),0)}static newFoundDocument(e,t,n,r){return new Hs(e,1,t,ti.min(),n,r,0)}static newNoDocument(e,t){return new Hs(e,2,t,ti.min(),ti.min(),Ws.empty(),0)}static newUnknownDocument(e,t){return new Hs(e,3,t,ti.min(),ti.min(),Ws.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(ti.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=Ws.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=Ws.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=ti.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof Hs&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new Hs(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Ys{constructor(e,t){this.position=e,this.inclusive=t}}function Xs(e,t,n){let r=0;for(let i=0;i<e.position.length;i++){const s=t[i],a=e.position[i];if(r=s.field.isKeyField()?ai.comparator(ai.fromName(a.referenceValue),n.key):Os(a,n.data.field(s.field)),"desc"===s.dir&&(r*=-1),0!==r)break}return r}function Js(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!Ms(e.position[n],t.position[n]))return!1;return!0}class Zs{constructor(e,t="asc"){this.field=e,this.dir=t}}class ea{}class ta extends ea{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new ca(e,t,n):"array-contains"===t?new fa(e,n):"in"===t?new ga(e,n):"not-in"===t?new ma(e,n):"array-contains-any"===t?new pa(e,n):new ta(e,t,n)}static createKeyFieldInFilter(e,t,n){return new("in"===t?ha:la)(e,n)}matches(e){var t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison(Os(t,this.value)):null!==t&&Rs(this.value)===Rs(t)&&this.matchesComparison(Os(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return 0<e;case">=":return 0<=e;default:return Pr()}}isInequality(){return 0<=["<","<=",">",">=","!=","not-in"].indexOf(this.op)}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class na extends ea{constructor(e,t){super(),this.filters=e,this.op=t,this.ue=null}static create(e,t){return new na(e,t)}matches(t){return ra(this)?void 0===this.filters.find(e=>!e.matches(t)):void 0!==this.filters.find(e=>e.matches(t))}getFlattenedFilters(){return null!==this.ue||(this.ue=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.ue}getFilters(){return Object.assign([],this.filters)}}function ra(e){return"and"===e.op}function ia(e){return"or"===e.op}function sa(e){return aa(e)&&ra(e)}function aa(e){for(const t of e.filters)if(t instanceof na)return!1;return!0}function oa(e,t){var n=e.filters.concat(t);return na.create(n,e.op)}function ua(e){return e instanceof ta?`${(t=e).field.canonicalString()} ${t.op} ${Ps(t.value)}`:e instanceof na?(e=e).op.toString()+" {"+e.getFilters().map(ua).join(" ,")+"}":"Filter";var t}class ca extends ta{constructor(e,t,n){super(e,t,n),this.key=ai.fromName(n.referenceValue)}matches(e){var t=ai.comparator(e.key,this.key);return this.matchesComparison(t)}}class ha extends ta{constructor(e,t){super(e,"in",t),this.keys=da(0,t)}matches(t){return this.keys.some(e=>e.isEqual(t.key))}}class la extends ta{constructor(e,t){super(e,"not-in",t),this.keys=da(0,t)}matches(t){return!this.keys.some(e=>e.isEqual(t.key))}}function da(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map(e=>ai.fromName(e.referenceValue))}class fa extends ta{constructor(e,t){super(e,"array-contains",t)}matches(e){var t=e.data.field(this.field);return qs(t)&&Ls(t.arrayValue,this.value)}}class ga extends ta{constructor(e,t){super(e,"in",t)}matches(e){var t=e.data.field(this.field);return null!==t&&Ls(this.value.arrayValue,t)}}class ma extends ta{constructor(e,t){super(e,"not-in",t)}matches(e){if(Ls(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;var t=e.data.field(this.field);return null!==t&&!Ls(this.value.arrayValue,t)}}class pa extends ta{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!qs(t)||!t.arrayValue.values)&&t.arrayValue.values.some(e=>Ls(this.value.arrayValue,e))}}class ya{constructor(e,t=null,n=[],r=[],i=null,s=null,a=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=i,this.startAt=s,this.endAt=a,this.ce=null}}function va(e,t=null,n=[],r=[],i=null,s=null,a=null){return new ya(e,t,n,r,i,s,a)}function wa(e){const t=e;if(null===t.ce){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map(e=>function t(e){if(e instanceof ta)return e.field.canonicalString()+e.op.toString()+Ps(e.value);if(sa(e))return e.filters.map(e=>t(e)).join(",");var n=e.filters.map(e=>t(e)).join(",");return`${e.op}(${n})`}(e)).join(","),e+="|ob:",e+=t.orderBy.map(e=>function(e){return e.field.canonicalString()+e.dir}(e)).join(","),Ri(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map(e=>Ps(e)).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map(e=>Ps(e)).join(",")),t.ce=e}return t.ce}function _a(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let i=0;i<e.orderBy.length;i++)if(n=e.orderBy[i],r=t.orderBy[i],n.dir!==r.dir||!n.field.isEqual(r.field))return!1;var n,r;if(e.filters.length!==t.filters.length)return!1;for(let s=0;s<e.filters.length;s++)if(!function r(e,t){return e instanceof ta?(n=e,(s=t)instanceof ta&&n.op===s.op&&n.field.isEqual(s.field)&&Ms(n.value,s.value)):e instanceof na?(i=t)instanceof na&&e.op===i.op&&e.filters.length===i.filters.length&&e.filters.reduce((e,t,n)=>e&&r(t,i.filters[n]),!0):void Pr();var i,n,s}(e.filters[s],t.filters[s]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!Js(e.startAt,t.startAt)&&Js(e.endAt,t.endAt)}function ba(e){return ai.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function Ia(e,t){return e.filters.filter(e=>e instanceof ta&&e.field.isEqual(t))}function Ea(t,n,r){let i=ks,s=!0;for(const r of Ia(t,n)){let e=ks,t=!0;switch(r.op){case"<":case"<=":e="nullValue"in(a=r.value)?ks:"booleanValue"in a?{booleanValue:!1}:"integerValue"in a||"doubleValue"in a?{doubleValue:NaN}:"timestampValue"in a?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in a?{stringValue:""}:"bytesValue"in a?{bytesValue:""}:"referenceValue"in a?Vs(As.empty(),ai.empty()):"geoPointValue"in a?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in a?{arrayValue:{}}:"mapValue"in a?{mapValue:{}}:Pr();break;case"==":case"in":case">=":e=r.value;break;case">":e=r.value,t=!1;break;case"!=":case"not-in":e=ks}$s({value:i,inclusive:s},{value:e,inclusive:t})<0&&(i=e,s=t)}var a;if(null!==r)for(let e=0;e<t.orderBy.length;++e)if(t.orderBy[e].field.isEqual(n)){const t=r.position[e];$s({value:i,inclusive:s},{value:t,inclusive:r.inclusive})<0&&(i=t,s=r.inclusive);break}return{value:i,inclusive:s}}function Ta(t,n,r){let i=Ns,s=!0;for(const r of Ia(t,n)){let e=Ns,t=!0;switch(r.op){case">=":case">":e="nullValue"in(a=r.value)?{booleanValue:!1}:"booleanValue"in a?{doubleValue:NaN}:"integerValue"in a||"doubleValue"in a?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in a?{stringValue:""}:"stringValue"in a?{bytesValue:""}:"bytesValue"in a?Vs(As.empty(),ai.empty()):"referenceValue"in a?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in a?{arrayValue:{}}:"arrayValue"in a?{mapValue:{}}:"mapValue"in a?Ns:Pr(),t=!1;break;case"==":case"in":case"<=":e=r.value;break;case"<":e=r.value,t=!1;break;case"!=":case"not-in":e=Ns}0<Qs({value:i,inclusive:s},{value:e,inclusive:t})&&(i=e,s=t)}var a;if(null!==r)for(let e=0;e<t.orderBy.length;++e)if(t.orderBy[e].field.isEqual(n)){const t=r.position[e];0<Qs({value:i,inclusive:s},{value:t,inclusive:r.inclusive})&&(i=t,s=r.inclusive);break}return{value:i,inclusive:s}}class Sa{constructor(e,t=null,n=[],r=[],i=null,s="F",a=null,o=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.limitType=s,this.startAt=a,this.endAt=o,this.le=null,this.he=null,this.Pe=null,this.startAt,this.endAt}}function xa(e,t,n,r,i,s,a,o){return new Sa(e,t,n,r,i,s,a,o)}function Da(e){return new Sa(e)}function Ca(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function Aa(e){return null!==e.collectionGroup}function Na(t){const n=t;if(null===n.le){n.le=[];const t=new Set;for(const i of n.explicitOrderBy)n.le.push(i),t.add(i.field.canonicalString());const r=0<n.explicitOrderBy.length?n.explicitOrderBy[n.explicitOrderBy.length-1].dir:"asc",e=function(e){let t=new ms(si.comparator);return e.filters.forEach(e=>{e.getFlattenedFilters().forEach(e=>{e.isInequality()&&(t=t.add(e.field))})}),t}(n);e.forEach(e=>{t.has(e.canonicalString())||e.isKeyField()||n.le.push(new Zs(e,r))}),t.has(si.keyField().canonicalString())||n.le.push(new Zs(si.keyField(),r))}return n.le}function ka(e){const t=e;return t.he||(t.he=function(e,t){if("F"===e.limitType)return va(e.path,e.collectionGroup,t,e.filters,e.limit,e.startAt,e.endAt);{t=t.map(e=>{var t="desc"===e.dir?"asc":"desc";return new Zs(e.field,t)});var n=e.endAt?new Ys(e.endAt.position,e.endAt.inclusive):null,r=e.startAt?new Ys(e.startAt.position,e.startAt.inclusive):null;return va(e.path,e.collectionGroup,t,e.filters,e.limit,n,r)}}(t,Na(e))),t.he}function Ra(e,t){var n=e.filters.concat([t]);return new Sa(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}function Ma(e,t,n){return new Sa(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function La(e,t){return _a(ka(e),ka(t))&&e.limitType===t.limitType}function Oa(e){return`${wa(ka(e))}|lt:${e.limitType}`}function Fa(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),0<e.filters.length&&(t+=`, filters: [${e.filters.map(e=>ua(e)).join(", ")}]`),Ri(e.limit)||(t+=", limit: "+e.limit),0<e.orderBy.length&&(t+=`, orderBy: [${e.orderBy.map(e=>function(e){return`${e.field.canonicalString()} (${e.dir})`}(e)).join(", ")}]`),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(e=>Ps(e)).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(e=>Ps(e)).join(",")),`Target(${t})`}(ka(e))}; limitType=${e.limitType})`}function Pa(e,t){return t.isFoundDocument()&&(i=e,a=(s=t).key.path,null!==i.collectionGroup?s.key.hasCollectionId(i.collectionGroup)&&i.path.isPrefixOf(a):ai.isDocumentKey(i.path)?i.path.isEqual(a):i.path.isImmediateParentOf(a))&&function(e,t){for(const n of Na(e))if(!n.field.isKeyField()&&null===t.data.field(n.field))return;return 1}(e,t)&&function(e,t){for(const n of e.filters)if(!n.matches(t))return;return 1}(e,t)&&(i=t,(!(t=e).startAt||(n=t.startAt,e=Na(t),r=Xs(n,e,i),n.inclusive?r<=0:r<0))&&(!t.endAt||(n=t.endAt,t=Na(t),r=Xs(n,t,i),n.inclusive?0<=r:0<r)));var n,r,i,s,a}function Va(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function Ba(i){return(e,t)=>{let n=!1;for(const r of Na(i)){const i=function(e,t,n){var r=e.field.isKeyField()?ai.comparator(t.key,n.key):function(e,t,n){var r=t.data.field(e),i=n.data.field(e);return null!==r&&null!==i?Os(r,i):Pr()}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return-1*r;default:return Pr()}}(r,e,t);if(0!==i)return i;n=n||r.field.isKeyField()}return 0}}class qa{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[t,r]of n)if(this.equalsFn(t,e))return r}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let i=0;i<r.length;i++)if(this.equalsFn(r[i][0],e))return void(r[i]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(r){hs(this.inner,(e,t)=>{for(const[e,n]of t)r(e,n)})}isEmpty(){return ls(this.inner)}size(){return this.innerSize}}const Ua=new ds(ai.comparator);const za=new ds(ai.comparator);function Ga(...e){let t=za;for(const n of e)t=t.insert(n.key,n);return t}function ja(e){let n=za;return e.forEach((e,t)=>n=n.insert(e,t.overlayedDocument)),n}function Ka(){return new qa(e=>e.toString(),(e,t)=>e.isEqual(t))}const $a=new ds(ai.comparator),Qa=new ms(ai.comparator);function Wa(...e){let t=Qa;for(const n of e)t=t.add(n);return t}const Ha=new ms(Xr);function Ya(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Mi(t)?"-0":t}}function Xa(e){return{integerValue:""+e}}function Ja(e,t){return Li(t)?Xa(t):Ya(e,t)}class Za{constructor(){this._=void 0}}function eo(e,t){return e instanceof ao?Bs(e=t)||(e=e)&&"doubleValue"in e?t:{integerValue:0}:null}class to extends Za{}class no extends Za{constructor(e){super(),this.elements=e}}function ro(e,t){const n=uo(t);for(const t of e.elements)n.some(e=>Ms(e,t))||n.push(t);return{arrayValue:{values:n}}}class io extends Za{constructor(e){super(),this.elements=e}}function so(e,t){let n=uo(t);for(const t of e.elements)n=n.filter(e=>!Ms(e,t));return{arrayValue:{values:n}}}class ao extends Za{constructor(e,t){super(),this.serializer=e,this.Ie=t}}function oo(e){return Es(e.integerValue||e.doubleValue)}function uo(e){return qs(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class co{constructor(e,t){this.field=e,this.transform=t}}class ho{constructor(e,t){this.version=e,this.transformResults=t}}class lo{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new lo}static exists(e){return new lo(void 0,e)}static updateTime(e){return new lo(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function fo(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class go{}function mo(e,n){if(!e.hasLocalMutations||n&&0===n.fields.length)return null;if(null===n)return e.isNoDocument()?new To(e.key,lo.none()):new wo(e.key,e.data,lo.none());{const i=e.data,s=Ws.empty();let t=new ms(si.comparator);for(var r of n.fields)if(!t.has(r)){let e=i.field(r);null===e&&1<r.length&&(r=r.popLast(),e=i.field(r)),null===e?s.delete(r):s.set(r,e),t=t.add(r)}return new _o(e.key,s,new vs(t.toArray()),lo.none())}}function po(e,t,n){e instanceof wo?function(e,t,n){const r=e.value.clone(),i=Io(e.fieldTransforms,t,n.transformResults);r.setAll(i),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof _o?function(e,t,n){if(!fo(e.precondition,t))return t.convertToUnknownDocument(n.version);const r=Io(e.fieldTransforms,t,n.transformResults),i=t.data;i.setAll(bo(e)),i.setAll(r),t.convertToFoundDocument(n.version,i).setHasCommittedMutations()}(e,t,n):t.convertToNoDocument(n.version).setHasCommittedMutations()}function yo(e,t,n,r){return e instanceof wo?function(e,t,n,r){if(!fo(e.precondition,t))return n;const i=e.value.clone(),s=Eo(e.fieldTransforms,r,t);return i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null}(e,t,n,r):e instanceof _o?function(e,t,n,r){if(!fo(e.precondition,t))return n;const i=Eo(e.fieldTransforms,r,t),s=t.data;return s.setAll(bo(e)),s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null===n?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map(e=>e.field))}(e,t,n,r):(t=t,n=n,fo(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n)}function vo(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&(n=e.fieldTransforms,r=t.fieldTransforms,!!(void 0===n&&void 0===r||n&&r&&Jr(n,r,(e,t)=>function(e,t){return e.field.isEqual(t.field)&&(e=e.transform,t=t.transform,e instanceof no&&t instanceof no||e instanceof io&&t instanceof io?Jr(e.elements,t.elements,Ms):e instanceof ao&&t instanceof ao?Ms(e.Ie,t.Ie):e instanceof to&&t instanceof to)}(e,t)))&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask)));var n,r}class wo extends go{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class _o extends go{constructor(e,t,n,r,i=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=i,this.type=1}getFieldMask(){return this.fieldMask}}function bo(n){const r=new Map;return n.fieldMask.fields.forEach(e=>{var t;e.isEmpty()||(t=n.data.field(e),r.set(e,t))}),r}function Io(e,t,n){const r=new Map;Vr(e.length===n.length);for(let h=0;h<n.length;h++){var i=e[h],s=i.transform,a=t.data.field(i.field);r.set(i.field,(o=s,u=a,c=n[h],o instanceof no?ro(o,u):o instanceof io?so(o,u):c))}var o,u,c;return r}function Eo(e,t,n){const r=new Map;for(const c of e){const e=c.transform,h=n.data.field(c.field);r.set(c.field,(i=e,s=h,a=t,u=o=void 0,i instanceof to?function(e,t){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return(t=t&&Ss(t)?xs(t):t)&&(n.fields.__previous_value__=t),{mapValue:n}}(a,s):i instanceof no?ro(i,s):i instanceof io?so(i,s):(o=eo(i=i,s),u=oo(o)+oo(i.Ie),Bs(o)&&Bs(i.Ie)?Xa(u):Ya(i.serializer,u))))}var i,s,a,o,u;return r}class To extends go{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class So extends go{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class xo{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){var n=t.mutationResults;for(let r=0;r<this.mutations.length;r++){const i=this.mutations[r];i.key.isEqual(e.key)&&po(i,e,n[r])}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=yo(n,e,t,this.localWriteTime));for(const r of this.mutations)r.key.isEqual(e.key)&&(t=yo(r,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(s,a){const o=Ka();return this.mutations.forEach(e=>{const t=s.get(e.key),n=t.overlayedDocument;let r=this.applyToLocalView(n,t.mutatedFields);r=a.has(e.key)?null:r;var i=mo(n,r);null!==i&&o.set(e.key,i),n.isValidDocument()||n.convertToNoDocument(ti.min())}),o}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),Wa())}isEqual(e){return this.batchId===e.batchId&&Jr(this.mutations,e.mutations,(e,t)=>vo(e,t))&&Jr(this.baseMutations,e.baseMutations,(e,t)=>vo(e,t))}}class Do{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){Vr(e.mutations.length===n.length);let r=$a;var i=e.mutations;for(let s=0;s<i.length;s++)r=r.insert(i[s].key,n[s].version);return new Do(e,t,n,r)}}class Co{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class Ao{constructor(e,t){this.count=e,this.unchangedNames=t}}function No(e){switch(e){default:return Pr();case Br.CANCELLED:case Br.UNKNOWN:case Br.DEADLINE_EXCEEDED:case Br.RESOURCE_EXHAUSTED:case Br.INTERNAL:case Br.UNAVAILABLE:case Br.UNAUTHENTICATED:return!1;case Br.INVALID_ARGUMENT:case Br.NOT_FOUND:case Br.ALREADY_EXISTS:case Br.PERMISSION_DENIED:case Br.FAILED_PRECONDITION:case Br.ABORTED:case Br.OUT_OF_RANGE:case Br.UNIMPLEMENTED:case Br.DATA_LOSS:return!0}}function ko(e){if(void 0===e)return Lr("GRPC error has no .code"),Br.UNKNOWN;switch(e){case yr.OK:return Br.OK;case yr.CANCELLED:return Br.CANCELLED;case yr.UNKNOWN:return Br.UNKNOWN;case yr.DEADLINE_EXCEEDED:return Br.DEADLINE_EXCEEDED;case yr.RESOURCE_EXHAUSTED:return Br.RESOURCE_EXHAUSTED;case yr.INTERNAL:return Br.INTERNAL;case yr.UNAVAILABLE:return Br.UNAVAILABLE;case yr.UNAUTHENTICATED:return Br.UNAUTHENTICATED;case yr.INVALID_ARGUMENT:return Br.INVALID_ARGUMENT;case yr.NOT_FOUND:return Br.NOT_FOUND;case yr.ALREADY_EXISTS:return Br.ALREADY_EXISTS;case yr.PERMISSION_DENIED:return Br.PERMISSION_DENIED;case yr.FAILED_PRECONDITION:return Br.FAILED_PRECONDITION;case yr.ABORTED:return Br.ABORTED;case yr.OUT_OF_RANGE:return Br.OUT_OF_RANGE;case yr.UNIMPLEMENTED:return Br.UNIMPLEMENTED;case yr.DATA_LOSS:return Br.DATA_LOSS;default:return Pr()}}function Ro(){return new TextEncoder}(tt=yr=yr||{})[tt.OK=0]="OK",tt[tt.CANCELLED=1]="CANCELLED",tt[tt.UNKNOWN=2]="UNKNOWN",tt[tt.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",tt[tt.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",tt[tt.NOT_FOUND=5]="NOT_FOUND",tt[tt.ALREADY_EXISTS=6]="ALREADY_EXISTS",tt[tt.PERMISSION_DENIED=7]="PERMISSION_DENIED",tt[tt.UNAUTHENTICATED=16]="UNAUTHENTICATED",tt[tt.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",tt[tt.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",tt[tt.ABORTED=10]="ABORTED",tt[tt.OUT_OF_RANGE=11]="OUT_OF_RANGE",tt[tt.UNIMPLEMENTED=12]="UNIMPLEMENTED",tt[tt.INTERNAL=13]="INTERNAL",tt[tt.UNAVAILABLE=14]="UNAVAILABLE",tt[tt.DATA_LOSS=15]="DATA_LOSS";const Mo=new Dr([4294967295,4294967295],0);function Lo(e){const t=Ro().encode(e),n=new xr;return n.update(t),new Uint8Array(n.digest())}function Oo(e){const t=new DataView(e.buffer),n=t.getUint32(0,!0),r=t.getUint32(4,!0),i=t.getUint32(8,!0),s=t.getUint32(12,!0);return[new Dr([n,r],0),new Dr([i,s],0)]}class Fo{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||8<=t)throw new Po(`Invalid padding: ${t}`);if(n<0)throw new Po(`Invalid hash count: ${n}`);if(0<e.length&&0===this.hashCount)throw new Po(`Invalid hash count: ${n}`);if(0===e.length&&0!==t)throw new Po(`Invalid padding when bitmap length is 0: ${t}`);this.Te=8*e.length-t,this.Ee=Dr.fromNumber(this.Te)}de(e,t,n){let r=e.add(t.multiply(Dr.fromNumber(n)));return 1===r.compare(Mo)&&(r=new Dr([r.getBits(0),r.getBits(1)],0)),r.modulo(this.Ee).toNumber()}Ae(e){return 0!=(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.Te)return!1;const t=Lo(e),[n,r]=Oo(t);for(let i=0;i<this.hashCount;i++){const t=this.de(n,r,i);if(!this.Ae(t))return!1}return!0}static create(e,t,n){const r=e%8==0?0:8-e%8,i=new Uint8Array(Math.ceil(e/8)),s=new Fo(i,r,t);return n.forEach(e=>s.insert(e)),s}insert(t){if(0!==this.Te){const n=Lo(t),[r,i]=Oo(n);for(let e=0;e<this.hashCount;e++){const n=this.de(r,i,e);this.Re(n)}}}Re(e){var t=Math.floor(e/8);this.bitmap[t]|=1<<e%8}}class Po extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class Vo{constructor(e,t,n,r,i){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}static createSynthesizedRemoteEventForCurrentChange(e,t,n){const r=new Map;return r.set(e,Bo.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new Vo(ti.min(),r,new ds(Xr),Ua,Wa())}}class Bo{constructor(e,t,n,r,i){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new Bo(n,t,Wa(),Wa(),Wa())}}class qo{constructor(e,t,n,r){this.Ve=e,this.removedTargetIds=t,this.key=n,this.me=r}}class Uo{constructor(e,t){this.targetId=e,this.fe=t}}class zo{constructor(e,t,n=_s.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class Go{constructor(){this.ge=0,this.pe=$o(),this.ye=_s.EMPTY_BYTE_STRING,this.we=!1,this.Se=!0}get current(){return this.we}get resumeToken(){return this.ye}get be(){return 0!==this.ge}get De(){return this.Se}Ce(e){0<e.approximateByteSize()&&(this.Se=!0,this.ye=e)}ve(){let n=Wa(),r=Wa(),i=Wa();return this.pe.forEach((e,t)=>{switch(t){case 0:n=n.add(e);break;case 2:r=r.add(e);break;case 1:i=i.add(e);break;default:Pr()}}),new Bo(this.ye,this.we,n,r,i)}Fe(){this.Se=!1,this.pe=$o()}Me(e,t){this.Se=!0,this.pe=this.pe.insert(e,t)}xe(e){this.Se=!0,this.pe=this.pe.remove(e)}Oe(){this.ge+=1}Ne(){--this.ge,Vr(0<=this.ge)}Be(){this.Se=!0,this.we=!0}}class jo{constructor(e){this.Le=e,this.ke=new Map,this.qe=Ua,this.Qe=Ko(),this.Ke=new ds(Xr)}$e(e){for(const t of e.Ve)e.me&&e.me.isFoundDocument()?this.Ue(t,e.me):this.We(t,e.key,e.me);for(const n of e.removedTargetIds)this.We(n,e.key,e.me)}Ge(n){this.forEachTarget(n,e=>{const t=this.ze(e);switch(n.state){case 0:this.je(e)&&t.Ce(n.resumeToken);break;case 1:t.Ne(),t.be||t.Fe(),t.Ce(n.resumeToken);break;case 2:t.Ne(),t.be||this.removeTarget(e);break;case 3:this.je(e)&&(t.Be(),t.Ce(n.resumeToken));break;case 4:this.je(e)&&(this.He(e),t.Ce(n.resumeToken));break;default:Pr()}})}forEachTarget(e,n){0<e.targetIds.length?e.targetIds.forEach(n):this.ke.forEach((e,t)=>{this.je(t)&&n(t)})}Je(e){const t=e.targetId,n=e.fe.count,r=this.Ye(t);if(r){var i=r.target;if(ba(i))if(0===n){const e=new ai(i.path);this.We(t,e,Hs.newNoDocument(e,ti.min()))}else Vr(1===n);else{const r=this.Ze(t);if(r!==n){const n=this.Xe(e),s=n?this.et(n,e,r):1;if(0!==s){this.He(t);const e=2===s?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Ke=this.Ke.insert(t,e)}}}}}Xe(e){var t=e.fe.unchangedNames;if(!t||!t.bits)return null;var{bits:{bitmap:n="",padding:r=0},hashCount:t=0}=t;let i,s;try{i=Ts(n).toUint8Array()}catch(e){if(e instanceof ws)return Or("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw e}try{s=new Fo(i,r,t)}catch(e){return Or(e instanceof Po?"BloomFilter error: ":"Applying bloom filter failed: ",e),null}return 0===s.Te?null:s}et(e,t,n){return t.fe.count===n-this.rt(e,t.targetId)?0:2}rt(n,r){const e=this.Le.getRemoteKeysForTarget(r);let i=0;return e.forEach(e=>{var t=this.Le.nt(),t=`projects/${t.projectId}/databases/${t.database}/documents/${e.path.canonicalString()}`;n.mightContain(t)||(this.We(r,e,null),i++)}),i}it(r){const i=new Map;this.ke.forEach((e,t)=>{var n=this.Ye(t);if(n){if(e.current&&ba(n.target)){const i=new ai(n.target.path);null!==this.qe.get(i)||this.st(t,i)||this.We(t,i,Hs.newNoDocument(i,r))}e.De&&(i.set(t,e.ve()),e.Fe())}});let s=Wa();this.Qe.forEach((e,t)=>{let n=!0;t.forEachWhile(e=>{var t=this.Ye(e);return!t||"TargetPurposeLimboResolution"===t.purpose||(n=!1)}),n&&(s=s.add(e))}),this.qe.forEach((e,t)=>t.setReadTime(r));var e=new Vo(r,i,this.Ke,this.qe,s);return this.qe=Ua,this.Qe=Ko(),this.Ke=new ds(Xr),e}Ue(e,t){var n;this.je(e)&&(n=this.st(e,t.key)?2:0,this.ze(e).Me(t.key,n),this.qe=this.qe.insert(t.key,t),this.Qe=this.Qe.insert(t.key,this.ot(t.key).add(e)))}We(e,t,n){if(this.je(e)){const r=this.ze(e);this.st(e,t)?r.Me(t,1):r.xe(t),this.Qe=this.Qe.insert(t,this.ot(t).delete(e)),n&&(this.qe=this.qe.insert(t,n))}}removeTarget(e){this.ke.delete(e)}Ze(e){var t=this.ze(e).ve();return this.Le.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Oe(e){this.ze(e).Oe()}ze(e){let t=this.ke.get(e);return t||(t=new Go,this.ke.set(e,t)),t}ot(e){let t=this.Qe.get(e);return t||(t=new ms(Xr),this.Qe=this.Qe.insert(e,t)),t}je(e){var t=null!==this.Ye(e);return t||Mr("WatchChangeAggregator","Detected inactive target",e),t}Ye(e){var t=this.ke.get(e);return t&&t.be?null:this.Le._t(e)}He(t){this.ke.set(t,new Go),this.Le.getRemoteKeysForTarget(t).forEach(e=>{this.We(t,e,null)})}st(e,t){return this.Le.getRemoteKeysForTarget(e).has(t)}}function Ko(){return new ds(ai.comparator)}function $o(){return new ds(ai.comparator)}const Qo={asc:"ASCENDING",desc:"DESCENDING"},Wo={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},Ho={and:"AND",or:"OR"};class Yo{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function Xo(e,t){return e.useProto3Json||Ri(t)?t:{value:t}}function Jo(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function Zo(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function eu(e){return Vr(!!e),ti.fromTimestamp((t=Is(e),new ei(t.seconds,t.nanos)));var t}function tu(e,t){return e=e,new ri(["projects",e.projectId,"databases",e.database]).child("documents").child(t).canonicalString()}function nu(e){var t=ri.fromString(e);return Vr(_u(t)),t}function ru(e,t){return tu(e.databaseId,t.path)}function iu(e,t){const n=nu(t);if(n.get(1)!==e.databaseId.projectId)throw new qr(Br.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new qr(Br.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new ai(uu(n))}function su(e,t){return tu(e.databaseId,t)}function au(e){var t=nu(e);return 4===t.length?ri.emptyPath():uu(t)}function ou(e){return new ri(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function uu(e){return Vr(4<e.length&&"documents"===e.get(4)),e.popFirst(5)}function cu(e,t,n){return{name:ru(e,t),fields:n.value.mapValue.fields}}function hu(e,t,n){const r=iu(e,t.name),i=eu(t.updateTime),s=t.createTime?eu(t.createTime):ti.min(),a=new Ws({mapValue:{fields:t.fields}}),o=Hs.newFoundDocument(r,i,s,a);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function lu(e,t){let n;if(t instanceof wo)n={update:cu(e,t.key,t.value)};else if(t instanceof To)n={delete:ru(e,t.key)};else if(t instanceof _o)n={update:cu(e,t.key,t.data),updateMask:function(e){const t=[];return e.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}(t.fieldMask)};else{if(!(t instanceof So))return Pr();n={verify:ru(e,t.key)}}return 0<t.fieldTransforms.length&&(n.updateTransforms=t.fieldTransforms.map(e=>function(e){var t=e.transform;if(t instanceof to)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(t instanceof no)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:t.elements}};if(t instanceof io)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:t.elements}};if(t instanceof ao)return{fieldPath:e.field.canonicalString(),increment:t.Ie};throw Pr()}(e))),t.precondition.isNone||(n.currentDocument=(r=e,void 0!==(e=t.precondition).updateTime?{updateTime:(t=e.updateTime,Jo(r,t.toTimestamp()))}:void 0!==e.exists?{exists:e.exists}:Pr())),n;var r}function du(t,e){const n=e.currentDocument?void 0!==(i=e.currentDocument).updateTime?lo.updateTime(eu(i.updateTime)):void 0!==i.exists?lo.exists(i.exists):lo.none():lo.none(),r=e.updateTransforms?e.updateTransforms.map(e=>function(e,t){let n=null;if("setToServerValue"in t)Vr("REQUEST_TIME"===t.setToServerValue),n=new to;else if("appendMissingElements"in t){const e=t.appendMissingElements.values||[];n=new no(e)}else if("removeAllFromArray"in t){const e=t.removeAllFromArray.values||[];n=new io(e)}else"increment"in t?n=new ao(e,t.increment):Pr();var r=si.fromServerFormat(t.fieldPath);return new co(r,n)}(t,e)):[];var i;if(e.update){e.update.name;var s=iu(t,e.update.name),a=new Ws({mapValue:{fields:e.update.fields}});if(e.updateMask){const t=function(e){const t=e.fieldPaths||[];return new vs(t.map(e=>si.fromServerFormat(e)))}(e.updateMask);return new _o(s,a,t,n,r)}return new wo(s,a,n,r)}if(e.delete){const r=iu(t,e.delete);return new To(r,n)}if(e.verify){const r=iu(t,e.verify);return new So(r,n)}return Pr()}function fu(e,t){return{documents:[su(e,t.path)]}}function gu(e,t){const n={structuredQuery:{}},r=t.path;null!==t.collectionGroup?(n.parent=su(e,r),n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n.parent=su(e,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);var i=function(e){if(0!==e.length)return function n(e){return e instanceof ta?function(e){if("=="===e.op){if(zs(e.value))return{unaryFilter:{field:vu(e.field),op:"IS_NAN"}};if(Us(e.value))return{unaryFilter:{field:vu(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(zs(e.value))return{unaryFilter:{field:vu(e.field),op:"IS_NOT_NAN"}};if(Us(e.value))return{unaryFilter:{field:vu(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:vu(e.field),op:pu(e.op),value:e.value}}}(e):e instanceof na?function(e){const t=e.getFilters().map(e=>n(e));return 1===t.length?t[0]:{compositeFilter:{op:yu(e.op),filters:t}}}(e):Pr()}(na.create(e,"and"))}(t.filters);i&&(n.structuredQuery.where=i);i=function(e){if(0!==e.length)return e.map(e=>function(e){return{field:vu(e.field),direction:(e=e.dir,Qo[e])}}(e))}(t.orderBy);i&&(n.structuredQuery.orderBy=i);i=Xo(e,t.limit);return null!==i&&(n.structuredQuery.limit=i),t.startAt&&(n.structuredQuery.startAt={before:(e=t.startAt).inclusive,values:e.position}),t.endAt&&(n.structuredQuery.endAt={before:!(t=t.endAt).inclusive,values:t.position}),n}function mu(e){let t=au(e.parent);var n,r,i,s=e.structuredQuery,a=s.from?s.from.length:0;let o=null;if(0<a){Vr(1===a);const f=s.from[0];f.allDescendants?o=f.collectionId:t=t.child(f.collectionId)}let u=[];s.where&&(u=function(e){const t=function t(e){return void 0!==e.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":const t=wu(e.unaryFilter.field);return ta.create(t,"==",{doubleValue:NaN});case"IS_NULL":const n=wu(e.unaryFilter.field);return ta.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=wu(e.unaryFilter.field);return ta.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const i=wu(e.unaryFilter.field);return ta.create(i,"!=",{nullValue:"NULL_VALUE"});default:return Pr()}}(e):void 0!==e.fieldFilter?function(e){return ta.create(wu(e.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return Pr()}}(e.fieldFilter.op),e.fieldFilter.value)}(e):void 0!==e.compositeFilter?function(e){return na.create(e.compositeFilter.filters.map(e=>t(e)),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return Pr()}}(e.compositeFilter.op))}(e):Pr()}(e);return t instanceof na&&sa(t)?t.getFilters():[t]}(s.where));let c=[];s.orderBy&&(c=s.orderBy.map(e=>function(e){return new Zs(wu(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))}(e)));let h=null;s.limit&&(h=(e=s.limit,Ri(n="object"==typeof e?e.value:e)?null:n));let l=null;s.startAt&&(l=(r=s.startAt,i=!!r.before,n=r.values||[],new Ys(n,i)));let d=null;return s.endAt&&(d=(r=s.endAt,i=!r.before,s=r.values||[],new Ys(s,i))),xa(t,o,c,u,h,"F",l,d)}function pu(e){return Wo[e]}function yu(e){return Ho[e]}function vu(e){return{fieldPath:e.canonicalString()}}function wu(e){return si.fromServerFormat(e.fieldPath)}function _u(e){return 4<=e.length&&"projects"===e.get(0)&&"databases"===e.get(2)}class bu{constructor(e,t,n,r,i=ti.min(),s=ti.min(),a=_s.EMPTY_BYTE_STRING,o=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.lastLimboFreeSnapshotVersion=s,this.resumeToken=a,this.expectedCount=o}withSequenceNumber(e){return new bu(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new bu(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new bu(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new bu(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class Iu{constructor(e){this.ut=e}}function Eu(e,t){const n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:Tu(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())r.document={name:ru(i=e.ut,(e=t).key),fields:e.data.value.mapValue.fields,updateTime:Jo(i,e.version.toTimestamp()),createTime:Jo(i,e.createTime.toTimestamp())};else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:Su(t.version)};else{if(!t.isUnknownDocument())return Pr();r.unknownDocument={path:n.path.toArray(),version:Su(t.version)}}var i;return r}function Tu(e){var t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function Su(e){var t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function xu(e){var t=new ei(e.seconds,e.nanoseconds);return ti.fromTimestamp(t)}function Du(t,e){const n=(e.baseMutations||[]).map(e=>du(t.ut,e));for(let s=0;s<e.mutations.length-1;++s){const n=e.mutations[s];if(s+1<e.mutations.length&&void 0!==e.mutations[s+1].transform){const r=e.mutations[s+1];n.updateTransforms=r.transform.fieldTransforms,e.mutations.splice(s+1,1),++s}}const r=e.mutations.map(e=>du(t.ut,e)),i=ei.fromMillis(e.localWriteTimeMs);return new xo(e.batchId,i,n,r)}function Cu(e){var t,n=xu(e.readTime),r=void 0!==e.lastLimboFreeSnapshotVersion?xu(e.lastLimboFreeSnapshotVersion):ti.min(),i=void 0!==e.query.documents?(Vr(1===(t=e.query).documents.length),ka(Da(au(t.documents[0])))):ka(mu(e.query));return new bu(i,e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,n,r,_s.fromBase64String(e.resumeToken))}function Au(e,t){var n=Su(t.snapshotVersion),r=Su(t.lastLimboFreeSnapshotVersion),i=(ba(t.target)?fu:gu)(e.ut,t.target),s=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:wa(t.target),readTime:n,resumeToken:s,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:i}}function Nu(e){var t=mu({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?Ma(t,t.limit,"L"):t}function ku(e,t){return new Co(t.largestBatchId,du(e.ut,t.overlayMutation))}function Ru(e,t){var n=t.path.lastSegment();return[e,Oi(t.path.popLast()),n]}function Mu(e,t,n,r){return{indexId:e,uid:t.uid||"",sequenceNumber:n,readTime:Su(r.readTime),documentKey:Oi(r.documentKey.path),largestBatchId:r.largestBatchId}}class Lu{getBundleMetadata(e,t){return Ou(e).get(t).next(e=>{if(e)return{id:(e=e).bundleId,createTime:xu(e.createTime),version:e.version}})}saveBundleMetadata(e,t){return Ou(e).put({bundleId:(t=t).id,createTime:Su(eu(t.createTime)),version:t.version})}getNamedQuery(e,t){return Fu(e).get(t).next(e=>{if(e)return{name:(e=e).name,query:Nu(e.bundledQuery),readTime:xu(e.readTime)}})}saveNamedQuery(e,t){return Fu(e).put({name:(t=t).name,readTime:Su(eu(t.readTime)),bundledQuery:t.bundledQuery})}}function Ou(e){return us(e,"bundles")}function Fu(e){return us(e,"namedQueries")}class Pu{constructor(e,t){this.serializer=e,this.userId=t}static ct(e,t){var n=t.uid||"";return new Pu(e,n)}getOverlay(e,t){return Vu(e).get(Ru(this.userId,t)).next(e=>e?ku(this.serializer,e):null)}getOverlays(e,t){const n=Ka();return wi.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(r,i,e){const s=[];return e.forEach((e,t)=>{var n=new Co(i,t);s.push(this.lt(r,n))}),wi.waitFor(s)}removeOverlaysForBatchId(n,e,r){const t=new Set;e.forEach(e=>t.add(Oi(e.getCollectionPath())));const i=[];return t.forEach(e=>{var t=IDBKeyRange.bound([this.userId,e,r],[this.userId,e,r+1],!1,!0);i.push(Vu(n).H("collectionPathOverlayIndex",t))}),wi.waitFor(i)}getOverlaysForCollection(e,t,n){const r=Ka(),i=Oi(t),s=IDBKeyRange.bound([this.userId,i,n],[this.userId,i,Number.POSITIVE_INFINITY],!0);return Vu(e).W("collectionPathOverlayIndex",s).next(e=>{for(const t of e){const e=ku(this.serializer,t);r.set(e.getKey(),e)}return r})}getOverlaysForCollectionGroup(e,t,n,i){const s=Ka();let a;var r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return Vu(e).Y({index:"collectionGroupOverlayIndex",range:r},(e,t,n)=>{const r=ku(this.serializer,t);s.size()<i||r.largestBatchId===a?(s.set(r.getKey(),r),a=r.largestBatchId):n.done()}).next(()=>s)}lt(e,t){return Vu(e).put(function(e,t,n){var[,r,i]=Ru(t,n.mutation.key);return{userId:t,collectionPath:r,documentId:i,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:lu(e.ut,n.mutation)}}(this.serializer,this.userId,t))}}function Vu(e){return us(e,"documentOverlays")}class Bu{constructor(){}ht(e,t){this.Pt(e,t),t.It()}Pt(e,t){var n,r;"nullValue"in e?this.Tt(t,5):"booleanValue"in e?(this.Tt(t,10),t.Et(e.booleanValue?1:0)):"integerValue"in e?(this.Tt(t,15),t.Et(Es(e.integerValue))):"doubleValue"in e?(n=Es(e.doubleValue),isNaN(n)?this.Tt(t,13):(this.Tt(t,15),Mi(n)?t.Et(0):t.Et(n))):"timestampValue"in e?(r=e.timestampValue,this.Tt(t,20),"string"==typeof r?t.dt(r):(t.dt(`${r.seconds||""}`),t.Et(r.nanos||0))):"stringValue"in e?(this.At(e.stringValue,t),this.Rt(t)):"bytesValue"in e?(this.Tt(t,30),t.Vt(Ts(e.bytesValue)),this.Rt(t)):"referenceValue"in e?this.ft(e.referenceValue,t):"geoPointValue"in e?(r=e.geoPointValue,this.Tt(t,45),t.Et(r.latitude||0),t.Et(r.longitude||0)):"mapValue"in e?Ks(e)?this.Tt(t,Number.MAX_SAFE_INTEGER):(this.gt(e.mapValue,t),this.Rt(t)):"arrayValue"in e?(this.yt(e.arrayValue,t),this.Rt(t)):Pr()}At(e,t){this.Tt(t,25),this.wt(e,t)}wt(e,t){t.dt(e)}gt(e,t){var n=e.fields||{};this.Tt(t,55);for(const e of Object.keys(n))this.At(e,t),this.Pt(n[e],t)}yt(e,t){var n=e.values||[];this.Tt(t,50);for(const e of n)this.Pt(e,t)}ft(e,t){this.Tt(t,37),ai.fromName(e).path.forEach(e=>{this.Tt(t,60),this.wt(e,t)})}Tt(e,t){e.Et(t)}Rt(e){e.Et(2)}}function qu(e){var t=64-function(e){let t=0;for(let r=0;r<8;++r){var n=function(e){if(0===e)return 8;let t=0;return e>>4==0&&(t+=4,e<<=4),e>>6==0&&(t+=2,e<<=2),e>>7==0&&(t+=1),t}(255&e[r]);if(t+=n,8!==n)break}return t}(e);return Math.ceil(t/8)}Bu.St=new Bu;class Uu{constructor(){this.buffer=new Uint8Array(1024),this.position=0}bt(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Dt(n.value),n=t.next();this.Ct()}vt(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ft(n.value),n=t.next();this.Mt()}xt(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Dt(e);else if(e<2048)this.Dt(960|e>>>6),this.Dt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Dt(480|e>>>12),this.Dt(128|63&e>>>6),this.Dt(128|63&e);else{const e=t.codePointAt(0);this.Dt(240|e>>>18),this.Dt(128|63&e>>>12),this.Dt(128|63&e>>>6),this.Dt(128|63&e)}}this.Ct()}Ot(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Ft(e);else if(e<2048)this.Ft(960|e>>>6),this.Ft(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ft(480|e>>>12),this.Ft(128|63&e>>>6),this.Ft(128|63&e);else{const e=t.codePointAt(0);this.Ft(240|e>>>18),this.Ft(128|63&e>>>12),this.Ft(128|63&e>>>6),this.Ft(128|63&e)}}this.Mt()}Nt(e){var t=this.Bt(e),n=qu(t);this.Lt(1+n),this.buffer[this.position++]=255&n;for(let r=t.length-n;r<t.length;++r)this.buffer[this.position++]=255&t[r]}kt(e){var t=this.Bt(e),n=qu(t);this.Lt(1+n),this.buffer[this.position++]=~(255&n);for(let r=t.length-n;r<t.length;++r)this.buffer[this.position++]=~(255&t[r])}qt(){this.Qt(255),this.Qt(255)}Kt(){this.$t(255),this.$t(255)}reset(){this.position=0}seed(e){this.Lt(e.length),this.buffer.set(e,this.position),this.position+=e.length}Ut(){return this.buffer.slice(0,this.position)}Bt(e){const t=function(e){const t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=0!=(128&t[0]);t[0]^=n?255:128;for(let r=1;r<t.length;++r)t[r]^=n?255:0;return t}Dt(e){var t=255&e;0==t?(this.Qt(0),this.Qt(255)):255==t?(this.Qt(255),this.Qt(0)):this.Qt(t)}Ft(e){var t=255&e;0==t?(this.$t(0),this.$t(255)):255==t?(this.$t(255),this.$t(0)):this.$t(e)}Ct(){this.Qt(0),this.Qt(1)}Mt(){this.$t(0),this.$t(1)}Qt(e){this.Lt(1),this.buffer[this.position++]=e}$t(e){this.Lt(1),this.buffer[this.position++]=~e}Lt(e){var t=e+this.position;if(!(t<=this.buffer.length)){let e=2*this.buffer.length;e<t&&(e=t);const n=new Uint8Array(e);n.set(this.buffer),this.buffer=n}}}class zu{constructor(e){this.Wt=e}Vt(e){this.Wt.bt(e)}dt(e){this.Wt.xt(e)}Et(e){this.Wt.Nt(e)}It(){this.Wt.qt()}}class Gu{constructor(e){this.Wt=e}Vt(e){this.Wt.vt(e)}dt(e){this.Wt.Ot(e)}Et(e){this.Wt.kt(e)}It(){this.Wt.Kt()}}class ju{constructor(){this.Wt=new Uu,this.Gt=new zu(this.Wt),this.zt=new Gu(this.Wt)}seed(e){this.Wt.seed(e)}jt(e){return 0===e?this.Gt:this.zt}Ut(){return this.Wt.Ut()}reset(){this.Wt.reset()}}class Ku{constructor(e,t,n,r){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=r}Ht(){const e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new Ku(this.indexId,this.documentKey,this.arrayValue,n)}}function $u(e,t){let n=e.indexId-t.indexId;return 0!==n?n:(n=Qu(e.arrayValue,t.arrayValue),0!==n?n:(n=Qu(e.directionalValue,t.directionalValue),0!==n?n:ai.comparator(e.documentKey,t.documentKey)))}function Qu(e,t){for(let r=0;r<e.length&&r<t.length;++r){var n=e[r]-t[r];if(0!=n)return n}return e.length-t.length}class Wu{constructor(e){this.Jt=new ms((e,t)=>si.comparator(e.field,t.field)),this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.Yt=e.orderBy,this.Zt=[];for(const t of e.filters){const e=t;e.isInequality()?this.Jt=this.Jt.add(e):this.Zt.push(e)}}get Xt(){return 1<this.Jt.size}en(e){if(Vr(e.collectionGroup===this.collectionId),this.Xt)return!1;const t=ui(e);if(void 0!==t&&!this.tn(t))return!1;const n=ci(e);let r=new Set,i=0,s=0;for(;i<n.length&&this.tn(n[i]);++i)r=r.add(n[i].fieldPath.canonicalString());if(i===n.length)return!0;if(0<this.Jt.size){const e=this.Jt.getIterator().getNext();if(!r.has(e.field.canonicalString())){const t=n[i];if(!this.nn(e,t)||!this.rn(this.Yt[s++],t))return!1}++i}for(;i<n.length;++i){const e=n[i];if(s>=this.Yt.length||!this.rn(this.Yt[s++],e))return!1}return!0}sn(){if(this.Xt)return null;let e=new ms(si.comparator);const t=[];for(const n of this.Zt)n.field.isKeyField()||("array-contains"===n.op||"array-contains-any"===n.op?t.push(new hi(n.field,2)):e.has(n.field)||(e=e.add(n.field),t.push(new hi(n.field,0))));for(const r of this.Yt)r.field.isKeyField()||e.has(r.field)||(e=e.add(r.field),t.push(new hi(r.field,"asc"===r.dir?0:1)));return new oi(oi.UNKNOWN_ID,this.collectionId,t,li.empty())}tn(e){for(const t of this.Zt)if(this.nn(t,e))return!0;return!1}nn(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;var n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind==n}rn(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function Hu(e){if(0===e.getFilters().length)return[];const t=function t(e){if(Vr(e instanceof ta||e instanceof na),e instanceof ta)return e;if(1===e.filters.length)return t(e.filters[0]);const n=e.filters.map(e=>t(e));let r=na.create(n,e.op);return r=tc(r),Ju(r)?r:(Vr(r instanceof na),Vr(ra(r)),Vr(1<r.filters.length),r.filters.reduce((e,t)=>Zu(e,t)))}(function t(n){var e;if(Vr(n instanceof ta||n instanceof na),n instanceof ta){if(n instanceof ga){const r=(null===(e=null===(e=n.value.arrayValue)||void 0===e?void 0:e.values)||void 0===e?void 0:e.map(e=>ta.create(n.field,"==",e)))||[];return na.create(r,"or")}return n}const r=n.filters.map(e=>t(e));return na.create(r,n.op)}(e));return Vr(Ju(t)),Yu(t)||Xu(t)?[t]:t.getFilters()}function Yu(e){return e instanceof ta}function Xu(e){return e instanceof na&&sa(e)}function Ju(e){return Yu(e)||Xu(e)||function(e){if(e instanceof na&&ia(e)){for(const t of e.getFilters())if(!Yu(t)&&!Xu(t))return!1;return!0}return!1}(e)}function Zu(e,t){var n,r;return Vr(e instanceof ta||e instanceof na),Vr(t instanceof ta||t instanceof na),tc(e instanceof ta?t instanceof ta?(n=e,r=t,na.create([n,r],"and")):ec(e,t):t instanceof ta?ec(t,e):function(e,t){if(Vr(0<e.filters.length&&0<t.filters.length),ra(e)&&ra(t))return oa(e,t.getFilters());const n=ia(e)?e:t,r=ia(e)?t:e,i=n.filters.map(e=>Zu(e,r));return na.create(i,"or")}(e,t))}function ec(t,e){if(ra(e))return oa(e,t.getFilters());var n=e.filters.map(e=>Zu(t,e));return na.create(n,"or")}function tc(t){if(Vr(t instanceof ta||t instanceof na),t instanceof ta)return t;const e=t.getFilters();if(1===e.length)return tc(e[0]);if(aa(t))return t;const n=e.map(e=>tc(e)),r=[];return n.forEach(e=>{e instanceof ta?r.push(e):e instanceof na&&(e.op===t.op?r.push(...e.filters):r.push(e))}),1===r.length?r[0]:na.create(r,t.op)}class nc{constructor(){this.on=new rc}addToCollectionParentIndex(e,t){return this.on.add(t),wi.resolve()}getCollectionParents(e,t){return wi.resolve(this.on.getEntries(t))}addFieldIndex(e,t){return wi.resolve()}deleteFieldIndex(e,t){return wi.resolve()}deleteAllFieldIndexes(e){return wi.resolve()}createTargetIndexes(e,t){return wi.resolve()}getDocumentsMatchingTarget(e,t){return wi.resolve(null)}getIndexType(e,t){return wi.resolve(0)}getFieldIndexes(e,t){return wi.resolve([])}getNextCollectionGroupToUpdate(e){return wi.resolve(null)}getMinOffset(e,t){return wi.resolve(gi.min())}getMinOffsetFromCollectionGroup(e,t){return wi.resolve(gi.min())}updateCollectionGroup(e,t,n){return wi.resolve()}updateIndexEntries(e,t){return wi.resolve()}}class rc{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new ms(ri.comparator),i=!r.has(n);return this.index[t]=r.add(n),i}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new ms(ri.comparator)).toArray()}}const ic=new Uint8Array(0);class sc{constructor(e,t){this.user=e,this.databaseId=t,this._n=new rc,this.an=new qa(e=>wa(e),(e,t)=>_a(e,t)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(this._n.has(t))return wi.resolve();var n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener(()=>{this._n.add(t)});r={collectionId:n,parent:Oi(r)};return ac(e).put(r)}getCollectionParents(e,n){const r=[],t=IDBKeyRange.bound([n,""],[Zr(n),""],!1,!0);return ac(e).W(t).next(e=>{for(const t of e){if(t.collectionId!==n)break;r.push(Pi(t.parent))}return r})}addFieldIndex(e,t){const n=uc(e),r={indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map(e=>[e.fieldPath.canonicalString(),e.kind])};delete r.indexId;const i=n.add(r);if(t.indexState){const n=cc(e);return i.next(e=>{n.put(Mu(e,this.user,t.indexState.sequenceNumber,t.indexState.offset))})}return i.next()}deleteFieldIndex(e,t){const n=uc(e),r=cc(e),i=oc(e);return n.delete(t.indexId).next(()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>i.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}deleteAllFieldIndexes(e){const t=uc(e),n=oc(e),r=cc(e);return t.H().next(()=>n.H()).next(()=>r.H())}createTargetIndexes(n,e){return wi.forEach(this.un(e),t=>this.getIndexType(n,t).next(e=>{if(0===e||1===e){const e=new Wu(t).sn();if(null!=e)return this.addFieldIndex(n,e)}}))}getDocumentsMatchingTarget(e,h){const l=oc(e);let d=!0;const n=new Map;return wi.forEach(this.un(h),t=>this.cn(e,t).next(e=>{d=d&&!!e,n.set(t,e)})).next(()=>{if(d){let c=Wa();const d=[];return wi.forEach(n,(e,t)=>{var n;Mr("IndexedDbIndexManager",`Using index ${n=e,`id=${n.indexId}|cg=${n.collectionGroup}|f=${n.fields.map(e=>`${e.fieldPath}:${e.kind}`).join(",")}`} to execute ${wa(h)}`);var r=function(e,t){var n=ui(t);if(void 0===n)return null;for(const t of Ia(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(t,e),i=function(e,t){const n=new Map;for(const r of ci(t))for(const t of Ia(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(t,e),s=function(e,t){const n=[];let r=!0;for(const i of ci(t)){const t=(0===i.kind?Ea:Ta)(e,i.fieldPath,e.startAt);n.push(t.value),r=r&&t.inclusive}return new Ys(n,r)}(t,e),a=function(e,t){const n=[];let r=!0;for(const i of ci(t)){const t=(0===i.kind?Ta:Ea)(e,i.fieldPath,e.endAt);n.push(t.value),r=r&&t.inclusive}return new Ys(n,r)}(t,e),o=this.ln(e,t,s),u=this.ln(e,t,a),i=this.hn(e,t,i),i=this.Pn(e.indexId,r,o,s.inclusive,u,a.inclusive,i);return wi.forEach(i,e=>l.j(e,h.limit).next(e=>{e.forEach(e=>{var t=ai.fromSegments(e.documentKey);c.has(t)||(c=c.add(t),d.push(t))})}))}).next(()=>d)}return wi.resolve(null)})}un(t){let e=this.an.get(t);return e||(e=0===t.filters.length?[t]:Hu(na.create(t.filters,"and")).map(e=>va(t.path,t.collectionGroup,t.orderBy,e.getFilters(),t.limit,t.startAt,t.endAt)),this.an.set(t,e),e)}Pn(t,e,n,r,i,s,a){const o=(null!=e?e.length:1)*Math.max(n.length,i.length),u=o/(null!=e?e.length:1),c=[];for(let h=0;h<o;++h){const o=e?this.In(e[h/u]):ic,l=this.Tn(t,o,n[h%u],r),d=this.En(t,o,i[h%u],s),f=a.map(e=>this.Tn(t,o,e,!0));c.push(...this.createRange(l,d,f))}return c}Tn(e,t,n,r){const i=new Ku(e,ai.empty(),t,n);return r?i:i.Ht()}En(e,t,n,r){const i=new Ku(e,ai.empty(),t,n);return r?i.Ht():i}cn(e,t){const r=new Wu(t),n=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,n).next(e=>{let t=null;for(const n of e)r.en(n)&&(!t||n.fields.length>t.fields.length)&&(t=n);return t})}getIndexType(e,t){let n=2;const r=this.un(t);return wi.forEach(r,t=>this.cn(e,t).next(e=>{e?0!==n&&e.fields.length<function(e){let t=new ms(si.comparator),n=!1;for(const r of e.filters)for(const e of r.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(const n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})).next(()=>function(e){return null!==e.limit}(t)&&1<r.length&&2===n?1:n)}dn(e,t){const n=new ju;for(const i of ci(e)){const e=t.data.field(i.fieldPath);if(null==e)return null;var r=n.jt(i.kind);Bu.St.ht(e,r)}return n.Ut()}In(e){const t=new ju;return Bu.St.ht(e,t.jt(0)),t.Ut()}An(e,t){const n=new ju;return Bu.St.ht(Vs(this.databaseId,t),n.jt(0===(r=ci(e)).length?0:r[r.length-1].kind)),n.Ut();var r}hn(e,t,n){if(null===n)return[];let r=[];r.push(new ju);let i=0;for(const s of ci(e)){const e=n[i++];for(const n of r)if(this.Rn(t,s.fieldPath)&&qs(e))r=this.Vn(r,s,e);else{const t=n.jt(s.kind);Bu.St.ht(e,t)}}return this.mn(r)}ln(e,t,n){return this.hn(e,t,n.position)}mn(e){const t=[];for(let n=0;n<e.length;++n)t[n]=e[n].Ut();return t}Vn(e,t,n){const r=[...e],i=[];for(const e of n.arrayValue.values||[])for(const n of r){const r=new ju;r.seed(n.Ut()),Bu.St.ht(e,r.jt(t.kind)),i.push(r)}return i}Rn(e,t){return!!e.filters.find(e=>e instanceof ta&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op))}getFieldIndexes(e,t){const n=uc(e),r=cc(e);return(t?n.W("collectionGroupIndex",IDBKeyRange.bound(t,t)):n.W()).next(e=>{const s=[];return wi.forEach(e,i=>r.get([i.indexId,this.uid]).next(e=>{var t,n,r;s.push((t=i,n=(e=e)?new li(e.sequenceNumber,new gi(xu(e.readTime),new ai(Pi(e.documentKey)),e.largestBatchId)):li.empty(),r=t.fields.map(([e,t])=>new hi(si.fromServerFormat(e),t)),new oi(t.indexId,t.collectionGroup,r,n)))})).next(()=>s)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(e=>0===e.length?null:(e.sort((e,t)=>{var n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!=n?n:Xr(e.collectionGroup,t.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(e,n,r){const i=uc(e),s=cc(e);return this.fn(e).next(t=>i.W("collectionGroupIndex",IDBKeyRange.bound(n,n)).next(e=>wi.forEach(e,e=>s.put(Mu(e.indexId,this.user,t,r)))))}updateIndexEntries(i,e){const n=new Map;return wi.forEach(e,(t,r)=>{var e=n.get(t.collectionGroup);return(e?wi.resolve(e):this.getFieldIndexes(i,t.collectionGroup)).next(e=>(n.set(t.collectionGroup,e),wi.forEach(e,n=>this.gn(i,t,n).next(e=>{var t=this.pn(r,n);return e.isEqual(t)?wi.resolve():this.yn(i,r,n,e,t)}))))})}wn(e,t,n,r){return oc(e).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.An(n,t.key),documentKey:t.key.path.toArray()})}Sn(e,t,n,r){return oc(e).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.An(n,t.key),t.key.path.toArray()])}gn(e,n,r){const t=oc(e);let i=new ms($u);return t.Y({index:"documentKeyIndex",range:IDBKeyRange.only([r.indexId,this.uid,this.An(r,n)])},(e,t)=>{i=i.add(new Ku(r.indexId,n,t.arrayValue,t.directionalValue))}).next(()=>i)}pn(e,t){let n=new ms($u);var r=this.dn(t,e);if(null==r)return n;const i=ui(t);if(null!=i){var s=e.data.field(i.fieldPath);if(qs(s))for(const i of s.arrayValue.values||[])n=n.add(new Ku(t.indexId,e.key,this.In(i),r))}else n=n.add(new Ku(t.indexId,e.key,ic,r));return n}yn(t,n,r,e,i){Mr("IndexedDbIndexManager","Updating index entries for document '%s'",n.key);const s=[];return function(e,t,n,r,i){var s=e.getIterator(),a=t.getIterator();let o=ys(s),u=ys(a);for(;o||u;){let e=!1,t=!1;if(o&&u){const r=n(o,u);r<0?t=!0:0<r&&(e=!0)}else null!=o?t=!0:e=!0;e?(r(u),u=ys(a)):t?(i(o),o=ys(s)):(o=ys(s),u=ys(a))}}(e,i,$u,e=>{s.push(this.wn(t,n,r,e))},e=>{s.push(this.Sn(t,n,r,e))}),wi.waitFor(s)}fn(e){let r=1;return cc(e).Y({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(e,t,n)=>{n.done(),r=t.sequenceNumber+1}).next(()=>r)}createRange(e,t,n){n=n.sort((e,t)=>$u(e,t)).filter((e,t,n)=>!t||0!==$u(e,n[t-1]));const r=[];r.push(e);for(const i of n){const n=$u(i,e),s=$u(i,t);if(0===n)r[0]=e.Ht();else if(0<n&&s<0)r.push(i),r.push(i.Ht());else if(0<s)break}r.push(t);const i=[];for(let a=0;a<r.length;a+=2){if(this.bn(r[a],r[a+1]))return[];const t=[r[a].indexId,this.uid,r[a].arrayValue,r[a].directionalValue,ic,[]],n=[r[a+1].indexId,this.uid,r[a+1].arrayValue,r[a+1].directionalValue,ic,[]];i.push(IDBKeyRange.bound(t,n))}return i}bn(e,t){return 0<$u(e,t)}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(hc)}getMinOffset(t,e){return wi.mapArray(this.un(e),e=>this.cn(t,e).next(e=>e||Pr())).next(hc)}}function ac(e){return us(e,"collectionParents")}function oc(e){return us(e,"indexEntries")}function uc(e){return us(e,"indexConfiguration")}function cc(e){return us(e,"indexState")}function hc(e){Vr(0!==e.length);let t=e[0].indexState.offset,n=t.largestBatchId;for(let i=1;i<e.length;i++){var r=e[i].indexState.offset;mi(r,t)<0&&(t=r),n<r.largestBatchId&&(n=r.largestBatchId)}return new gi(t.readTime,t.documentKey,n)}const lc={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class dc{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new dc(e,dc.DEFAULT_COLLECTION_PERCENTILE,dc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function fc(e,t,n){const r=e.store("mutations"),i=e.store("documentMutations"),s=[],a=IDBKeyRange.only(n.batchId);let o=0;const u=r.Y({range:a},(e,t,n)=>(o++,n.delete()));s.push(u.next(()=>{Vr(1===o)}));const c=[];for(const e of n.mutations){const r=qi(t,e.key.path,n.batchId);s.push(i.delete(r)),c.push(e.key)}return wi.waitFor(s).next(()=>c)}function gc(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw Pr();t=e.noDocument}return JSON.stringify(t).length}dc.DEFAULT_COLLECTION_PERCENTILE=10,dc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,dc.DEFAULT=new dc(41943040,dc.DEFAULT_COLLECTION_PERCENTILE,dc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),dc.DISABLED=new dc(-1,0,0);class mc{constructor(e,t,n,r){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=r,this.Dn={}}static ct(e,t,n,r){Vr(""!==e.uid);var i=e.isAuthenticated()?e.uid:"";return new mc(i,t,n,r)}checkEmpty(e){let r=!0;var t=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return yc(e).Y({index:"userMutationsIndex",range:t},(e,t,n)=>{r=!1,n.done()}).next(()=>r)}addMutationBatch(h,l,d,f){const g=vc(h),m=yc(h);return m.add({}).next(e=>{Vr("number"==typeof e);const t=new xo(e,l,d,f),n=(i=this.serializer,s=this.userId,a=t,o=a.baseMutations.map(e=>lu(i.ut,e)),u=a.mutations.map(e=>lu(i.ut,e)),{userId:s,batchId:a.batchId,localWriteTimeMs:a.localWriteTime.toMillis(),baseMutations:o,mutations:u}),r=[];var i,s,a,o,u;let c=new ms((e,t)=>Xr(e.canonicalString(),t.canonicalString()));for(const h of f){const l=qi(this.userId,h.key.path,e);c=c.add(h.key.path.popLast()),r.push(m.put(n)),r.push(g.put(l,Ui))}return c.forEach(e=>{r.push(this.indexManager.addToCollectionParentIndex(h,e))}),h.addOnCommittedListener(()=>{this.Dn[e]=t.keys()}),wi.waitFor(r).next(()=>t)})}lookupMutationBatch(e,t){return yc(e).get(t).next(e=>e?(Vr(e.userId===this.userId),Du(this.serializer,e)):null)}Cn(e,n){return this.Dn[n]?wi.resolve(this.Dn[n]):this.lookupMutationBatch(e,n).next(e=>{if(e){var t=e.keys();return this.Dn[n]=t}return null})}getNextMutationBatchAfterBatchId(e,t){const r=t+1,n=IDBKeyRange.lowerBound([this.userId,r]);let i=null;return yc(e).Y({index:"userMutationsIndex",range:n},(e,t,n)=>{t.userId===this.userId&&(Vr(t.batchId>=r),i=Du(this.serializer,t)),n.done()}).next(()=>i)}getHighestUnacknowledgedBatchId(e){var t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let r=-1;return yc(e).Y({index:"userMutationsIndex",range:t,reverse:!0},(e,t,n)=>{r=t.batchId,n.done()}).next(()=>r)}getAllMutationBatches(e){var t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return yc(e).W("userMutationsIndex",t).next(e=>e.map(e=>Du(this.serializer,e)))}getAllMutationBatchesAffectingDocumentKey(a,o){const e=Bi(this.userId,o.path),t=IDBKeyRange.lowerBound(e),u=[];return vc(a).Y({range:t},(e,t,n)=>{var[r,i,s]=e,i=Pi(i);if(r===this.userId&&o.path.isEqual(i))return yc(a).get(s).next(e=>{if(!e)throw Pr();Vr(e.userId===this.userId),u.push(Du(this.serializer,e))});n.done()}).next(()=>u)}getAllMutationBatchesAffectingDocumentKeys(t,e){let o=new ms(Xr);const n=[];return e.forEach(a=>{var e=Bi(this.userId,a.path),e=IDBKeyRange.lowerBound(e),e=vc(t).Y({range:e},(e,t,n)=>{var[r,i,s]=e,i=Pi(i);r===this.userId&&a.path.isEqual(i)?o=o.add(s):n.done()});n.push(e)}),wi.waitFor(n).next(()=>this.vn(t,o))}getAllMutationBatchesAffectingQuery(e,t){const a=t.path,o=a.length+1,n=Bi(this.userId,a),r=IDBKeyRange.lowerBound(n);let u=new ms(Xr);return vc(e).Y({range:r},(e,t,n)=>{var[r,i,s]=e,i=Pi(i);r===this.userId&&a.isPrefixOf(i)?i.length===o&&(u=u.add(s)):n.done()}).next(()=>this.vn(e,u))}vn(t,e){const n=[],r=[];return e.forEach(e=>{r.push(yc(t).get(e).next(e=>{if(null===e)throw Pr();Vr(e.userId===this.userId),n.push(Du(this.serializer,e))}))}),wi.waitFor(r).next(()=>n)}removeMutationBatch(t,n){return fc(t.ae,this.userId,n).next(e=>(t.addOnCommittedListener(()=>{this.Fn(n.batchId)}),wi.forEach(e,e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))}Fn(e){delete this.Dn[e]}performConsistencyCheck(n){return this.checkEmpty(n).next(e=>{if(!e)return wi.resolve();const t=IDBKeyRange.lowerBound([this.userId]),r=[];return vc(n).Y({range:t},(e,t,n)=>{if(e[0]===this.userId){const t=Pi(e[1]);r.push(t)}else n.done()}).next(()=>{Vr(0===r.length)})})}containsKey(e,t){return pc(e,this.userId,t)}Mn(e){return wc(e).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}}function pc(e,s,t){const n=Bi(s,t.path),a=n[1],r=IDBKeyRange.lowerBound(n);let o=!1;return vc(e).Y({range:r,J:!0},(e,t,n)=>{var[r,i]=e;r===s&&i===a&&(o=!0),n.done()}).next(()=>o)}function yc(e){return us(e,"mutations")}function vc(e){return us(e,"documentMutations")}function wc(e){return us(e,"mutationQueues")}class _c{constructor(e){this.xn=e}next(){return this.xn+=2,this.xn}static On(){return new _c(0)}static Nn(){return new _c(-1)}}class bc{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(n){return this.Bn(n).next(e=>{const t=new _c(e.highestTargetId);return e.highestTargetId=t.next(),this.Ln(n,e).next(()=>e.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.Bn(e).next(e=>ti.fromTimestamp(new ei(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.Bn(e).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(t,n,r){return this.Bn(t).next(e=>(e.highestListenSequenceNumber=n,r&&(e.lastRemoteSnapshotVersion=r.toTimestamp()),n>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=n),this.Ln(t,e)))}addTargetData(t,n){return this.kn(t,n).next(()=>this.Bn(t).next(e=>(e.targetCount+=1,this.qn(n,e),this.Ln(t,e))))}updateTargetData(e,t){return this.kn(e,t)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next(()=>Ic(t).delete(e.targetId)).next(()=>this.Bn(t)).next(e=>(Vr(0<e.targetCount),--e.targetCount,this.Ln(t,e)))}removeTargets(r,i,s){let a=0;const o=[];return Ic(r).Y((e,t)=>{var n=Cu(t);n.sequenceNumber<=i&&null===s.get(n.targetId)&&(a++,o.push(this.removeTargetData(r,n)))}).next(()=>wi.waitFor(o)).next(()=>a)}forEachTarget(e,r){return Ic(e).Y((e,t)=>{var n=Cu(t);r(n)})}Bn(e){return Ec(e).get("targetGlobalKey").next(e=>(Vr(null!==e),e))}Ln(e,t){return Ec(e).put("targetGlobalKey",t)}kn(e,t){return Ic(e).put(Au(this.serializer,t))}qn(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.Bn(e).next(e=>e.targetCount)}getTargetData(e,i){var t=wa(i),t=IDBKeyRange.bound([t,Number.NEGATIVE_INFINITY],[t,Number.POSITIVE_INFINITY]);let s=null;return Ic(e).Y({range:t,index:"queryTargetsIndex"},(e,t,n)=>{var r=Cu(t);_a(i,r.target)&&(s=r,n.done())}).next(()=>s)}addMatchingKeys(n,e,r){const i=[],s=Tc(n);return e.forEach(e=>{var t=Oi(e.path);i.push(s.put({targetId:r,path:t})),i.push(this.referenceDelegate.addReference(n,r,e))}),wi.waitFor(i)}removeMatchingKeys(n,e,r){const i=Tc(n);return wi.forEach(e,e=>{var t=Oi(e.path);return wi.waitFor([i.delete([r,t]),this.referenceDelegate.removeReference(n,r,e)])})}removeMatchingKeysForTargetId(e,t){const n=Tc(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),r=Tc(e);let i=Wa();return r.Y({range:n,J:!0},(e,t,n)=>{var r=Pi(e[1]),r=new ai(r);i=i.add(r)}).next(()=>i)}containsKey(e,t){var n=Oi(t.path),n=IDBKeyRange.bound([n],[Zr(n)],!1,!0);let r=0;return Tc(e).Y({index:"documentTargetsIndex",J:!0,range:n},([e],t,n)=>{0!==e&&(r++,n.done())}).next(()=>0<r)}_t(e,t){return Ic(e).get(t).next(e=>e?Cu(e):null)}}function Ic(e){return us(e,"targets")}function Ec(e){return us(e,"targetGlobal")}function Tc(e){return us(e,"targetDocuments")}function Sc([e,t],[n,r]){var i=Xr(e,n);return 0===i?Xr(t,r):i}class xc{constructor(e){this.Qn=e,this.buffer=new ms(Sc),this.Kn=0}$n(){return++this.Kn}Un(e){var t=[e,this.$n()];if(this.buffer.size<this.Qn)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();Sc(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class Dc{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.Wn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Gn(6e4)}stop(){this.Wn&&(this.Wn.cancel(),this.Wn=null)}get started(){return null!==this.Wn}Gn(e){Mr("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.Wn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.Wn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){Ti(e)?Mr("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await vi(e)}await this.Gn(3e5)})}}class Cc{constructor(e,t){this.zn=e,this.params=t}calculateTargetCount(e,t){return this.zn.jn(e).next(e=>Math.floor(t/100*e))}nthSequenceNumber(e,t){if(0===t)return wi.resolve(ki._e);const n=new xc(t);return this.zn.forEachTarget(e,e=>n.Un(e.sequenceNumber)).next(()=>this.zn.Hn(e,e=>n.Un(e))).next(()=>n.maxValue)}removeTargets(e,t,n){return this.zn.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.zn.removeOrphanedDocuments(e,t)}collect(t,n){return-1===this.params.cacheSizeCollectionThreshold?(Mr("LruGarbageCollector","Garbage collection skipped; disabled"),wi.resolve(lc)):this.getCacheSize(t).next(e=>e<this.params.cacheSizeCollectionThreshold?(Mr("LruGarbageCollector",`Garbage collection skipped; Cache size ${e} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),lc):this.Jn(t,n))}getCacheSize(e){return this.zn.getCacheSize(e)}Jn(t,n){let r,i,s,a,o,u,c;const h=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next(e=>(i=e>this.params.maximumSequenceNumbersToCollect?(Mr("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${e}`),this.params.maximumSequenceNumbersToCollect):e,a=Date.now(),this.nthSequenceNumber(t,i))).next(e=>(r=e,o=Date.now(),this.removeTargets(t,r,n))).next(e=>(s=e,u=Date.now(),this.removeOrphanedDocuments(t,r))).next(e=>(c=Date.now(),Rr()<=l.DEBUG&&Mr("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${a-h}ms\n\tDetermined least recently used ${i} in `+(o-a)+"ms\n"+`\tRemoved ${s} targets in `+(u-o)+"ms\n"+`\tRemoved ${e} documents in `+(c-u)+"ms\n"+`Total Duration: ${c-h}ms`),wi.resolve({didRun:!0,sequenceNumbersCollected:i,targetsRemoved:s,documentsRemoved:e})))}}class Ac{constructor(e,t){this.db=e,this.garbageCollector=(e=this,t=t,new Cc(e,t))}jn(e){const n=this.Yn(e);return this.db.getTargetCache().getTargetCount(e).next(t=>n.next(e=>t+e))}Yn(e){let t=0;return this.Hn(e,e=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Hn(e,n){return this.Zn(e,(e,t)=>n(t))}addReference(e,t,n){return Nc(e,n)}removeReference(e,t,n){return Nc(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return Nc(e,t)}Xn(t,n){let r=!1;return wc(t).Z(e=>pc(t,e,n).next(e=>(e&&(r=!0),wi.resolve(!e)))).next(()=>r)}removeOrphanedDocuments(n,r){const i=this.db.getRemoteDocumentCache().newChangeBuffer(),s=[];let a=0;return this.Zn(n,(t,e)=>{if(e<=r){const r=this.Xn(n,t).next(e=>{if(!e)return a++,i.getEntry(n,t).next(()=>(i.removeEntry(t,ti.min()),Tc(n).delete(function(e){return[0,Oi(e.path)]}(t))))});s.push(r)}}).next(()=>wi.waitFor(s)).next(()=>i.apply(n)).next(()=>a)}removeTarget(e,t){var n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return Nc(e,t)}Zn(e,r){const t=Tc(e);let i,s=ki._e;return t.Y({index:"documentTargetsIndex"},([e],{path:t,sequenceNumber:n})=>{0===e?(s!==ki._e&&r(new ai(Pi(i)),s),s=n,i=t):s=ki._e}).next(()=>{s!==ki._e&&r(new ai(Pi(i)),s)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function Nc(e,t){return Tc(e).put((e=e.currentSequenceNumber,{targetId:0,path:Oi(t.path),sequenceNumber:e}))}class kc{constructor(){this.changes=new qa(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,Hs.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();var n=this.changes.get(t);return void 0!==n?wi.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class Rc{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return Fc(e).put(n)}removeEntry(e,t,n){return Fc(e).delete(function(e,t){const n=e.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],Tu(t),n[n.length-1]]}(t,n))}updateMetadata(t,n){return this.getMetadata(t).next(e=>(e.byteSize+=n,this.er(t,e)))}getEntry(e,n){let r=Hs.newInvalidDocument(n);return Fc(e).Y({index:"documentKeyIndex",range:IDBKeyRange.only(Pc(n))},(e,t)=>{r=this.tr(n,t)}).next(()=>r)}nr(e,n){let r={size:0,document:Hs.newInvalidDocument(n)};return Fc(e).Y({index:"documentKeyIndex",range:IDBKeyRange.only(Pc(n))},(e,t)=>{r={document:this.tr(n,t),size:gc(t)}}).next(()=>r)}getEntries(e,t){let r=Ua;return this.rr(e,t,(e,t)=>{var n=this.tr(e,t);r=r.insert(e,n)}).next(()=>r)}ir(e,t){let r=Ua,i=new ds(ai.comparator);return this.rr(e,t,(e,t)=>{var n=this.tr(e,t);r=r.insert(e,n),i=i.insert(e,gc(t))}).next(()=>({documents:r,sr:i}))}rr(e,t,i){if(t.isEmpty())return wi.resolve();let n=new ms(Bc);t.forEach(e=>n=n.add(e));const r=IDBKeyRange.bound(Pc(n.first()),Pc(n.last())),s=n.getIterator();let a=s.getNext();return Fc(e).Y({index:"documentKeyIndex",range:r},(e,t,n)=>{for(var r=ai.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);a&&Bc(a,r)<0;)i(a,null),a=s.getNext();a&&a.isEqual(r)&&(i(a,t),a=s.hasNext()?s.getNext():null),a?n.U(Pc(a)):n.done()}).next(()=>{for(;a;)i(a,null),a=s.hasNext()?s.getNext():null})}getDocumentsMatchingQuery(e,n,t,r,i){const s=n.path,a=[s.popLast().toArray(),s.lastSegment(),Tu(t.readTime),t.documentKey.path.isEmpty()?"":t.documentKey.path.lastSegment()],o=[s.popLast().toArray(),s.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return Fc(e).W(IDBKeyRange.bound(a,o,!0)).next(e=>{null==i||i.incrementDocumentReadCount(e.length);let t=Ua;for(const i of e){const e=this.tr(ai.fromSegments(i.prefixPath.concat(i.collectionGroup,i.documentId)),i);e.isFoundDocument()&&(Pa(n,e)||r.has(e.key))&&(t=t.insert(e.key,e))}return t})}getAllFromCollectionGroup(e,t,n,i){let s=Ua;var r=Vc(t,n),a=Vc(t,gi.max());return Fc(e).Y({index:"collectionGroupIndex",range:IDBKeyRange.bound(r,a,!0)},(e,t,n)=>{var r=this.tr(ai.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);s=s.insert(r.key,r),s.size===i&&n.done()}).next(()=>s)}newChangeBuffer(e){return new Lc(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(e=>e.byteSize)}getMetadata(e){return Oc(e).get("remoteDocumentGlobalKey").next(e=>(Vr(!!e),e))}er(e,t){return Oc(e).put("remoteDocumentGlobalKey",t)}tr(e,t){if(t){const e=function(e,t){let n;if(t.document)n=hu(e.ut,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=ai.fromSegments(t.noDocument.path),i=xu(t.noDocument.readTime);n=Hs.newNoDocument(e,i),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return Pr();{const e=ai.fromSegments(t.unknownDocument.path),s=xu(t.unknownDocument.version);n=Hs.newUnknownDocument(e,s)}}return t.readTime&&n.setReadTime((t=t.readTime,r=new ei(t[0],t[1]),ti.fromTimestamp(r))),n;var r}(this.serializer,t);if(!e.isNoDocument()||!e.version.isEqual(ti.min()))return e}return Hs.newInvalidDocument(e)}}function Mc(e){return new Rc(e)}class Lc extends kc{constructor(e,t){super(),this._r=e,this.trackRemovals=t,this.ar=new qa(e=>e.toString(),(e,t)=>e.isEqual(t))}applyChanges(s){const a=[];let o=0,u=new ms((e,t)=>Xr(e.canonicalString(),t.canonicalString()));return this.changes.forEach((e,t)=>{var n=this.ar.get(e);if(a.push(this._r.removeEntry(s,e,n.readTime)),t.isValidDocument()){var r=Eu(this._r.serializer,t);u=u.add(e.path.popLast());var i=gc(r);o+=i-n.size,a.push(this._r.addEntry(s,e,r))}else if(o-=n.size,this.trackRemovals){const o=Eu(this._r.serializer,t.convertToNoDocument(ti.min()));a.push(this._r.addEntry(s,e,o))}}),u.forEach(e=>{a.push(this._r.indexManager.addToCollectionParentIndex(s,e))}),a.push(this._r.updateMetadata(s,o)),wi.waitFor(a)}getFromCache(e,t){return this._r.nr(e,t).next(e=>(this.ar.set(t,{size:e.size,readTime:e.document.readTime}),e.document))}getAllFromCache(e,t){return this._r.ir(e,t).next(({documents:n,sr:e})=>(e.forEach((e,t)=>{this.ar.set(e,{size:t,readTime:n.get(e).readTime})}),n))}}function Oc(e){return us(e,"remoteDocumentGlobal")}function Fc(e){return us(e,"remoteDocumentsV14")}function Pc(e){const t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function Vc(e,t){const n=t.documentKey.path.toArray();return[e,Tu(t.readTime),n.slice(0,n.length-2),0<n.length?n[n.length-1]:""]}function Bc(e,t){var n=e.path.toArray(),r=t.path.toArray();let i=0;for(let s=0;s<n.length-2&&s<r.length-2;++s)if(i=Xr(n[s],r[s]),i)return i;return i=Xr(n.length,r.length),i||(i=Xr(n[n.length-2],r[r.length-2]),i||Xr(n[n.length-1],r[r.length-1]))}class qc{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class Uc{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(t,n){let r=null;return this.documentOverlayCache.getOverlay(t,n).next(e=>(r=e,this.remoteDocumentCache.getEntry(t,n))).next(e=>(null!==r&&yo(r.mutation,e,vs.empty(),ei.now()),e))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next(e=>this.getLocalViewOfDocuments(t,e,Wa()).next(()=>e))}getLocalViewOfDocuments(e,t,n=Wa()){const r=Ka();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,n).next(e=>{let n=Ga();return e.forEach((e,t)=>{n=n.insert(e,t.overlayedDocument)}),n}))}getOverlayedDocuments(e,t){const n=Ka();return this.populateOverlays(e,n,t).next(()=>this.computeViews(e,t,n,Wa()))}populateOverlays(e,n,t){const r=[];return t.forEach(e=>{n.has(e)||r.push(e)}),this.documentOverlayCache.getOverlays(e,r).next(e=>{e.forEach((e,t)=>{n.set(e,t)})})}computeViews(e,t,r,i){let s=Ua;const a=Ka(),o=Ka();return t.forEach((e,t)=>{const n=r.get(t.key);i.has(t.key)&&(void 0===n||n.mutation instanceof _o)?s=s.insert(t.key,t):void 0!==n?(a.set(t.key,n.mutation.getFieldMask()),yo(n.mutation,t,n.mutation.getFieldMask(),ei.now())):a.set(t.key,vs.empty())}),this.recalculateAndSaveOverlays(e,s).next(e=>(e.forEach((e,t)=>a.set(e,t)),t.forEach((e,t)=>{var n;return o.set(e,new qc(t,null!==(n=a.get(e))&&void 0!==n?n:null))}),o))}recalculateAndSaveOverlays(s,a){const o=Ka();let u=new ds((e,t)=>e-t),c=Wa();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(s,a).next(e=>{for(const r of e)r.keys().forEach(e=>{var t,n=a.get(e);null!==n&&(t=o.get(e)||vs.empty(),t=r.applyToLocalView(n,t),o.set(e,t),t=(u.get(r.batchId)||Wa()).add(e),u=u.insert(r.batchId,t))})}).next(()=>{const e=[],t=u.getReverseIterator();for(;t.hasNext();){const u=t.getNext(),n=u.key,r=u.value,i=Ka();r.forEach(e=>{var t;c.has(e)||(null!==(t=mo(a.get(e),o.get(e)))&&i.set(e,t),c=c.add(e))}),e.push(this.documentOverlayCache.saveOverlays(s,n,i))}return wi.waitFor(e)}).next(()=>o)}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next(e=>this.recalculateAndSaveOverlays(t,e))}getDocumentsMatchingQuery(e,t,n,r){return i=t,ai.isDocumentKey(i.path)&&null===i.collectionGroup&&0===i.filters.length?this.getDocumentsMatchingDocumentQuery(e,t.path):Aa(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n,r):this.getDocumentsMatchingCollectionQuery(e,t,n,r);var i}getNextDocuments(s,t,a,o){return this.remoteDocumentCache.getAllFromCollectionGroup(s,t,a,o).next(n=>{const e=0<o-n.size?this.documentOverlayCache.getOverlaysForCollectionGroup(s,t,a.largestBatchId,o-n.size):wi.resolve(Ka());let r=-1,i=n;return e.next(e=>wi.forEach(e,(t,e)=>(r<e.largestBatchId&&(r=e.largestBatchId),n.get(t)?wi.resolve():this.remoteDocumentCache.getEntry(s,t).next(e=>{i=i.insert(t,e)}))).next(()=>this.populateOverlays(s,e,n)).next(()=>this.computeViews(s,i,e,Wa())).next(e=>({batchId:r,changes:ja(e)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new ai(t)).next(e=>{let t=Ga();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t})}getDocumentsMatchingCollectionGroupQuery(r,i,s,a){const o=i.collectionGroup;let u=Ga();return this.indexManager.getCollectionParents(r,o).next(e=>wi.forEach(e,e=>{var t,n=(t=i,e=e.child(o),new Sa(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt));return this.getDocumentsMatchingCollectionQuery(r,n,s,a).next(e=>{e.forEach((e,t)=>{u=u.insert(e,t)})})}).next(()=>u))}getDocumentsMatchingCollectionQuery(t,s,n,r){let a;return this.documentOverlayCache.getOverlaysForCollection(t,s.path,n.largestBatchId).next(e=>(a=e,this.remoteDocumentCache.getDocumentsMatchingQuery(t,s,n,a,r))).next(r=>{a.forEach((e,t)=>{var n=t.getKey();null===r.get(n)&&(r=r.insert(n,Hs.newInvalidDocument(n)))});let i=Ga();return r.forEach((e,t)=>{var n=a.get(e);void 0!==n&&yo(n.mutation,t,vs.empty(),ei.now()),Pa(s,t)&&(i=i.insert(e,t))}),i})}}class zc{constructor(e){this.serializer=e,this.ur=new Map,this.cr=new Map}getBundleMetadata(e,t){return wi.resolve(this.ur.get(t))}saveBundleMetadata(e,t){return this.ur.set(t.id,{id:t.id,version:t.version,createTime:eu(t.createTime)}),wi.resolve()}getNamedQuery(e,t){return wi.resolve(this.cr.get(t))}saveNamedQuery(e,t){return this.cr.set(t.name,{name:(t=t).name,query:Nu(t.bundledQuery),readTime:eu(t.readTime)}),wi.resolve()}}class Gc{constructor(){this.overlays=new ds(ai.comparator),this.lr=new Map}getOverlay(e,t){return wi.resolve(this.overlays.get(t))}getOverlays(e,t){const n=Ka();return wi.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(n,r,e){return e.forEach((e,t)=>{this.lt(n,r,t)}),wi.resolve()}removeOverlaysForBatchId(e,t,n){const r=this.lr.get(n);return void 0!==r&&(r.forEach(e=>this.overlays=this.overlays.remove(e)),this.lr.delete(n)),wi.resolve()}getOverlaysForCollection(e,t,n){const r=Ka(),i=t.length+1,s=new ai(t.child("")),a=this.overlays.getIteratorFrom(s);for(;a.hasNext();){const e=a.getNext().value,s=e.getKey();if(!t.isPrefixOf(s.path))break;s.path.length===i&&e.largestBatchId>n&&r.set(e.getKey(),e)}return wi.resolve(r)}getOverlaysForCollectionGroup(t,e,n,r){let i=new ds((e,t)=>e-t);const s=this.overlays.getIterator();for(;s.hasNext();){const t=s.getNext().value;if(t.getKey().getCollectionGroup()===e&&t.largestBatchId>n){let e=i.get(t.largestBatchId);null===e&&(e=Ka(),i=i.insert(t.largestBatchId,e)),e.set(t.getKey(),t)}}const a=Ka(),o=i.getIterator();for(;o.hasNext()&&(o.getNext().value.forEach((e,t)=>a.set(e,t)),!(a.size()>=r)););return wi.resolve(a)}lt(e,t,n){var r=this.overlays.get(n.key);if(null!==r){const e=this.lr.get(r.largestBatchId).delete(n.key);this.lr.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new Co(t,n));let i=this.lr.get(t);void 0===i&&(i=Wa(),this.lr.set(t,i)),this.lr.set(t,i.add(n.key))}}class jc{constructor(){this.hr=new ms(Kc.Pr),this.Ir=new ms(Kc.Tr)}isEmpty(){return this.hr.isEmpty()}addReference(e,t){var n=new Kc(e,t);this.hr=this.hr.add(n),this.Ir=this.Ir.add(n)}Er(e,t){e.forEach(e=>this.addReference(e,t))}removeReference(e,t){this.dr(new Kc(e,t))}Ar(e,t){e.forEach(e=>this.removeReference(e,t))}Rr(e){const t=new ai(new ri([])),n=new Kc(t,e),r=new Kc(t,e+1),i=[];return this.Ir.forEachInRange([n,r],e=>{this.dr(e),i.push(e.key)}),i}Vr(){this.hr.forEach(e=>this.dr(e))}dr(e){this.hr=this.hr.delete(e),this.Ir=this.Ir.delete(e)}mr(e){var t=new ai(new ri([])),n=new Kc(t,e),t=new Kc(t,e+1);let r=Wa();return this.Ir.forEachInRange([n,t],e=>{r=r.add(e.key)}),r}containsKey(e){var t=new Kc(e,0),t=this.hr.firstAfterOrEqual(t);return null!==t&&e.isEqual(t.key)}}class Kc{constructor(e,t){this.key=e,this.gr=t}static Pr(e,t){return ai.comparator(e.key,t.key)||Xr(e.gr,t.gr)}static Tr(e,t){return Xr(e.gr,t.gr)||ai.comparator(e.key,t.key)}}class $c{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.pr=1,this.yr=new ms(Kc.Pr)}checkEmpty(e){return wi.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){var i=this.pr;this.pr++,0<this.mutationQueue.length&&this.mutationQueue[this.mutationQueue.length-1];var s=new xo(i,t,n,r);this.mutationQueue.push(s);for(const t of r)this.yr=this.yr.add(new Kc(t.key,i)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return wi.resolve(s)}lookupMutationBatch(e,t){return wi.resolve(this.wr(t))}getNextMutationBatchAfterBatchId(e,t){var n=this.Sr(t+1),n=n<0?0:n;return wi.resolve(this.mutationQueue.length>n?this.mutationQueue[n]:null)}getHighestUnacknowledgedBatchId(){return wi.resolve(0===this.mutationQueue.length?-1:this.pr-1)}getAllMutationBatches(e){return wi.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new Kc(t,0),r=new Kc(t,Number.POSITIVE_INFINITY),i=[];return this.yr.forEachInRange([n,r],e=>{var t=this.wr(e.gr);i.push(t)}),wi.resolve(i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let r=new ms(Xr);return t.forEach(e=>{var t=new Kc(e,0),n=new Kc(e,Number.POSITIVE_INFINITY);this.yr.forEachInRange([t,n],e=>{r=r.add(e.gr)})}),wi.resolve(this.br(r))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let i=n;ai.isDocumentKey(i)||(i=i.child(""));var s=new Kc(new ai(i),0);let a=new ms(Xr);return this.yr.forEachWhile(e=>{var t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(a=a.add(e.gr)),!0)},s),wi.resolve(this.br(a))}br(e){const n=[];return e.forEach(e=>{var t=this.wr(e);null!==t&&n.push(t)}),n}removeMutationBatch(n,r){Vr(0===this.Dr(r.batchId,"removed")),this.mutationQueue.shift();let i=this.yr;return wi.forEach(r.mutations,e=>{var t=new Kc(e.key,r.batchId);return i=i.delete(t),this.referenceDelegate.markPotentiallyOrphaned(n,e.key)}).next(()=>{this.yr=i})}Fn(e){}containsKey(e,t){var n=new Kc(t,0),n=this.yr.firstAfterOrEqual(n);return wi.resolve(t.isEqual(n&&n.key))}performConsistencyCheck(e){return this.mutationQueue.length,wi.resolve()}Dr(e,t){return this.Sr(e)}Sr(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}wr(e){var t=this.Sr(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class Qc{constructor(e){this.Cr=e,this.docs=new ds(ai.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,r=this.docs.get(n),i=r?r.size:0,s=this.Cr(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:s}),this.size+=s-i,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){var t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return wi.resolve(n?n.document.mutableCopy():Hs.newInvalidDocument(t))}getEntries(e,t){let n=Ua;return t.forEach(e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():Hs.newInvalidDocument(e))}),wi.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let i=Ua;const s=t.path,a=new ai(s.child("")),o=this.docs.getIteratorFrom(a);for(;o.hasNext();){const{key:e,value:{document:a}}=o.getNext();if(!s.isPrefixOf(e.path))break;e.path.length>s.length+1||mi(fi(a),n)<=0||(r.has(a.key)||Pa(t,a))&&(i=i.insert(a.key,a.mutableCopy()))}return wi.resolve(i)}getAllFromCollectionGroup(e,t,n,r){Pr()}vr(e,t){return wi.forEach(this.docs,e=>t(e))}newChangeBuffer(e){return new Wc(this)}getSize(e){return wi.resolve(this.size)}}class Wc extends kc{constructor(e){super(),this._r=e}applyChanges(n){const r=[];return this.changes.forEach((e,t)=>{t.isValidDocument()?r.push(this._r.addEntry(n,t)):this._r.removeEntry(e)}),wi.waitFor(r)}getFromCache(e,t){return this._r.getEntry(e,t)}getAllFromCache(e,t){return this._r.getEntries(e,t)}}class Hc{constructor(e){this.persistence=e,this.Fr=new qa(e=>wa(e),_a),this.lastRemoteSnapshotVersion=ti.min(),this.highestTargetId=0,this.Mr=0,this.Or=new jc,this.targetCount=0,this.Nr=_c.On()}forEachTarget(e,n){return this.Fr.forEach((e,t)=>n(t)),wi.resolve()}getLastRemoteSnapshotVersion(e){return wi.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return wi.resolve(this.Mr)}allocateTargetId(e){return this.highestTargetId=this.Nr.next(),wi.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.Mr&&(this.Mr=t),wi.resolve()}kn(e){this.Fr.set(e.target,e);var t=e.targetId;t>this.highestTargetId&&(this.Nr=new _c(t),this.highestTargetId=t),e.sequenceNumber>this.Mr&&(this.Mr=e.sequenceNumber)}addTargetData(e,t){return this.kn(t),this.targetCount+=1,wi.resolve()}updateTargetData(e,t){return this.kn(t),wi.resolve()}removeTargetData(e,t){return this.Fr.delete(t.target),this.Or.Rr(t.targetId),--this.targetCount,wi.resolve()}removeTargets(n,r,i){let s=0;const a=[];return this.Fr.forEach((e,t)=>{t.sequenceNumber<=r&&null===i.get(t.targetId)&&(this.Fr.delete(e),a.push(this.removeMatchingKeysForTargetId(n,t.targetId)),s++)}),wi.waitFor(a).next(()=>s)}getTargetCount(e){return wi.resolve(this.targetCount)}getTargetData(e,t){var n=this.Fr.get(t)||null;return wi.resolve(n)}addMatchingKeys(e,t,n){return this.Or.Er(t,n),wi.resolve()}removeMatchingKeys(t,e,n){this.Or.Ar(e,n);const r=this.persistence.referenceDelegate,i=[];return r&&e.forEach(e=>{i.push(r.markPotentiallyOrphaned(t,e))}),wi.waitFor(i)}removeMatchingKeysForTargetId(e,t){return this.Or.Rr(t),wi.resolve()}getMatchingKeysForTargetId(e,t){var n=this.Or.mr(t);return wi.resolve(n)}containsKey(e,t){return wi.resolve(this.Or.containsKey(t))}}class Yc{constructor(e,t){this.Br={},this.overlays={},this.Lr=new ki(0),this.kr=!1,this.kr=!0,this.referenceDelegate=e(this),this.qr=new Hc(this),this.indexManager=new nc,this.remoteDocumentCache=(e=e=>this.referenceDelegate.Qr(e),new Qc(e)),this.serializer=new Iu(t),this.Kr=new zc(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.kr=!1,Promise.resolve()}get started(){return this.kr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new Gc,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.Br[e.toKey()];return n||(n=new $c(t,this.referenceDelegate),this.Br[e.toKey()]=n),n}getTargetCache(){return this.qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Kr}runTransaction(e,t,n){Mr("MemoryPersistence","Starting transaction:",e);const r=new Xc(this.Lr.next());return this.referenceDelegate.$r(),n(r).next(e=>this.referenceDelegate.Ur(r).next(()=>e)).toPromise().then(e=>(r.raiseOnCommittedEvent(),e))}Wr(t,n){return wi.or(Object.values(this.Br).map(e=>()=>e.containsKey(t,n)))}}class Xc extends yi{constructor(e){super(),this.currentSequenceNumber=e}}class Jc{constructor(e){this.persistence=e,this.Gr=new jc,this.zr=null}static jr(e){return new Jc(e)}get Hr(){if(this.zr)return this.zr;throw Pr()}addReference(e,t,n){return this.Gr.addReference(n,t),this.Hr.delete(n.toString()),wi.resolve()}removeReference(e,t,n){return this.Gr.removeReference(n,t),this.Hr.add(n.toString()),wi.resolve()}markPotentiallyOrphaned(e,t){return this.Hr.add(t.toString()),wi.resolve()}removeTarget(e,t){this.Gr.Rr(t.targetId).forEach(e=>this.Hr.add(e.toString()));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next(e=>{e.forEach(e=>this.Hr.add(e.toString()))}).next(()=>n.removeTargetData(e,t))}$r(){this.zr=new Set}Ur(n){const r=this.persistence.getRemoteDocumentCache().newChangeBuffer();return wi.forEach(this.Hr,e=>{const t=ai.fromPath(e);return this.Jr(n,t).next(e=>{e||r.removeEntry(t,ti.min())})}).next(()=>(this.zr=null,r.apply(n)))}updateLimboDocument(e,t){return this.Jr(e,t).next(e=>{e?this.Hr.delete(t.toString()):this.Hr.add(t.toString())})}Qr(e){return 0}Jr(e,t){return wi.or([()=>wi.resolve(this.Gr.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Wr(e,t)])}}class Zc{constructor(e){this.serializer=e}N(t,e,n,r){const i=new _i("createOrUpgrade",e);var s;n<1&&1<=r&&(t.createObjectStore("owner"),(s=t).createObjectStore("mutationQueues",{keyPath:"userId"}),s.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Vi,{unique:!0}),s.createObjectStore("documentMutations"),eh(t),t.createObjectStore("remoteDocuments"));let a=wi.resolve();return n<3&&3<=r&&(0!==n&&((s=t).deleteObjectStore("targetDocuments"),s.deleteObjectStore("targets"),s.deleteObjectStore("targetGlobal"),eh(t)),a=a.next(()=>function(e){const t=e.store("targetGlobal"),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:ti.min().toTimestamp(),targetCount:0};return t.put("targetGlobalKey",n)}(i))),n<4&&4<=r&&(0!==n&&(a=a.next(()=>function(r,i){return i.store("mutations").W().next(e=>{r.deleteObjectStore("mutations"),r.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Vi,{unique:!0});const t=i.store("mutations"),n=e.map(e=>t.put(e));return wi.waitFor(n)})}(t,i))),a=a.next(()=>{t.createObjectStore("clientMetadata",{keyPath:"clientId"})})),n<5&&5<=r&&(a=a.next(()=>this.Zr(i))),n<6&&6<=r&&(a=a.next(()=>(function(e){e.createObjectStore("remoteDocumentGlobal")}(t),this.Xr(i)))),n<7&&7<=r&&(a=a.next(()=>this.ei(i))),n<8&&8<=r&&(a=a.next(()=>this.ti(t,i))),n<9&&9<=r&&(a=a.next(()=>{var e;(e=t).objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")})),n<10&&10<=r&&(a=a.next(()=>this.ni(i))),n<11&&11<=r&&(a=a.next(()=>{t.createObjectStore("bundles",{keyPath:"bundleId"}),t.createObjectStore("namedQueries",{keyPath:"name"})})),n<12&&12<=r&&(a=a.next(()=>{!function(e){const t=e.createObjectStore("documentOverlays",{keyPath:Zi});t.createIndex("collectionPathOverlayIndex",es,{unique:!1}),t.createIndex("collectionGroupOverlayIndex",ts,{unique:!1})}(t)})),n<13&&13<=r&&(a=a.next(()=>function(e){const t=e.createObjectStore("remoteDocumentsV14",{keyPath:zi});t.createIndex("documentKeyIndex",Gi),t.createIndex("collectionGroupIndex",ji)}(t)).next(()=>this.ri(t,i)).next(()=>t.deleteObjectStore("remoteDocuments"))),n<14&&14<=r&&(a=a.next(()=>this.ii(t,i))),n<15&&15<=r&&(a=a.next(()=>function(e){e.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),e.createObjectStore("indexState",{keyPath:Hi}).createIndex("sequenceNumberIndex",Yi,{unique:!1}),e.createObjectStore("indexEntries",{keyPath:Xi}).createIndex("documentKeyIndex",Ji,{unique:!1})}(t))),a}Xr(t){let n=0;return t.store("remoteDocuments").Y((e,t)=>{n+=gc(t)}).next(()=>{var e={byteSize:n};return t.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",e)})}Zr(r){const e=r.store("mutationQueues"),t=r.store("mutations");return e.W().next(e=>wi.forEach(e,n=>{var e=IDBKeyRange.bound([n.userId,-1],[n.userId,n.lastAcknowledgedBatchId]);return t.W("userMutationsIndex",e).next(e=>wi.forEach(e,e=>{Vr(e.userId===n.userId);var t=Du(this.serializer,e);return fc(r,n.userId,t).next(()=>{})}))}))}ei(e){const a=e.store("targetDocuments"),t=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next(i=>{const s=[];return t.Y((e,t)=>{const n=new ri(e),r=[0,Oi(n)];s.push(a.get(r).next(e=>e?wi.resolve():(e=>a.put({targetId:0,path:Oi(e),sequenceNumber:i.highestListenSequenceNumber}))(n)))}).next(()=>wi.waitFor(s))})}ti(e,t){e.createObjectStore("collectionParents",{keyPath:Wi});const n=t.store("collectionParents"),r=new rc,i=e=>{if(r.add(e)){const t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:Oi(r)})}};return t.store("remoteDocuments").Y({J:!0},(e,t)=>{const n=new ri(e);return i(n.popLast())}).next(()=>t.store("documentMutations").Y({J:!0},([,e],t)=>{const n=Pi(e);return i(n.popLast())}))}ni(e){const r=e.store("targets");return r.Y((e,t)=>{var n=Cu(t),n=Au(this.serializer,n);return r.put(n)})}ri(e,a){const t=a.store("remoteDocuments"),o=[];return t.Y((e,t)=>{const n=a.store("remoteDocumentsV14"),r=((s=t).document?new ai(ri.fromString(s.document.name).popFirst(5)):s.noDocument?ai.fromSegments(s.noDocument.path):s.unknownDocument?ai.fromSegments(s.unknownDocument.path):Pr()).path.toArray(),i={prefixPath:r.slice(0,r.length-2),collectionGroup:r[r.length-2],documentId:r[r.length-1],readTime:t.readTime||[0,0],unknownDocument:t.unknownDocument,noDocument:t.noDocument,document:t.document,hasCommittedMutations:!!t.hasCommittedMutations};var s;o.push(n.put(i))}).next(()=>wi.waitFor(o))}ii(e,s){const t=s.store("mutations"),a=Mc(this.serializer),o=new Yc(Jc.jr,this.serializer.ut);return t.W().next(e=>{const r=new Map;return e.forEach(e=>{var t;let n=null!==(t=r.get(e.userId))&&void 0!==t?t:Wa();Du(this.serializer,e).keys().forEach(e=>n=n.add(e)),r.set(e.userId,n)}),wi.forEach(r,(e,t)=>{var n=new Ar(t),r=Pu.ct(this.serializer,n),i=o.getIndexManager(n),n=mc.ct(n,this.serializer,i,o.referenceDelegate);return new Uc(a,n,r,i).recalculateAndSaveOverlaysForDocumentKeys(new os(s,ki._e),e).next()})})}}function eh(e){e.createObjectStore("targetDocuments",{keyPath:$i}).createIndex("documentTargetsIndex",Qi,{unique:!0}),e.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",Ki,{unique:!0}),e.createObjectStore("targetGlobal")}const th="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class nh{constructor(e,t,n,r,i,s,a,o,u,c,h=15){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.si=i,this.window=s,this.document=a,this.oi=u,this._i=c,this.ai=h,this.Lr=null,this.kr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.ui=null,this.inForeground=!1,this.ci=null,this.li=null,this.hi=Number.NEGATIVE_INFINITY,this.Pi=e=>Promise.resolve(),!nh.D())throw new qr(Br.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Ac(this,r),this.Ii=t+"main",this.serializer=new Iu(o),this.Ti=new bi(this.Ii,this.ai,new Zc(this.serializer)),this.qr=new bc(this.referenceDelegate,this.serializer),this.remoteDocumentCache=Mc(this.serializer),this.Kr=new Lu,this.window&&this.window.localStorage?this.Ei=this.window.localStorage:(this.Ei=null,!1===c&&Lr("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.di().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new qr(Br.FAILED_PRECONDITION,th);return this.Ai(),this.Ri(),this.Vi(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.qr.getHighestSequenceNumber(e))}).then(e=>{this.Lr=new ki(e,this.oi)}).then(()=>{this.kr=!0}).catch(e=>(this.Ti&&this.Ti.close(),Promise.reject(e)))}mi(t){return this.Pi=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.Ti.L(async e=>{null===e.newVersion&&await t()})}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.si.enqueueAndForget(async()=>{this.started&&await this.di()}))}di(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",t=>ih(t).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.fi(t).next(e=>{e||(this.isPrimary=!1,this.si.enqueueRetryable(()=>this.Pi(!1)))})}).next(()=>this.gi(t)).next(e=>this.isPrimary&&!e?this.pi(t).next(()=>!1):!!e&&this.yi(t).next(()=>!0))).catch(e=>{if(Ti(e))return Mr("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return Mr("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.si.enqueueRetryable(()=>this.Pi(e)),this.isPrimary=e})}fi(e){return rh(e).get("owner").next(e=>wi.resolve(this.wi(e)))}Si(e){return ih(e).delete(this.clientId)}async bi(){if(this.isPrimary&&!this.Di(this.hi,18e5)){this.hi=Date.now();var e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{const r=us(e,"clientMetadata");return r.W().next(e=>{const t=this.Ci(e,18e5),n=e.filter(e=>-1===t.indexOf(e));return wi.forEach(n,e=>r.delete(e.clientId)).next(()=>n)})}).catch(()=>[]);if(this.Ei)for(const t of e)this.Ei.removeItem(this.vi(t.clientId))}}Vi(){this.li=this.si.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.di().then(()=>this.bi()).then(()=>this.Vi()))}wi(e){return!!e&&e.ownerId===this.clientId}gi(t){return this._i?wi.resolve(!0):rh(t).get("owner").next(e=>{if(null!==e&&this.Di(e.leaseTimestampMs,5e3)&&!this.Fi(e.ownerId)){if(this.wi(e)&&this.networkEnabled)return!0;if(!this.wi(e)){if(!e.allowTabSynchronization)throw new qr(Br.FAILED_PRECONDITION,th);return!1}}return!(!this.networkEnabled||!this.inForeground)||ih(t).W().next(e=>void 0===this.Ci(e,5e3).find(e=>{if(this.clientId!==e.clientId){var t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))}).next(e=>(this.isPrimary!==e&&Mr("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}async shutdown(){this.kr=!1,this.Mi(),this.li&&(this.li.cancel(),this.li=null),this.xi(),this.Oi(),await this.Ti.runTransaction("shutdown","readwrite",["owner","clientMetadata"],e=>{const t=new os(e,ki._e);return this.pi(t).next(()=>this.Si(t))}),this.Ti.close(),this.Ni()}Ci(e,t){return e.filter(e=>this.Di(e.updateTimeMs,t)&&!this.Fi(e.clientId))}Bi(){return this.runTransaction("getActiveClients","readonly",e=>ih(e).W().next(e=>this.Ci(e,18e5).map(e=>e.clientId)))}get started(){return this.kr}getMutationQueue(e,t){return mc.ct(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new sc(e,this.serializer.ut.databaseId)}getDocumentOverlayCache(e){return Pu.ct(this.serializer,e)}getBundleCache(){return this.Kr}runTransaction(t,n,r){Mr("IndexedDbPersistence","Starting transaction:",t);var e,i="readonly"===n?"readonly":"readwrite",s=15===(e=this.ai)?as:14===e?ss:13===e?is:12===e?rs:11===e?ns:void Pr();let a;return this.Ti.runTransaction(t,i,s,e=>(a=new os(e,this.Lr?this.Lr.next():ki._e),"readwrite-primary"===n?this.fi(a).next(e=>!!e||this.gi(a)).next(e=>{if(!e)throw Lr(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.si.enqueueRetryable(()=>this.Pi(!1)),new qr(Br.FAILED_PRECONDITION,pi);return r(a)}).next(e=>this.yi(a).next(()=>e)):this.Li(a).next(()=>r(a)))).then(e=>(a.raiseOnCommittedEvent(),e))}Li(e){return rh(e).get("owner").next(e=>{if(null!==e&&this.Di(e.leaseTimestampMs,5e3)&&!this.Fi(e.ownerId)&&!this.wi(e)&&!(this._i||this.allowTabSynchronization&&e.allowTabSynchronization))throw new qr(Br.FAILED_PRECONDITION,th)})}yi(e){var t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return rh(e).put("owner",t)}static D(){return bi.D()}pi(e){const t=rh(e);return t.get("owner").next(e=>this.wi(e)?(Mr("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):wi.resolve())}Di(e,t){var n=Date.now();return!(e<n-t||n<e&&(Lr(`Detected an update time that is in the future: ${e} > ${n}`),1))}Ai(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.ci=()=>{this.si.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.di()))},this.document.addEventListener("visibilitychange",this.ci),this.inForeground="visible"===this.document.visibilityState)}xi(){this.ci&&(this.document.removeEventListener("visibilitychange",this.ci),this.ci=null)}Ri(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.ui=()=>{this.Mi();var e=/(?:Version|Mobile)\/1[456]/;h()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.si.enterRestrictedMode(!0),this.si.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.ui))}Oi(){this.ui&&(this.window.removeEventListener("pagehide",this.ui),this.ui=null)}Fi(e){var t;try{var n=null!==(null===(t=this.Ei)||void 0===t?void 0:t.getItem(this.vi(e)));return Mr("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return Lr("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}Mi(){if(this.Ei)try{this.Ei.setItem(this.vi(this.clientId),String(Date.now()))}catch(e){Lr("Failed to set zombie client id.",e)}}Ni(){if(this.Ei)try{this.Ei.removeItem(this.vi(this.clientId))}catch(e){}}vi(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function rh(e){return us(e,"owner")}function ih(e){return us(e,"clientMetadata")}function sh(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class ah{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.ki=n,this.qi=r}static Qi(e,t){let n=Wa(),r=Wa();for(const e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new ah(e,t.fromCache,n,r)}}class oh{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class uh{constructor(){this.Ki=!1,this.$i=!1,this.Ui=100,this.Wi=8}initialize(e,t){this.Gi=e,this.indexManager=t,this.Ki=!0}getDocumentsMatchingQuery(n,r,e,t){const i={result:null};return this.zi(n,r).next(e=>{i.result=e}).next(()=>{if(!i.result)return this.ji(n,r,t,e).next(e=>{i.result=e})}).next(()=>{if(!i.result){const t=new oh;return this.Hi(n,r,t).next(e=>{if(i.result=e,this.$i)return this.Ji(n,r,t,e.size)})}}).next(()=>i.result)}Ji(e,t,n,r){return n.documentReadCount<this.Ui?(Rr()<=l.DEBUG&&Mr("QueryEngine","SDK will not create cache indexes for query:",Fa(t),"since it only creates cache indexes for collection contains","more than or equal to",this.Ui,"documents"),wi.resolve()):(Rr()<=l.DEBUG&&Mr("QueryEngine","Query:",Fa(t),"scans",n.documentReadCount,"local documents and returns",r,"documents as results."),n.documentReadCount>this.Wi*r?(Rr()<=l.DEBUG&&Mr("QueryEngine","The SDK decides to create cache indexes for query:",Fa(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,ka(t))):wi.resolve())}zi(i,s){if(Ca(s))return wi.resolve(null);let t=ka(s);return this.indexManager.getIndexType(i,t).next(e=>0===e?null:(null!==s.limit&&1===e&&(s=Ma(s,null,"F"),t=ka(s)),this.indexManager.getDocumentsMatchingTarget(i,t).next(e=>{const r=Wa(...e);return this.Gi.getDocuments(i,r).next(n=>this.indexManager.getMinOffset(i,t).next(e=>{var t=this.Yi(s,n);return this.Zi(s,t,r,e.readTime)?this.zi(i,Ma(s,null,"F")):this.Xi(i,t,s,e)}))})))}ji(n,r,i,s){return Ca(r)||s.isEqual(ti.min())?wi.resolve(null):this.Gi.getDocuments(n,i).next(e=>{var t=this.Yi(r,e);return this.Zi(r,t,i,s)?wi.resolve(null):(Rr()<=l.DEBUG&&Mr("QueryEngine","Re-using previous result from %s to execute query: %s",s.toString(),Fa(r)),this.Xi(n,t,r,di(s,-1)).next(e=>e))})}Yi(n,e){let r=new ms(Ba(n));return e.forEach((e,t)=>{Pa(n,t)&&(r=r.add(t))}),r}Zi(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const i="F"===e.limitType?t.last():t.first();return!!i&&(i.hasPendingWrites||0<i.version.compareTo(r))}Hi(e,t,n){return Rr()<=l.DEBUG&&Mr("QueryEngine","Using full collection scan to execute query:",Fa(t)),this.Gi.getDocumentsMatchingQuery(e,t,gi.min(),n)}Xi(e,n,t,r){return this.Gi.getDocumentsMatchingQuery(e,t,r).next(t=>(n.forEach(e=>{t=t.insert(e.key,e)}),t))}}class ch{constructor(e,t,n,r){this.persistence=e,this.es=t,this.serializer=r,this.ts=new ds(Xr),this.ns=new qa(e=>wa(e),_a),this.rs=new Map,this.ss=e.getRemoteDocumentCache(),this.qr=e.getTargetCache(),this.Kr=e.getBundleCache(),this.os(n)}os(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new Uc(this.ss,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.ss.setIndexManager(this.indexManager),this.es.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",e=>t.collect(e,this.ts))}}function hh(e,t,n,r){return new ch(e,t,n,r)}async function lh(e,t){const a=e;return a.persistence.runTransaction("Handle user change","readonly",i=>{let s;return a.mutationQueue.getAllMutationBatches(i).next(e=>(s=e,a.os(t),a.mutationQueue.getAllMutationBatches(i))).next(e=>{const t=[],n=[];let r=Wa();for(const i of s){t.push(i.batchId);for(const e of i.mutations)r=r.add(e.key)}for(const i of e){n.push(i.batchId);for(const e of i.mutations)r=r.add(e.key)}return a.localDocuments.getDocuments(i,r).next(e=>({_s:e,removedBatchIds:t,addedBatchIds:n}))})})}function dh(e){const t=e;return t.persistence.runTransaction("Get last remote snapshot version","readonly",e=>t.qr.getLastRemoteSnapshotVersion(e))}function fh(e,c){const h=e,l=c.snapshotVersion;let d=h.ts;return h.persistence.runTransaction("Apply remote event","readwrite-primary",o=>{const e=h.ss.newChangeBuffer({trackRemovals:!0});d=h.ts;const u=[];c.targetChanges.forEach((t,n)=>{const r=d.get(n);if(r){u.push(h.qr.removeMatchingKeys(o,t.removedDocuments,n).next(()=>h.qr.addMatchingKeys(o,t.addedDocuments,n)));let e=r.withSequenceNumber(o.currentSequenceNumber);var i,s,a;null!==c.targetMismatches.get(n)?e=e.withResumeToken(_s.EMPTY_BYTE_STRING,ti.min()).withLastLimboFreeSnapshotVersion(ti.min()):0<t.resumeToken.approximateByteSize()&&(e=e.withResumeToken(t.resumeToken,l)),d=d.insert(n,e),i=r,s=e,a=t,0!==i.resumeToken.approximateByteSize()&&!(3e8<=s.snapshotVersion.toMicroseconds()-i.snapshotVersion.toMicroseconds()||0<a.addedDocuments.size+a.modifiedDocuments.size+a.removedDocuments.size)||u.push(h.qr.updateTargetData(o,e))}});let t=Ua,n=Wa();if(c.documentUpdates.forEach(e=>{c.resolvedLimboDocuments.has(e)&&u.push(h.persistence.referenceDelegate.updateLimboDocument(o,e))}),u.push(gh(o,e,c.documentUpdates).next(e=>{t=e.us,n=e.cs})),!l.isEqual(ti.min())){const c=h.qr.getLastRemoteSnapshotVersion(o).next(e=>h.qr.setTargetsMetadata(o,o.currentSequenceNumber,l));u.push(c)}return wi.waitFor(u).next(()=>e.apply(o)).next(()=>h.localDocuments.getLocalViewOfDocuments(o,t,n)).next(()=>t)}).then(e=>(h.ts=d,e))}function gh(e,s,t){let n=Wa(),a=Wa();return t.forEach(e=>n=n.add(e)),s.getEntries(e,n).next(r=>{let i=Ua;return t.forEach((e,t)=>{const n=r.get(e);t.isFoundDocument()!==n.isFoundDocument()&&(a=a.add(e)),t.isNoDocument()&&t.version.isEqual(ti.min())?(s.removeEntry(e,t.readTime),i=i.insert(e,t)):!n.isValidDocument()||0<t.version.compareTo(n.version)||0===t.version.compareTo(n.version)&&n.hasPendingWrites?(s.addEntry(t),i=i.insert(e,t)):Mr("LocalStore","Ignoring outdated watch update for ",e,". Current version:",n.version," Watch version:",t.version)}),{us:i,cs:a}})}function mh(e,r){const i=e;return i.persistence.runTransaction("Allocate target","readwrite",t=>{let n;return i.qr.getTargetData(t,r).next(e=>e?(n=e,wi.resolve(n)):i.qr.allocateTargetId(t).next(e=>(n=new bu(r,e,"TargetPurposeListen",t.currentSequenceNumber),i.qr.addTargetData(t,n).next(()=>n))))}).then(e=>{var t=i.ts.get(e.targetId);return(null===t||0<e.snapshotVersion.compareTo(t.snapshotVersion))&&(i.ts=i.ts.insert(e.targetId,e),i.ns.set(r,e.targetId)),e})}async function ph(e,t,n){const r=e,i=r.ts.get(t),s=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",s,e=>r.persistence.referenceDelegate.removeTarget(e,i))}catch(e){if(!Ti(e))throw e;Mr("LocalStore",`Failed to update sequence numbers for target ${t}: ${e}`)}r.ts=r.ts.remove(t),r.ns.delete(i.target)}function yh(e,n,r){const i=e;let s=ti.min(),a=Wa();return i.persistence.runTransaction("Execute query","readwrite",t=>function(e,t,n){const r=e,i=r.ns.get(n);return void 0!==i?wi.resolve(r.ts.get(i)):r.qr.getTargetData(t,n)}(i,t,ka(n)).next(e=>{if(e)return s=e.lastLimboFreeSnapshotVersion,i.qr.getMatchingKeysForTargetId(t,e.targetId).next(e=>{a=e})}).next(()=>i.es.getDocumentsMatchingQuery(t,n,r?s:ti.min(),r?a:Wa())).next(e=>(_h(i,Va(n),e),{documents:e,ls:a})))}function vh(e,t){const n=e,r=n.qr,i=n.ts.get(t);return i?Promise.resolve(i.target):n.persistence.runTransaction("Get target data","readonly",e=>r._t(e,t).next(e=>e?e.target:null))}function wh(e,t){const n=e,r=n.rs.get(t)||ti.min();return n.persistence.runTransaction("Get new document changes","readonly",e=>n.ss.getAllFromCollectionGroup(e,t,di(r,-1),Number.MAX_SAFE_INTEGER)).then(e=>(_h(n,t,e),e))}function _h(e,t,n){let r=e.rs.get(t)||ti.min();n.forEach((e,t)=>{0<t.readTime.compareTo(r)&&(r=t.readTime)}),e.rs.set(t,r)}function bh(e,t){return`firestore_clients_${e}_${t}`}function Ih(e,t,n){let r=`firestore_mutations_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}function Eh(e,t){return`firestore_targets_${e}_${t}`}class Th{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Ts(e,t,n){var r=JSON.parse(n);let i,s="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return s&&r.error&&(s="string"==typeof r.error.message&&"string"==typeof r.error.code,s&&(i=new qr(r.error.code,r.error.message))),s?new Th(e,t,r.state,i):(Lr("SharedClientState",`Failed to parse mutation state for ID '${t}': ${n}`),null)}Es(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class Sh{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Ts(e,t){var n=JSON.parse(t);let r,i="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return i&&n.error&&(i="string"==typeof n.error.message&&"string"==typeof n.error.code,i&&(r=new qr(n.error.code,n.error.message))),i?new Sh(e,n.state,r):(Lr("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}Es(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class xh{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Ts(e,t){var n=JSON.parse(t);let r="object"==typeof n&&n.activeTargetIds instanceof Array,i=Ha;for(let s=0;r&&s<n.activeTargetIds.length;++s)r=Li(n.activeTargetIds[s]),i=i.add(n.activeTargetIds[s]);return r?new xh(e,i):(Lr("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}}class Dh{constructor(e,t){this.clientId=e,this.onlineState=t}static Ts(e){var t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new Dh(t.clientId,t.onlineState):(Lr("SharedClientState",`Failed to parse online state: ${e}`),null)}}class Ch{constructor(){this.activeTargetIds=Ha}ds(e){this.activeTargetIds=this.activeTargetIds.add(e)}As(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Es(){var e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class Ah{constructor(e,t,n,r,i){this.window=e,this.si=t,this.persistenceKey=n,this.Rs=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.Vs=this.fs.bind(this),this.gs=new ds(Xr),this.started=!1,this.ps=[];var s=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=i,this.ys=bh(this.persistenceKey,this.Rs),this.ws=`firestore_sequence_number_${this.persistenceKey}`,this.gs=this.gs.insert(this.Rs,new Ch),this.Ss=new RegExp(`^firestore_clients_${s}_([^_]*)$`),this.bs=new RegExp(`^firestore_mutations_${s}_(\\d+)(?:_(.*))?$`),this.Ds=new RegExp(`^firestore_targets_${s}_(\\d+)$`),this.Cs=`firestore_online_state_${this.persistenceKey}`,this.vs=`firestore_bundle_loaded_v2_${this.persistenceKey}`,this.window.addEventListener("storage",this.Vs)}static D(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.Bi();for(const n of e)if(n!==this.Rs){const e=this.getItem(bh(this.persistenceKey,n));var t;!e||(t=xh.Ts(n,e))&&(this.gs=this.gs.insert(t.clientId,t))}this.Fs();const n=this.storage.getItem(this.Cs);if(n){const e=this.Ms(n);e&&this.xs(e)}for(const e of this.ps)this.fs(e);this.ps=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(e){this.setItem(this.ws,JSON.stringify(e))}getAllActiveQueryTargets(){return this.Os(this.gs)}isActiveQueryTarget(n){let r=!1;return this.gs.forEach((e,t)=>{t.activeTargetIds.has(n)&&(r=!0)}),r}addPendingMutation(e){this.Ns(e,"pending")}updateMutationState(e,t,n){this.Ns(e,t,n),this.Bs(e)}addLocalQueryTarget(e){let t="not-current";var n;return this.isActiveQueryTarget(e)&&(!(n=this.storage.getItem(Eh(this.persistenceKey,e)))||(n=Sh.Ts(e,n))&&(t=n.state)),this.Ls.ds(e),this.Fs(),t}removeLocalQueryTarget(e){this.Ls.As(e),this.Fs()}isLocalQueryTarget(e){return this.Ls.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(Eh(this.persistenceKey,e))}updateQueryState(e,t,n){this.ks(e,t,n)}handleUserChange(e,t,n){t.forEach(e=>{this.Bs(e)}),this.currentUser=e,n.forEach(e=>{this.addPendingMutation(e)})}setOnlineState(e){this.qs(e)}notifyBundleLoaded(e){this.Qs(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.Vs),this.removeItem(this.ys),this.started=!1)}getItem(e){var t=this.storage.getItem(e);return Mr("SharedClientState","READ",e,t),t}setItem(e,t){Mr("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){Mr("SharedClientState","REMOVE",e),this.storage.removeItem(e)}fs(e){const i=e;i.storageArea===this.storage&&(Mr("SharedClientState","EVENT",i.key,i.newValue),i.key!==this.ys?this.si.enqueueRetryable(async()=>{if(this.started){if(null!==i.key)if(this.Ss.test(i.key)){if(null==i.newValue){var e=this.Ks(i.key);return this.$s(e,null)}e=this.Us(i.key,i.newValue);if(e)return this.$s(e.clientId,e)}else if(this.bs.test(i.key)){if(null!==i.newValue){var t=this.Ws(i.key,i.newValue);if(t)return this.Gs(t)}}else if(this.Ds.test(i.key)){if(null!==i.newValue){t=this.zs(i.key,i.newValue);if(t)return this.js(t)}}else if(i.key===this.Cs){if(null!==i.newValue){var n=this.Ms(i.newValue);if(n)return this.xs(n)}}else if(i.key===this.ws){n=function(e){let t=ki._e;if(null!=e)try{var n=JSON.parse(e);Vr("number"==typeof n),t=n}catch(e){Lr("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(i.newValue);n!==ki._e&&this.sequenceNumberHandler(n)}else if(i.key===this.vs){const r=this.Hs(i.newValue);await Promise.all(r.map(e=>this.syncEngine.Js(e)))}}else this.ps.push(i)}):Lr("Received WebStorage notification for local change. Another client might have garbage-collected our state"))}get Ls(){return this.gs.get(this.Rs)}Fs(){this.setItem(this.ys,this.Ls.Es())}Ns(e,t,n){const r=new Th(this.currentUser,e,t,n),i=Ih(this.persistenceKey,this.currentUser,e);this.setItem(i,r.Es())}Bs(e){var t=Ih(this.persistenceKey,this.currentUser,e);this.removeItem(t)}qs(e){var t={clientId:this.Rs,onlineState:e};this.storage.setItem(this.Cs,JSON.stringify(t))}ks(e,t,n){const r=Eh(this.persistenceKey,e),i=new Sh(e,t,n);this.setItem(r,i.Es())}Qs(e){var t=JSON.stringify(Array.from(e));this.setItem(this.vs,t)}Ks(e){var t=this.Ss.exec(e);return t?t[1]:null}Us(e,t){var n=this.Ks(e);return xh.Ts(n,t)}Ws(e,t){var n=this.bs.exec(e),r=Number(n[1]),n=void 0!==n[2]?n[2]:null;return Th.Ts(new Ar(n),r,t)}zs(e,t){var n=this.Ds.exec(e),n=Number(n[1]);return Sh.Ts(n,t)}Ms(e){return Dh.Ts(e)}Hs(e){return JSON.parse(e)}async Gs(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.Ys(e.batchId,e.state,e.error);Mr("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)}js(e){return this.syncEngine.Zs(e.targetId,e.state,e.error)}$s(e,t){const n=t?this.gs.insert(e,t):this.gs.remove(e),r=this.Os(this.gs),i=this.Os(n),s=[],a=[];return i.forEach(e=>{r.has(e)||s.push(e)}),r.forEach(e=>{i.has(e)||a.push(e)}),this.syncEngine.Xs(s,a).then(()=>{this.gs=n})}xs(e){this.gs.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}Os(e){let n=Ha;return e.forEach((e,t)=>{n=n.unionWith(t.activeTargetIds)}),n}}class Nh{constructor(){this.eo=new Ch,this.no={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.eo.ds(e),this.no[e]||"not-current"}updateQueryState(e,t,n){this.no[e]=t}removeLocalQueryTarget(e){this.eo.As(e)}isLocalQueryTarget(e){return this.eo.activeTargetIds.has(e)}clearQueryState(e){delete this.no[e]}getAllActiveQueryTargets(){return this.eo.activeTargetIds}isActiveQueryTarget(e){return this.eo.activeTargetIds.has(e)}start(){return this.eo=new Ch,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class kh{ro(e){}shutdown(){}}class Rh{constructor(){this.io=()=>this.so(),this.oo=()=>this._o(),this.ao=[],this.uo()}ro(e){this.ao.push(e)}shutdown(){window.removeEventListener("online",this.io),window.removeEventListener("offline",this.oo)}uo(){window.addEventListener("online",this.io),window.addEventListener("offline",this.oo)}so(){Mr("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.ao)e(0)}_o(){Mr("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.ao)e(1)}static D(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let Mh=null;function Lh(){return null===Mh?Mh=268435456+Math.round(2147483648*Math.random()):Mh++,"0x"+Mh.toString(16)}const Oh={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class Fh{constructor(e){this.co=e.co,this.lo=e.lo}ho(e){this.Po=e}Io(e){this.To=e}onMessage(e){this.Eo=e}close(){this.lo()}send(e){this.co(e)}Ao(){this.Po()}Ro(e){this.To(e)}Vo(e){this.Eo(e)}}const Ph="WebChannelConnection";class Vh extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;var t=e.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),r=encodeURIComponent(this.databaseId.database);this.mo=t+"://"+e.host,this.fo=`projects/${n}/databases/${r}`,this.po="(default)"===this.databaseId.database?`project_id=${n}`:`project_id=${n}&database_id=${r}`}get yo(){return!1}wo(t,e,n,r,i){const s=Lh(),a=this.So(t,e);Mr("RestConnection",`Sending RPC '${t}' ${s}:`,a,n);var o={"google-cloud-resource-prefix":this.fo,"x-goog-request-params":this.po};return this.bo(o,r,i),this.Do(t,a,o,n).then(e=>(Mr("RestConnection",`Received RPC '${t}' ${s}: `,e),e),e=>{throw Or("RestConnection",`RPC '${t}' ${s} failed with error: `,e,"url: ",a,"request:",n),e})}Co(e,t,n,r,i,s){return this.wo(e,t,n,r,i)}bo(n,e,t){n["X-Goog-Api-Client"]="gl-js/ fire/"+Nr,n["Content-Type"]="text/plain",this.databaseInfo.appId&&(n["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach((e,t)=>n[t]=e),t&&t.headers.forEach((e,t)=>n[t]=e)}So(e,t){var n=Oh[e];return`${this.mo}/v1/${t}:${n}`}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}Do(u,t,n,r){const c=Lh();return new Promise((s,a)=>{const o=new Sr;o.setWithCredentials(!0),o.listenOnce(_r.COMPLETE,()=>{try{switch(o.getLastErrorCode()){case wr.NO_ERROR:var e=o.getResponseJson();Mr(Ph,`XHR for RPC '${u}' ${c} received:`,JSON.stringify(e)),s(e);break;case wr.TIMEOUT:Mr(Ph,`RPC '${u}' ${c} timed out`),a(new qr(Br.DEADLINE_EXCEEDED,"Request time out"));break;case wr.HTTP_ERROR:var t=o.getStatus();if(Mr(Ph,`RPC '${u}' ${c} failed with status:`,t,"response text:",o.getResponseText()),0<t){let e=o.getResponseJson();Array.isArray(e)&&(e=e[0]);var n=null==e?void 0:e.error;if(n&&n.status&&n.message){const u=(r=n.status,i=r.toLowerCase().replace(/_/g,"-"),0<=Object.values(Br).indexOf(i)?i:Br.UNKNOWN);a(new qr(u,n.message))}else a(new qr(Br.UNKNOWN,"Server responded with status "+o.getStatus()))}else a(new qr(Br.UNAVAILABLE,"Connection failed."));break;default:Pr()}}finally{Mr(Ph,`RPC '${u}' ${c} completed.`)}var r,i});var e=JSON.stringify(r);Mr(Ph,`RPC '${u}' ${c} sending request:`,r),o.send(t,"POST",e,n,15)})}vo(i,e,t){const s=Lh(),n=[this.mo,"/","google.firestore.v1.Firestore","/",i,"/channel"],r=new Qn,a=vr(),o={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;void 0!==u&&(o.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(o.useFetchStreams=!0),this.bo(o.initMessageHeaders,e,t),o.encodeInitMessageHeaders=!0;var c=n.join("");Mr(Ph,`Creating RPC '${i}' stream ${s}: ${c}`,o);const h=r.createWebChannel(c,o);let l=!1,d=!1;const f=new Fh({co:e=>{d?Mr(Ph,`Not sending because RPC '${i}' stream ${s} is closed:`,e):(l||(Mr(Ph,`Opening RPC '${i}' stream ${s} transport.`),h.open(),l=!0),Mr(Ph,`RPC '${i}' stream ${s} sending:`,e),h.send(e))},lo:()=>h.close()}),g=(e,t,n)=>{e.listen(t,e=>{try{n(e)}catch(e){setTimeout(()=>{throw e},0)}})};return g(h,Tr.EventType.OPEN,()=>{d||Mr(Ph,`RPC '${i}' stream ${s} transport opened.`)}),g(h,Tr.EventType.CLOSE,()=>{d||(d=!0,Mr(Ph,`RPC '${i}' stream ${s} transport closed`),f.Ro())}),g(h,Tr.EventType.ERROR,e=>{d||(d=!0,Or(Ph,`RPC '${i}' stream ${s} transport errored:`,e),f.Ro(new qr(Br.UNAVAILABLE,"The operation could not be completed")))}),g(h,Tr.EventType.MESSAGE,n=>{if(!d){var e=n.data[0];Vr(!!e);var r=e.error||(null===(r=e[0])||void 0===r?void 0:r.error);if(r){Mr(Ph,`RPC '${i}' stream ${s} received error:`,r);const n=r.status;let e=function(e){var t=yr[e];if(void 0!==t)return ko(t)}(n),t=r.message;void 0===e&&(e=Br.INTERNAL,t="Unknown error status: "+n+" with message "+r.message),d=!0,f.Ro(new qr(e,t)),h.close()}else Mr(Ph,`RPC '${i}' stream ${s} received:`,e),f.Vo(e)}}),g(a,br.STAT_EVENT,e=>{e.stat===Ir?Mr(Ph,`RPC '${i}' stream ${s} detected buffering proxy`):e.stat===Er&&Mr(Ph,`RPC '${i}' stream ${s} detected no buffering proxy`)}),setTimeout(()=>{f.Ao()},0),f}}function Bh(){return"undefined"!=typeof window?window:null}function qh(){return"undefined"!=typeof document?document:null}function Uh(e){return new Yo(e,!0)}class zh{constructor(e,t,n=1e3,r=1.5,i=6e4){this.si=e,this.timerId=t,this.Fo=n,this.Mo=r,this.xo=i,this.Oo=0,this.No=null,this.Bo=Date.now(),this.reset()}reset(){this.Oo=0}Lo(){this.Oo=this.xo}ko(e){this.cancel();var t=Math.floor(this.Oo+this.qo()),n=Math.max(0,Date.now()-this.Bo),r=Math.max(0,t-n);0<r&&Mr("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.Oo} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.No=this.si.enqueueAfterDelay(this.timerId,r,()=>(this.Bo=Date.now(),e())),this.Oo*=this.Mo,this.Oo<this.Fo&&(this.Oo=this.Fo),this.Oo>this.xo&&(this.Oo=this.xo)}Qo(){null!==this.No&&(this.No.skipDelay(),this.No=null)}cancel(){null!==this.No&&(this.No.cancel(),this.No=null)}qo(){return(Math.random()-.5)*this.Oo}}class Gh{constructor(e,t,n,r,i,s,a,o){this.si=e,this.Ko=n,this.$o=r,this.connection=i,this.authCredentialsProvider=s,this.appCheckCredentialsProvider=a,this.listener=o,this.state=0,this.Uo=0,this.Wo=null,this.Go=null,this.stream=null,this.zo=new zh(e,t)}jo(){return 1===this.state||5===this.state||this.Ho()}Ho(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.Jo()}async stop(){this.jo()&&await this.close(0)}Yo(){this.state=0,this.zo.reset()}Zo(){this.Ho()&&null===this.Wo&&(this.Wo=this.si.enqueueAfterDelay(this.Ko,6e4,()=>this.Xo()))}e_(e){this.t_(),this.stream.send(e)}async Xo(){if(this.Ho())return this.close(0)}t_(){this.Wo&&(this.Wo.cancel(),this.Wo=null)}n_(){this.Go&&(this.Go.cancel(),this.Go=null)}async close(e,t){this.t_(),this.n_(),this.zo.cancel(),this.Uo++,4!==e?this.zo.reset():t&&t.code===Br.RESOURCE_EXHAUSTED?(Lr(t.toString()),Lr("Using maximum backoff delay to prevent overloading the backend."),this.zo.Lo()):t&&t.code===Br.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.r_(),this.stream.close(),this.stream=null),this.state=e,await this.listener.Io(t)}r_(){}auth(){this.state=1;const e=this.i_(this.Uo),n=this.Uo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([e,t])=>{this.Uo===n&&this.s_(e,t)},t=>{e(()=>{var e=new qr(Br.UNKNOWN,"Fetching auth token failed: "+t.message);return this.o_(e)})})}s_(e,t){const n=this.i_(this.Uo);this.stream=this.__(e,t),this.stream.ho(()=>{n(()=>(this.state=2,this.Go=this.si.enqueueAfterDelay(this.$o,1e4,()=>(this.Ho()&&(this.state=3),Promise.resolve())),this.listener.ho()))}),this.stream.Io(e=>{n(()=>this.o_(e))}),this.stream.onMessage(e=>{n(()=>this.onMessage(e))})}Jo(){this.state=5,this.zo.ko(async()=>{this.state=0,this.start()})}o_(e){return Mr("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}i_(t){return e=>{this.si.enqueueAndForget(()=>this.Uo===t?e():(Mr("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class jh extends Gh{constructor(e,t,n,r,i,s){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i}__(e,t){return this.connection.vo("Listen",e,t)}onMessage(e){this.zo.reset();var t=function(e,t){let n;if("targetChange"in t){t.targetChange;var r="NO_CHANGE"===(f=t.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===f?1:"REMOVE"===f?2:"CURRENT"===f?3:"RESET"===f?4:Pr(),i=t.targetChange.targetIds||[],s=(f=t.targetChange.resumeToken,e.useProto3Json?(Vr(void 0===f||"string"==typeof f),_s.fromBase64String(f||"")):(Vr(void 0===f||f instanceof Uint8Array),_s.fromUint8Array(f||new Uint8Array))),a=t.targetChange.cause,o=a&&(o=void 0===(f=a).code?Br.UNKNOWN:ko(f.code),new qr(o,f.message||""));n=new zo(r,i,s,o||null)}else if("documentChange"in t){t.documentChange;var u=t.documentChange;u.document,u.document.name,u.document.updateTime;var s=iu(e,u.document.name),o=eu(u.document.updateTime),c=u.document.createTime?eu(u.document.createTime):ti.min(),h=new Ws({mapValue:{fields:u.document.fields}}),c=Hs.newFoundDocument(s,o,c,h),h=u.targetIds||[],u=u.removedTargetIds||[];n=new qo(h,u,c.key,c)}else if("documentDelete"in t){t.documentDelete;h=t.documentDelete;h.document;u=iu(e,h.document),c=h.readTime?eu(h.readTime):ti.min(),c=Hs.newNoDocument(u,c),h=h.removedTargetIds||[];n=new qo([],h,c.key,c)}else if("documentRemove"in t){t.documentRemove;var l=t.documentRemove;l.document;var d=iu(e,l.document),l=l.removedTargetIds||[];n=new qo([],l,d,null)}else{if(!("filter"in t))return Pr();{t.filter;const e=t.filter;e.targetId;var{count:l=0,unchangedNames:d}=e,l=new Ao(l,d),d=e.targetId;n=new Uo(d,l)}}var o,f;return n}(this.serializer,e),n=function(e){if(!("targetChange"in e))return ti.min();var t=e.targetChange;return(!t.targetIds||!t.targetIds.length)&&t.readTime?eu(t.readTime):ti.min()}(e);return this.listener.a_(t,n)}u_(e){const t={};t.database=ou(this.serializer),t.addTarget=function(e,t){let n;const r=t.target;if(n=ba(r)?{documents:fu(e,r)}:{query:gu(e,r)},n.targetId=t.targetId,0<t.resumeToken.approximateByteSize()){n.resumeToken=Zo(e,t.resumeToken);const r=Xo(e,t.expectedCount);null!==r&&(n.expectedCount=r)}else if(0<t.snapshotVersion.compareTo(ti.min())){n.readTime=Jo(e,t.snapshotVersion.toTimestamp());const r=Xo(e,t.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,e);var n,n=(this.serializer,e,null==(n=function(e){switch(e){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return Pr()}}(e.purpose))?null:{"goog-listen-tags":n});n&&(t.labels=n),this.e_(t)}c_(e){const t={};t.database=ou(this.serializer),t.removeTarget=e,this.e_(t)}}class Kh extends Gh{constructor(e,t,n,r,i,s){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i,this.l_=!1}get h_(){return this.l_}start(){this.l_=!1,this.lastStreamToken=void 0,super.start()}r_(){this.l_&&this.P_([])}__(e,t){return this.connection.vo("Write",e,t)}onMessage(e){if(Vr(!!e.streamToken),this.lastStreamToken=e.streamToken,this.l_){this.zo.reset();var t=(r=e.writeResults,i=e.commitTime,r&&0<r.length?(Vr(void 0!==i),r.map(e=>function(e,t){let n=e.updateTime?eu(e.updateTime):eu(t);return n.isEqual(ti.min())&&(n=eu(t)),new ho(n,e.transformResults||[])}(e,i))):[]),n=eu(e.commitTime);return this.listener.I_(n,t)}var r,i;return Vr(!e.writeResults||0===e.writeResults.length),this.l_=!0,this.listener.T_()}E_(){const e={};e.database=ou(this.serializer),this.e_(e)}P_(e){var t={streamToken:this.lastStreamToken,writes:e.map(e=>lu(this.serializer,e))};this.e_(t)}}class $h extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=r,this.d_=!1}A_(){if(this.d_)throw new qr(Br.FAILED_PRECONDITION,"The client has already been terminated.")}wo(n,r,i){return this.A_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([e,t])=>this.connection.wo(n,r,i,e,t)).catch(e=>{throw"FirebaseError"===e.name?(e.code===Br.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new qr(Br.UNKNOWN,e.toString())})}Co(n,r,i,s){return this.A_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([e,t])=>this.connection.Co(n,r,i,e,t,s)).catch(e=>{throw"FirebaseError"===e.name?(e.code===Br.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new qr(Br.UNKNOWN,e.toString())})}terminate(){this.d_=!0}}class Qh{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.V_=0,this.m_=null,this.f_=!0}g_(){0===this.V_&&(this.p_("Unknown"),this.m_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.m_=null,this.y_("Backend didn't respond within 10 seconds."),this.p_("Offline"),Promise.resolve())))}w_(e){"Online"===this.state?this.p_("Unknown"):(this.V_++,1<=this.V_&&(this.S_(),this.y_(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.p_("Offline")))}set(e){this.S_(),this.V_=0,"Online"===e&&(this.f_=!1),this.p_(e)}p_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}y_(e){var t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.f_?(Lr(t),this.f_=!1):Mr("OnlineStateTracker",t)}S_(){null!==this.m_&&(this.m_.cancel(),this.m_=null)}}class Wh{constructor(e,t,n,r,i){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.b_=[],this.D_=new Map,this.C_=new Set,this.v_=[],this.F_=i,this.F_.ro(e=>{n.enqueueAndForget(async()=>{rl(this)&&(Mr("RemoteStore","Restarting streams for network reachability change."),await async function(e){const t=e;t.C_.add(4),await Yh(t),t.M_.set("Unknown"),t.C_.delete(4),await Hh(t)}(this))})}),this.M_=new Qh(n,r)}}async function Hh(e){if(rl(e))for(const t of e.v_)await t(!0)}async function Yh(e){for(const t of e.v_)await t(!1)}function Xh(e,t){const n=e;n.D_.has(t.targetId)||(n.D_.set(t.targetId,t),nl(n)?tl(n):fl(n).Ho()&&Zh(n,t))}function Jh(e,t){const n=e,r=fl(n);n.D_.delete(t),r.Ho()&&el(n,t),0===n.D_.size&&(r.Ho()?r.Zo():rl(n)&&n.M_.set("Unknown"))}function Zh(e,t){var n;e.x_.Oe(t.targetId),(0<t.resumeToken.approximateByteSize()||0<t.snapshotVersion.compareTo(ti.min()))&&(n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size,t=t.withExpectedCount(n)),fl(e).u_(t)}function el(e,t){e.x_.Oe(t),fl(e).c_(t)}function tl(t){t.x_=new jo({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),_t:e=>t.D_.get(e)||null,nt:()=>t.datastore.serializer.databaseId}),fl(t).start(),t.M_.g_()}function nl(e){return rl(e)&&!fl(e).jo()&&0<e.D_.size}function rl(e){return 0===e.C_.size}function il(e){e.x_=void 0}async function sl(e,t,n){if(!Ti(t))throw t;e.C_.add(1),await Yh(e),e.M_.set("Offline"),n=n||(()=>dh(e.localStore)),e.asyncQueue.enqueueRetryable(async()=>{Mr("RemoteStore","Retrying IndexedDB access"),await n(),e.C_.delete(1),await Hh(e)})}function al(t,n){return n().catch(e=>sl(t,e,n))}async function ol(e){const t=e,n=gl(t);let r=0<t.b_.length?t.b_[t.b_.length-1].batchId:-1;for(;rl(i=t)&&i.b_.length<10;)try{const e=await function(e,t){const n=e;return n.persistence.runTransaction("Get next mutation batch","readonly",e=>(void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t)))}(t.localStore,r);if(null===e){0===t.b_.length&&n.Zo();break}r=e.batchId,function(e,t){e.b_.push(t);const n=gl(e);n.Ho()&&n.h_&&n.P_(t.mutations)}(t,e)}catch(e){await sl(t,e)}var i;ul(t)&&cl(t)}function ul(e){return rl(e)&&!gl(e).jo()&&0<e.b_.length}function cl(e){gl(e).start()}async function hl(e,t){t&&gl(e).h_&&await async function(e,t){if(No(n=t.code)&&n!==Br.ABORTED){const r=e.b_.shift();gl(e).Yo(),await al(e,()=>e.remoteSyncer.rejectFailedWrite(r.batchId,t)),await ol(e)}var n}(e,t),ul(e)&&cl(e)}async function ll(e,t){const n=e;n.asyncQueue.verifyOperationInProgress(),Mr("RemoteStore","RemoteStore received new credentials");var r=rl(n);n.C_.add(3),await Yh(n),r&&n.M_.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n.C_.delete(3),await Hh(n)}async function dl(e,t){const n=e;t?(n.C_.delete(2),await Hh(n)):(n.C_.add(2),await Yh(n),n.M_.set("Unknown"))}function fl(t){return t.O_||(t.O_=function(e,t,n){const r=e;return r.A_(),new jh(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(t.datastore,t.asyncQueue,{ho:(async function(n){n.D_.forEach((e,t)=>{Zh(n,e)})}).bind(null,t),Io:(async function(e,t){il(e),nl(e)?(e.M_.w_(t),tl(e)):e.M_.set("Unknown")}).bind(null,t),a_:(async function(e,t,n){if(e.M_.set("Online"),t instanceof zo&&2===t.state&&t.cause)try{await async function(e,t){var n=t.cause;for(const r of t.targetIds)e.D_.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.D_.delete(r),e.x_.removeTarget(r))}(e,t)}catch(n){Mr("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),await sl(e,n)}else if(t instanceof qo?e.x_.$e(t):t instanceof Uo?e.x_.Je(t):e.x_.Ge(t),!n.isEqual(ti.min()))try{const t=await dh(e.localStore);0<=n.compareTo(t)&&await function(i,r){const e=i.x_.it(r);return e.targetChanges.forEach((e,t)=>{if(0<e.resumeToken.approximateByteSize()){const n=i.D_.get(t);n&&i.D_.set(t,n.withResumeToken(e.resumeToken,r))}}),e.targetMismatches.forEach((e,t)=>{const n=i.D_.get(e);var r;n&&(i.D_.set(e,n.withResumeToken(_s.EMPTY_BYTE_STRING,n.snapshotVersion)),el(i,e),r=new bu(n.target,e,t,n.sequenceNumber),Zh(i,r))}),i.remoteSyncer.applyRemoteEvent(e)}(e,n)}catch(t){Mr("RemoteStore","Failed to raise snapshot:",t),await sl(e,t)}}).bind(null,t)}),t.v_.push(async e=>{e?(t.O_.Yo(),nl(t)?tl(t):t.M_.set("Unknown")):(await t.O_.stop(),il(t))})),t.O_}function gl(t){return t.N_||(t.N_=function(e,t,n){const r=e;return r.A_(),new Kh(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(t.datastore,t.asyncQueue,{ho:(async function(e){gl(e).E_()}).bind(null,t),Io:hl.bind(null,t),T_:(async function(e){const t=gl(e);for(const n of e.b_)t.P_(n.mutations)}).bind(null,t),I_:(async function(e,t,n){const r=e.b_.shift(),i=Do.from(r,t,n);await al(e,()=>e.remoteSyncer.applySuccessfulWrite(i)),await ol(e)}).bind(null,t)}),t.v_.push(async e=>{e?(t.N_.Yo(),await ol(t)):(await t.N_.stop(),0<t.b_.length&&(Mr("RemoteStore",`Stopping write stream with ${t.b_.length} pending writes`),t.b_=[]))})),t.N_}class ml{constructor(e,t,n,r,i){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new Ur,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(e=>{})}get promise(){return this.deferred.promise}static createAndSchedule(e,t,n,r,i){const s=Date.now()+n,a=new ml(e,t,s,r,i);return a.start(n),a}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new qr(Br.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function pl(e,t){if(Lr("AsyncQueue",`${t}: ${e}`),Ti(e))return new qr(Br.UNAVAILABLE,`${t}: ${e}`);throw e}class yl{constructor(n){this.comparator=n?(e,t)=>n(e,t)||ai.comparator(e.key,t.key):(e,t)=>ai.comparator(e.key,t.key),this.keyedMap=Ga(),this.sortedSet=new ds(this.comparator)}static emptySet(e){return new yl(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){var t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(n){this.sortedSet.inorderTraversal((e,t)=>(n(e),!1))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){var t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof yl))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const t=[];return this.forEach(e=>{t.push(e.toString())}),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(e,t){const n=new yl;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class vl{constructor(){this.B_=new ds(ai.comparator)}track(e){var t=e.doc.key,n=this.B_.get(t);!n||0!==e.type&&3===n.type?this.B_=this.B_.insert(t,e):3===e.type&&1!==n.type?this.B_=this.B_.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.B_=this.B_.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.B_=this.B_.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.B_=this.B_.remove(t):1===e.type&&2===n.type?this.B_=this.B_.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.B_=this.B_.insert(t,{type:2,doc:e.doc}):Pr()}L_(){const n=[];return this.B_.inorderTraversal((e,t)=>{n.push(t)}),n}}class wl{constructor(e,t,n,r,i,s,a,o,u){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=s,this.syncStateChanged=a,this.excludesMetadataChanges=o,this.hasCachedResults=u}static fromInitialDocuments(e,t,n,r,i){const s=[];return t.forEach(e=>{s.push({type:0,doc:e})}),new wl(e,t,yl.emptySet(t),s,n,r,!0,!1,i)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&La(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let r=0;r<t.length;r++)if(t[r].type!==n[r].type||!t[r].doc.isEqual(n[r].doc))return!1;return!0}}class _l{constructor(){this.k_=void 0,this.listeners=[]}}class bl{constructor(){this.queries=new qa(e=>Oa(e),La),this.onlineState="Unknown",this.q_=new Set}}async function Il(e,t){const n=e,r=t.query;let i=!1,s=n.queries.get(r);if(s||(i=!0,s=new _l),i)try{s.k_=await n.onListen(r)}catch(e){const n=pl(e,`Initialization of query '${Fa(t.query)}' failed`);return void t.onError(n)}n.queries.set(r,s),s.listeners.push(t),t.Q_(n.onlineState),!s.k_||t.K_(s.k_)&&Tl(n)}async function El(e,t){const n=e,r=t.query;let i=!1;const s=n.queries.get(r);if(s){const e=s.listeners.indexOf(t);0<=e&&(s.listeners.splice(e,1),i=0===s.listeners.length)}if(i)return n.queries.delete(r),n.onUnlisten(r)}function Tl(e){e.q_.forEach(e=>{e.next()})}class Sl{constructor(e,t,n){this.query=e,this.U_=t,this.W_=!1,this.G_=null,this.onlineState="Unknown",this.options=n||{}}K_(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new wl(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.W_?this.z_(e)&&(this.U_.next(e),t=!0):this.j_(e,this.onlineState)&&(this.H_(e),t=!0),this.G_=e,t}onError(e){this.U_.error(e)}Q_(e){this.onlineState=e;let t=!1;return this.G_&&!this.W_&&this.j_(this.G_,e)&&(this.H_(this.G_),t=!0),t}j_(e,t){return!e.fromCache||(!this.options.J_||!("Offline"!==t))&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}z_(e){if(0<e.docChanges.length)return!0;var t=this.G_&&this.G_.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}H_(e){e=wl.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.W_=!0,this.U_.next(e)}}class xl{constructor(e,t){this.Y_=e,this.byteLength=t}Z_(){return"metadata"in this.Y_}}class Dl{constructor(e){this.serializer=e}hs(e){return iu(this.serializer,e)}Ps(e){return e.metadata.exists?hu(this.serializer,e.document,!1):Hs.newNoDocument(this.hs(e.metadata.name),this.Is(e.metadata.readTime))}Is(e){return eu(e)}}class Cl{constructor(e,t,n){this.X_=e,this.localStore=t,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=Al(e)}ea(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.Y_.namedQuery)this.queries.push(e.Y_.namedQuery);else if(e.Y_.documentMetadata){this.documents.push({metadata:e.Y_.documentMetadata}),e.Y_.documentMetadata.exists||++t;const n=ri.fromString(e.Y_.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.Y_.document&&(this.documents[this.documents.length-1].document=e.Y_.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}ta(e){const t=new Map,n=new Dl(this.serializer);for(const i of e)if(i.metadata.queries){const e=n.hs(i.metadata.name);for(const n of i.metadata.queries){var r=(t.get(n)||Wa()).add(e);t.set(n,r)}}return t}async complete(){const e=await async function(e,t,n,r){const i=e;let s=Wa(),a=Ua;for(const e of n){const n=t.hs(e.metadata.name);e.document&&(s=s.add(n));const c=t.Ps(e);c.setReadTime(t.Is(e.metadata.readTime)),a=a.insert(n,c)}const o=i.ss.newChangeBuffer({trackRemovals:!0}),u=await mh(i,(r=r,ka(Da(ri.fromString(`__bundle__/docs/${r}`)))));return i.persistence.runTransaction("Apply bundle documents","readwrite",t=>gh(t,o,a).next(e=>(o.apply(t),e)).next(e=>i.qr.removeMatchingKeysForTargetId(t,u.targetId).next(()=>i.qr.addMatchingKeys(t,s,u.targetId)).next(()=>i.localDocuments.getLocalViewOfDocuments(t,e.us,e.cs)).next(()=>e.us)))}(this.localStore,new Dl(this.serializer),this.documents,this.X_.id),t=this.ta(this.documents);for(const e of this.queries)await async function(e,n,r=Wa()){const i=await mh(e,ka(Nu(n.bundledQuery))),s=e;return s.persistence.runTransaction("Save named query","readwrite",e=>{var t=eu(n.readTime);if(0<=i.snapshotVersion.compareTo(t))return s.Kr.saveNamedQuery(e,n);t=i.withResumeToken(_s.EMPTY_BYTE_STRING,t);return s.ts=s.ts.insert(t.targetId,t),s.qr.updateTargetData(e,t).next(()=>s.qr.removeMatchingKeysForTargetId(e,i.targetId)).next(()=>s.qr.addMatchingKeys(e,r,i.targetId)).next(()=>s.Kr.saveNamedQuery(e,n))})}(this.localStore,e,t.get(e.name));return this.progress.taskState="Success",{progress:this.progress,na:this.collectionGroups,ra:e}}}function Al(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class Nl{constructor(e){this.key=e}}class kl{constructor(e){this.key=e}}class Rl{constructor(e,t){this.query=e,this.ia=t,this.sa=null,this.hasCachedResults=!1,this.current=!1,this.oa=Wa(),this.mutatedKeys=Wa(),this._a=Ba(e),this.aa=new yl(this._a)}get ua(){return this.ia}ca(e,t){const o=t?t.la:new vl,u=(t||this).aa;let c=(t||this).mutatedKeys,h=u,l=!1;const d="F"===this.query.limitType&&u.size===this.query.limit?u.last():null,f="L"===this.query.limitType&&u.size===this.query.limit?u.first():null;if(e.inorderTraversal((e,t)=>{const n=u.get(e),r=Pa(this.query,t)?t:null,i=!!n&&this.mutatedKeys.has(n.key),s=!!r&&(r.hasLocalMutations||this.mutatedKeys.has(r.key)&&r.hasCommittedMutations);let a=!1;n&&r?n.data.isEqual(r.data)?i!==s&&(o.track({type:3,doc:r}),a=!0):this.ha(n,r)||(o.track({type:2,doc:r}),a=!0,(d&&0<this._a(r,d)||f&&this._a(r,f)<0)&&(l=!0)):!n&&r?(o.track({type:0,doc:r}),a=!0):n&&!r&&(o.track({type:1,doc:n}),a=!0,(d||f)&&(l=!0)),a&&(c=r?(h=h.add(r),s?c.add(e):c.delete(e)):(h=h.delete(e),c.delete(e)))}),null!==this.query.limit)for(;h.size>this.query.limit;){const e="F"===this.query.limitType?h.last():h.first();h=h.delete(e.key),c=c.delete(e.key),o.track({type:1,doc:e})}return{aa:h,la:o,Zi:l,mutatedKeys:c}}ha(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n,r){var i=this.aa;this.aa=e.aa,this.mutatedKeys=e.mutatedKeys;const s=e.la.L_();s.sort((e,t)=>function(e,t){var n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return Pr()}};return n(e)-n(t)}(e.type,t.type)||this._a(e.doc,t.doc)),this.Pa(n),r=null!=r&&r;var a=t&&!r?this.Ia():[],o=0===this.oa.size&&this.current&&!r?1:0,u=o!==this.sa;return this.sa=o,0!==s.length||u?{snapshot:new wl(this.query,e.aa,i,s,e.mutatedKeys,0==o,u,!1,!!n&&0<n.resumeToken.approximateByteSize()),Ta:a}:{Ta:a}}Q_(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({aa:this.aa,la:new vl,mutatedKeys:this.mutatedKeys,Zi:!1},!1)):{Ta:[]}}Ea(e){return!this.ia.has(e)&&!!this.aa.has(e)&&!this.aa.get(e).hasLocalMutations}Pa(e){e&&(e.addedDocuments.forEach(e=>this.ia=this.ia.add(e)),e.modifiedDocuments.forEach(e=>{}),e.removedDocuments.forEach(e=>this.ia=this.ia.delete(e)),this.current=e.current)}Ia(){if(!this.current)return[];const t=this.oa;this.oa=Wa(),this.aa.forEach(e=>{this.Ea(e.key)&&(this.oa=this.oa.add(e.key))});const n=[];return t.forEach(e=>{this.oa.has(e)||n.push(new kl(e))}),this.oa.forEach(e=>{t.has(e)||n.push(new Nl(e))}),n}da(e){this.ia=e.ls,this.oa=Wa();var t=this.ca(e.documents);return this.applyChanges(t,!0)}Aa(){return wl.fromInitialDocuments(this.query,this.aa,this.mutatedKeys,0===this.sa,this.hasCachedResults)}}class Ml{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class Ll{constructor(e){this.key=e,this.Ra=!1}}class Ol{constructor(e,t,n,r,i,s){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=i,this.maxConcurrentLimboResolutions=s,this.Va={},this.ma=new qa(e=>Oa(e),La),this.fa=new Map,this.ga=new Set,this.pa=new ds(ai.comparator),this.ya=new Map,this.wa=new jc,this.Sa={},this.ba=new Map,this.Da=_c.Nn(),this.onlineState="Unknown",this.Ca=void 0}get isPrimaryClient(){return!0===this.Ca}}async function Fl(r,e,t,n,i){r.va=(e,t,n)=>async function(e,t,n,r){let i=t.view.ca(n);i.Zi&&(i=await yh(e.localStore,t.query,!1).then(({documents:e})=>t.view.ca(e,i)));var s=r&&r.targetChanges.get(t.targetId),a=r&&null!=r.targetMismatches.get(t.targetId),a=t.view.applyChanges(i,e.isPrimaryClient,s,a);return Kl(e,t.targetId,a.Ta),a.snapshot}(r,e,t,n);const s=await yh(r.localStore,e,!0),a=new Rl(e,s.ls),o=a.ca(s.documents),u=Bo.createSynthesizedTargetChangeForCurrentChange(t,n&&"Offline"!==r.onlineState,i),c=a.applyChanges(o,r.isPrimaryClient,u);Kl(r,t,c.Ta);var h=new Ml(e,t,a);return r.ma.set(e,h),r.fa.has(t)?r.fa.get(t).push(e):r.fa.set(t,[e]),c.snapshot}async function Pl(e,t,n){const r=Jl(e);try{const e=await function(e,i){const s=e,a=ei.now(),o=i.reduce((e,t)=>e.add(t.key),Wa());let u,c;return s.persistence.runTransaction("Locally write mutations","readwrite",n=>{let t=Ua,r=Wa();return s.ss.getEntries(n,o).next(e=>{t=e,t.forEach((e,t)=>{t.isValidDocument()||(r=r.add(e))})}).next(()=>s.localDocuments.getOverlayedDocuments(n,t)).next(e=>{u=e;const t=[];for(const n of i){const i=function(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),i=eo(r.transform,e||null);null!=i&&(null===n&&(n=Ws.empty()),n.set(r.field,i))}return n||null}(n,u.get(n.key).overlayedDocument);null!=i&&t.push(new _o(n.key,i,function r(e){const i=[];return hs(e.fields,(e,t)=>{const n=new si([e]);if(Gs(t)){const e=r(t.mapValue).fields;if(0===e.length)i.push(n);else for(const t of e)i.push(n.child(t))}else i.push(n)}),new vs(i)}(i.value.mapValue),lo.exists(!0)))}return s.mutationQueue.addMutationBatch(n,a,t,i)}).next(e=>{var t=(c=e).applyToLocalDocumentSet(u,r);return s.documentOverlayCache.saveOverlays(n,e.batchId,t)})}).then(()=>({batchId:c.batchId,changes:ja(u)}))}(r.localStore,t);r.sharedClientState.addPendingMutation(e.batchId),function(e,t,n){let r=e.Sa[e.currentUser.toKey()];r=r||new ds(Xr),r=r.insert(t,n),e.Sa[e.currentUser.toKey()]=r}(r,e.batchId,n),await Ql(r,e.changes),await ol(r.remoteStore)}catch(e){const t=pl(e,"Failed to persist write");n.reject(t)}}async function Vl(e,t){const r=e;try{const e=await fh(r.localStore,t);t.targetChanges.forEach((e,t)=>{const n=r.ya.get(t);n&&(Vr(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),0<e.addedDocuments.size?n.Ra=!0:0<e.modifiedDocuments.size?Vr(n.Ra):0<e.removedDocuments.size&&(Vr(n.Ra),n.Ra=!1))}),await Ql(r,e,t)}catch(e){await vi(e)}}function Bl(r,i,e){const t=r;if(t.isPrimaryClient&&0===e||!t.isPrimaryClient&&1===e){const r=[];t.ma.forEach((e,t)=>{var n=t.view.Q_(i);n.snapshot&&r.push(n.snapshot)}),function(e,n){const t=e;t.onlineState=n;let r=!1;t.queries.forEach((e,t)=>{for(const e of t.listeners)e.Q_(n)&&(r=!0)}),r&&Tl(t)}(t.eventManager,i),r.length&&t.Va.a_(r),t.onlineState=i,t.isPrimaryClient&&t.sharedClientState.setOnlineState(i)}}async function ql(e,t){const n=e,r=t.batch.batchId;try{const e=await function(e,r){const i=e;return i.persistence.runTransaction("Acknowledge batch","readwrite-primary",e=>{const t=r.batch.keys(),n=i.ss.newChangeBuffer({trackRemovals:!0});return function(e,t,r,i){const s=r.batch,n=s.keys();let a=wi.resolve();return n.forEach(n=>{a=a.next(()=>i.getEntry(t,n)).next(e=>{var t=r.docVersions.get(n);Vr(null!==t),e.version.compareTo(t)<0&&(s.applyToRemoteDocument(e,r),e.isValidDocument()&&(e.setReadTime(r.commitVersion),i.addEntry(e)))})}),a.next(()=>e.mutationQueue.removeMutationBatch(t,s))}(i,e,r,n).next(()=>n.apply(e)).next(()=>i.mutationQueue.performConsistencyCheck(e)).next(()=>i.documentOverlayCache.removeOverlaysForBatchId(e,t,r.batch.batchId)).next(()=>i.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=Wa();for(let n=0;n<e.mutationResults.length;++n)0<e.mutationResults[n].transformResults.length&&(t=t.add(e.batch.mutations[n].key));return t}(r))).next(()=>i.localDocuments.getDocuments(e,t))})}(n.localStore,t);zl(n,r,null),Ul(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await Ql(n,e)}catch(e){await vi(e)}}function Ul(e,t){(e.ba.get(t)||[]).forEach(e=>{e.resolve()}),e.ba.delete(t)}function zl(e,t,n){const r=e;let i=r.Sa[r.currentUser.toKey()];if(i){const e=i.get(t);e&&(n?e.reject(n):e.resolve(),i=i.remove(t)),r.Sa[r.currentUser.toKey()]=i}}function Gl(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const r of t.fa.get(e))t.ma.delete(r),n&&t.Va.Fa(r,n);t.fa.delete(e),t.isPrimaryClient&&t.wa.Rr(e).forEach(e=>{t.wa.containsKey(e)||jl(t,e)})}function jl(e,t){e.ga.delete(t.path.canonicalString());var n=e.pa.get(t);null!==n&&(Jh(e.remoteStore,n),e.pa=e.pa.remove(t),e.ya.delete(n),$l(e))}function Kl(e,t,n){for(const r of n)r instanceof Nl?(e.wa.addReference(r.key,t),function(e,t){const n=t.key,r=n.path.canonicalString();e.pa.get(n)||e.ga.has(r)||(Mr("SyncEngine","New document in limbo: "+n),e.ga.add(r),$l(e))}(e,r)):r instanceof kl?(Mr("SyncEngine","Document no longer in limbo: "+r.key),e.wa.removeReference(r.key,t),e.wa.containsKey(r.key)||jl(e,r.key)):Pr()}function $l(e){for(;0<e.ga.size&&e.pa.size<e.maxConcurrentLimboResolutions;){var t=e.ga.values().next().value;e.ga.delete(t);var n=new ai(ri.fromString(t)),t=e.Da.next();e.ya.set(t,new Ll(n)),e.pa=e.pa.insert(n,t),Xh(e.remoteStore,new bu(ka(Da(n.path)),t,"TargetPurposeLimboResolution",ki._e))}}async function Ql(e,t,r){const i=e,s=[],a=[],o=[];i.ma.isEmpty()||(i.ma.forEach((e,n)=>{o.push(i.va(n,t,r).then(e=>{var t;(e||r)&&i.isPrimaryClient&&i.sharedClientState.updateQueryState(n.targetId,null!=e&&e.fromCache?"not-current":"current"),e&&(s.push(e),t=ah.Qi(n.targetId,e),a.push(t))}))}),await Promise.all(o),i.Va.a_(s),await async function(e,t){const r=e;try{await r.persistence.runTransaction("notifyLocalViewChanges","readwrite",n=>wi.forEach(t,t=>wi.forEach(t.ki,e=>r.persistence.referenceDelegate.addReference(n,t.targetId,e)).next(()=>wi.forEach(t.qi,e=>r.persistence.referenceDelegate.removeReference(n,t.targetId,e)))))}catch(e){if(!Ti(e))throw e;Mr("LocalStore","Failed to update sequence numbers: "+e)}for(const e of t){const t=e.targetId;if(!e.fromCache){const e=r.ts.get(t),n=e.snapshotVersion,i=e.withLastLimboFreeSnapshotVersion(n);r.ts=r.ts.insert(t,i)}}}(i.localStore,a))}async function Wl(r,e){const i=r;if(Xl(i),Jl(i),!0===e&&!0!==i.Ca){const r=i.sharedClientState.getAllActiveQueryTargets(),e=await Hl(i,r.toArray());i.Ca=!0,await dl(i.remoteStore,!0);for(const r of e)Xh(i.remoteStore,r)}else if(!1===e&&!1!==i.Ca){const r=[];let n=Promise.resolve();i.fa.forEach((e,t)=>{i.sharedClientState.isLocalQueryTarget(t)?r.push(t):n=n.then(()=>(Gl(i,t),ph(i.localStore,t,!0))),Jh(i.remoteStore,t)}),await n,await Hl(i,r),function(e){const n=e;n.ya.forEach((e,t)=>{Jh(n.remoteStore,t)}),n.wa.Vr(),n.ya=new Map,n.pa=new ds(ai.comparator)}(i),i.Ca=!1,await dl(i.remoteStore,!1)}}async function Hl(t,n){const r=t,i=[],s=[];for(const t of n){let e;const h=r.fa.get(t);if(h&&0!==h.length){e=await mh(r.localStore,ka(h[0]));for(const t of h){const n=r.ma.get(t),h=(a=r,o=n,c=u=void 0,c=await yh((u=a).localStore,o.query,!0),c=o.view.da(c),u.isPrimaryClient&&Kl(u,o.targetId,c.Ta),await c);h.snapshot&&s.push(h.snapshot)}}else{const h=await vh(r.localStore,t);e=await mh(r.localStore,h),await Fl(r,Yl(h),t,!1,e.resumeToken)}i.push(e)}var a,o,u,c;return r.Va.a_(s),i}function Yl(e){return xa(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function Xl(e){const t=e;return t.remoteStore.remoteSyncer.applyRemoteEvent=Vl.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=(function(e,t){const n=e,r=n.ya.get(t);if(r&&r.Ra)return Wa().add(r.key);{let e=Wa();const r=n.fa.get(t);if(!r)return e;for(const t of r){const r=n.ma.get(t);e=e.unionWith(r.view.ua)}return e}}).bind(null,t),t.remoteStore.remoteSyncer.rejectListen=(async function(e,t,n){const r=e;r.sharedClientState.updateQueryState(t,"rejected",n);const i=r.ya.get(t),s=i&&i.key;if(s){let e=new ds(ai.comparator);e=e.insert(s,Hs.newNoDocument(s,ti.min()));const n=Wa().add(s),i=new Vo(ti.min(),new Map,new ds(Xr),e,n);await Vl(r,i),r.pa=r.pa.remove(s),r.ya.delete(t),$l(r)}else await ph(r.localStore,t,!1).then(()=>Gl(r,t,n)).catch(vi)}).bind(null,t),t.Va.a_=(function(e,t){const n=e;let r=!1;for(const e of t){const t=e.query,i=n.queries.get(t);if(i){for(const t of i.listeners)t.K_(e)&&(r=!0);i.k_=e}}r&&Tl(n)}).bind(null,t.eventManager),t.Va.Fa=(function(e,t,n){const r=e,i=r.queries.get(t);if(i)for(const e of i.listeners)e.onError(n);r.queries.delete(t)}).bind(null,t.eventManager),t}function Jl(e){const t=e;return t.remoteStore.remoteSyncer.applySuccessfulWrite=ql.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=(async function(e,t,n){const r=e;try{const e=await function(e,r){const i=e;return i.persistence.runTransaction("Reject batch","readwrite-primary",t=>{let n;return i.mutationQueue.lookupMutationBatch(t,r).next(e=>(Vr(null!==e),n=e.keys(),i.mutationQueue.removeMutationBatch(t,e))).next(()=>i.mutationQueue.performConsistencyCheck(t)).next(()=>i.documentOverlayCache.removeOverlaysForBatchId(t,n,r)).next(()=>i.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,n)).next(()=>i.localDocuments.getDocuments(t,n))})}(r.localStore,t);zl(r,t,n),Ul(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await Ql(r,e)}catch(n){await vi(n)}}).bind(null,t),t}class Zl{constructor(){this.synchronizeTabs=!1}async initialize(e){this.serializer=Uh(e.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(e),this.persistence=this.createPersistence(e),await this.persistence.start(),this.localStore=this.createLocalStore(e),this.gcScheduler=this.createGarbageCollectionScheduler(e,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(e,this.localStore)}createGarbageCollectionScheduler(e,t){return null}createIndexBackfillerScheduler(e,t){return null}createLocalStore(e){return hh(this.persistence,new uh,e.initialUser,this.serializer)}createPersistence(e){return new Yc(Jc.jr,this.serializer)}createSharedClientState(e){return new Nh}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class ed extends Zl{constructor(e,t,n){super(),this.xa=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.xa.initialize(this,e),await Jl(this.xa.syncEngine),await ol(this.xa.remoteStore),await this.persistence.mi(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))}createLocalStore(e){return hh(this.persistence,new uh,e.initialUser,this.serializer)}createGarbageCollectionScheduler(e,t){var n=this.persistence.referenceDelegate.garbageCollector;return new Dc(n,e.asyncQueue,t)}createIndexBackfillerScheduler(e,t){var n=new Ni(t,this.persistence);return new Ai(e.asyncQueue,n)}createPersistence(e){var t=sh(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?dc.withCacheSize(this.cacheSizeBytes):dc.DEFAULT;return new nh(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,Bh(),qh(),this.serializer,this.sharedClientState,!!this.forceOwnership)}createSharedClientState(e){return new Nh}}class td extends ed{constructor(e,t){super(e,t,!1),this.xa=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);var t=this.xa.syncEngine;this.sharedClientState instanceof Ah&&(this.sharedClientState.syncEngine={Ys:(async function(e,t,n,r){var i=e,s=await function(e,n){const r=e,i=r.mutationQueue;return r.persistence.runTransaction("Lookup mutation documents","readonly",t=>i.Cn(t,n).next(e=>e?r.localDocuments.getDocuments(t,e):wi.resolve(null)))}(i.localStore,t);null!==s?("pending"===n?await ol(i.remoteStore):"acknowledged"===n||"rejected"===n?(zl(i,t,r||null),Ul(i,t),i.localStore.mutationQueue.Fn(t)):Pr(),await Ql(i,s)):Mr("SyncEngine","Cannot apply mutation batch with id: "+t)}).bind(null,t),Zs:(async function(e,t,n,r){const i=e;if(i.Ca)Mr("SyncEngine","Ignoring unexpected query state notification.");else{var s=i.fa.get(t);if(s&&0<s.length)switch(n){case"current":case"not-current":{const e=await wh(i.localStore,Va(s[0])),r=Vo.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,_s.EMPTY_BYTE_STRING);await Ql(i,e,r);break}case"rejected":await ph(i.localStore,t,!0),Gl(i,t,r);break;default:Pr()}}}).bind(null,t),Xs:(async function(e,t,n){const r=Xl(e);if(r.Ca){for(const e of t)if(r.fa.has(e))Mr("SyncEngine","Adding an already active target "+e);else{const t=await vh(r.localStore,e),n=await mh(r.localStore,t);await Fl(r,Yl(t),n.targetId,!1,n.resumeToken),Xh(r.remoteStore,n)}for(const e of n)r.fa.has(e)&&await ph(r.localStore,e,!1).then(()=>{Jh(r.remoteStore,e),Gl(r,e)}).catch(vi)}}).bind(null,t),Bi:(function(e){return e.localStore.persistence.Bi()}).bind(null,t),Js:(async function(e,t){const n=e;return wh(n.localStore,t).then(e=>Ql(n,e))}).bind(null,t)},await this.sharedClientState.start()),await this.persistence.mi(async e=>{await Wl(this.xa.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())})}createSharedClientState(e){var t=Bh();if(!Ah.D(t))throw new qr(Br.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");var n=sh(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new Ah(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class nd{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>Bl(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=(async function(e,t){const n=e;if(!n.currentUser.isEqual(t)){Mr("SyncEngine","User change. New user:",t.toKey());const i=await lh(n.localStore,t);n.currentUser=t,e=n,r="'waitForPendingWrites' promise is rejected due to a user change.",e.ba.forEach(e=>{e.forEach(e=>{e.reject(new qr(Br.CANCELLED,r))})}),e.ba.clear(),n.sharedClientState.handleUserChange(t,i.removedBatchIds,i.addedBatchIds),await Ql(n,i._s)}var r}).bind(null,this.syncEngine),await dl(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new bl}createDatastore(e){var t,n,r,i=Uh(e.databaseInfo.databaseId),s=(r=e.databaseInfo,new Vh(r));return t=e.authCredentials,n=e.appCheckCredentials,r=s,e=i,new $h(t,n,r,e)}createRemoteStore(e){return t=this.localStore,n=this.datastore,r=e.asyncQueue,i=e=>Bl(this.syncEngine,e,0),e=new(Rh.D()?Rh:kh),new Wh(t,n,r,i,e);var t,n,r,i}createSyncEngine(e,t){return function(e,t,n,r,i,s,a){const o=new Ol(e,t,n,r,i,s);return a&&(o.Ca=!0),o}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}terminate(){return async function(e){const t=e;Mr("RemoteStore","RemoteStore shutting down."),t.C_.add(5),await Yh(t),t.F_.shutdown(),t.M_.set("Unknown")}(this.remoteStore)}}function rd(t,n=10240){let r=0;return{async read(){if(r<t.byteLength){var e={value:t.slice(r,r+n),done:!1};return r+=n,e}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()}}class id{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Oa(this.observer.next,e)}error(e){this.observer.error?this.Oa(this.observer.error,e):Lr("Uncaught Error in snapshot listener:",e.toString())}Na(){this.muted=!0}Oa(e,t){this.muted||setTimeout(()=>{this.muted||e(t)},0)}}class sd{constructor(e,t){this.Ba=e,this.serializer=t,this.metadata=new Ur,this.buffer=new Uint8Array,this.La=new TextDecoder("utf-8"),this.ka().then(e=>{e&&e.Z_()?this.metadata.resolve(e.Y_.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==e?void 0:e.Y_)}`))},e=>this.metadata.reject(e))}close(){return this.Ba.cancel()}async getMetadata(){return this.metadata.promise}async Ma(){return await this.getMetadata(),this.ka()}async ka(){var e=await this.qa();if(null===e)return null;var t=this.La.decode(e),n=Number(t);isNaN(n)&&this.Qa(`length string (${t}) is not valid number`);t=await this.Ka(n);return new xl(JSON.parse(t),e.length+n)}$a(){return this.buffer.findIndex(e=>e==="{".charCodeAt(0))}async qa(){for(;this.$a()<0&&!await this.Ua(););if(0===this.buffer.length)return null;var e=this.$a();e<0&&this.Qa("Reached the end of bundle when a length string is expected.");var t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async Ka(e){for(;this.buffer.length<e;)await this.Ua()&&this.Qa("Reached the end of bundle when more is expected.");var t=this.La.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}Qa(e){throw this.Ba.cancel(),new Error(`Invalid bundle format: ${e}`)}async Ua(){var e=await this.Ba.read();if(!e.done){const t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class ad{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),0<this.mutations.length)throw new qr(Br.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const t=await async function(e,t){const r=e,n=ou(r.serializer)+"/documents",i={documents:t.map(e=>ru(r.serializer,e))},s=await r.Co("BatchGetDocuments",n,i,t.length),a=new Map;s.forEach(e=>{const t=(n=r.serializer,"found"in(e=e)?function(e,t){Vr(!!t.found),t.found.name,t.found.updateTime;var n=iu(e,t.found.name),r=eu(t.found.updateTime),i=t.found.createTime?eu(t.found.createTime):ti.min(),s=new Ws({mapValue:{fields:t.found.fields}});return Hs.newFoundDocument(n,r,i,s)}(n,e):"missing"in e?function(e,t){Vr(!!t.missing),Vr(!!t.readTime);var n=iu(e,t.missing),r=eu(t.readTime);return Hs.newNoDocument(n,r)}(n,e):Pr());var n;a.set(t.key.toString(),t)});const o=[];return t.forEach(e=>{var t=a.get(e.toString());Vr(!!t),o.push(t)}),o}(this.datastore,e);return t.forEach(e=>this.recordVersion(e)),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastWriteError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new To(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const t=this.readVersions;this.mutations.forEach(e=>{t.delete(e.key.toString())}),t.forEach((e,t)=>{var n=ai.fromPath(t);this.mutations.push(new So(n,this.precondition(n)))}),await async function(e,t){const n=e,r=ou(n.serializer)+"/documents",i={writes:t.map(e=>lu(n.serializer,e))};await n.wo("Commit",r,i)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw Pr();t=ti.min()}var n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new qr(Br.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){const t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(ti.min())?lo.exists(!1):lo.updateTime(t):lo.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(this.writtenDocs.has(e.toString())||!t)return lo.exists(!0);if(t.isEqual(ti.min()))throw new qr(Br.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return lo.updateTime(t)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class od{constructor(e,t,n,r,i){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=i,this.Wa=n.maxAttempts,this.zo=new zh(this.asyncQueue,"transaction_retry")}run(){--this.Wa,this.Ga()}Ga(){this.zo.ko(async()=>{const t=new ad(this.datastore),e=this.za(t);e&&e.then(e=>{this.asyncQueue.enqueueAndForget(()=>t.commit().then(()=>{this.deferred.resolve(e)}).catch(e=>{this.ja(e)}))}).catch(e=>{this.ja(e)})})}za(e){try{var t=this.updateFunction(e);return!Ri(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}ja(e){0<this.Wa&&this.Ha(e)?(--this.Wa,this.asyncQueue.enqueueAndForget(()=>(this.Ga(),Promise.resolve()))):this.deferred.reject(e)}Ha(e){if("FirebaseError"!==e.name)return!1;var t=e.code;return"aborted"===t||"failed-precondition"===t||"already-exists"===t||!No(t)}}class ud{constructor(e,t,n,r){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=Ar.UNAUTHENTICATED,this.clientId=Yr.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,async e=>{Mr("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e}),this.appCheckCredentials.start(n,e=>(Mr("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user)))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new qr(Br.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const n=new Ur;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),n.resolve()}catch(e){var t=pl(e,"Failed to shutdown persistence");n.reject(t)}}),n.promise}}async function cd(e,t){e.asyncQueue.verifyOperationInProgress(),Mr("FirestoreClient","Initializing OfflineComponentProvider");var n=await e.getConfiguration();await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener(async e=>{r.isEqual(e)||(await lh(t.localStore,e),r=e)}),t.persistence.setDatabaseDeletedListener(()=>e.terminate()),e._offlineComponents=t}async function hd(e,n){e.asyncQueue.verifyOperationInProgress();var t=await dd(e);Mr("FirestoreClient","Initializing OnlineComponentProvider");var r=await e.getConfiguration();await n.initialize(t,r),e.setCredentialChangeListener(e=>ll(n.remoteStore,e)),e.setAppCheckTokenChangeListener((e,t)=>ll(n.remoteStore,t)),e._onlineComponents=n}function ld(e){return"FirebaseError"===e.name?e.code===Br.FAILED_PRECONDITION||e.code===Br.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||22===e.code||20===e.code||11===e.code}async function dd(t){if(!t._offlineComponents)if(t._uninitializedComponentsProvider){Mr("FirestoreClient","Using user provided OfflineComponentProvider");try{await cd(t,t._uninitializedComponentsProvider._offline)}catch(e){var n=e;if(!ld(n))throw n;Or("Error using user provided cache. Falling back to memory cache: "+n),await cd(t,new Zl)}}else Mr("FirestoreClient","Using default OfflineComponentProvider"),await cd(t,new Zl);return t._offlineComponents}async function fd(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(Mr("FirestoreClient","Using user provided OnlineComponentProvider"),await hd(e,e._uninitializedComponentsProvider._online)):(Mr("FirestoreClient","Using default OnlineComponentProvider"),await hd(e,new nd))),e._onlineComponents}function gd(e){return dd(e).then(e=>e.persistence)}function md(e){return dd(e).then(e=>e.localStore)}function pd(e){return fd(e).then(e=>e.remoteStore)}function yd(e){return fd(e).then(e=>e.syncEngine)}async function vd(e){const t=await fd(e),n=t.eventManager;return n.onListen=(async function(e,t){const n=Xl(e);let r,i;const s=n.ma.get(t);if(s)r=s.targetId,n.sharedClientState.addLocalQueryTarget(r),i=s.view.Aa();else{const e=await mh(n.localStore,ka(t)),s=n.sharedClientState.addLocalQueryTarget(e.targetId);r=e.targetId,i=await Fl(n,t,r,"current"===s,e.resumeToken),n.isPrimaryClient&&Xh(n.remoteStore,e)}return i}).bind(null,t.syncEngine),n.onUnlisten=(async function(e,t){const n=e,r=n.ma.get(t),i=n.fa.get(r.targetId);if(1<i.length)return n.fa.set(r.targetId,i.filter(e=>!La(e,t))),void n.ma.delete(t);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await ph(n.localStore,r.targetId,!1).then(()=>{n.sharedClientState.clearQueryState(r.targetId),Jh(n.remoteStore,r.targetId),Gl(n,r.targetId)}).catch(vi)):(Gl(n,r.targetId),await ph(n.localStore,r.targetId,!0))}).bind(null,t.syncEngine),n}function wd(e,t,n={}){const r=new Ur;return e.asyncQueue.enqueueAndForget(async()=>function(n,r,i,s,a){const e=new id({next:e=>{r.enqueueAndForget(()=>El(n,o));var t=e.docs.has(i);!t&&e.fromCache?a.reject(new qr(Br.UNAVAILABLE,"Failed to get document because the client is offline.")):t&&e.fromCache&&s&&"server"===s.source?a.reject(new qr(Br.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):a.resolve(e)},error:e=>a.reject(e)}),o=new Sl(Da(i.path),e,{includeMetadataChanges:!0,J_:!0});return Il(n,o)}(await vd(e),e.asyncQueue,t,n,r)),r.promise}function _d(e,t,n={}){const r=new Ur;return e.asyncQueue.enqueueAndForget(async()=>function(t,n,e,r,i){const s=new id({next:e=>{n.enqueueAndForget(()=>El(t,a)),e.fromCache&&"server"===r.source?i.reject(new qr(Br.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):i.resolve(e)},error:e=>i.reject(e)}),a=new Sl(e,s,{includeMetadataChanges:!0,J_:!0});return Il(t,a)}(await vd(e),e.asyncQueue,t,n,r)),r.promise}function bd(e,t,n,r){const i=(n=n,t=Uh(t),s="string"==typeof n?Ro().encode(n):n,n=function(e,t){if(e instanceof Uint8Array)return rd(e,t);if(e instanceof ArrayBuffer)return rd(new Uint8Array(e),t);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(s),t=t,new sd(n,t));var s;e.asyncQueue.enqueueAndForget(async()=>{!function(e,t,n){const r=e;!async function(t,n,r){try{var i=await n.getMetadata();if(await function(e,t){const n=e,r=eu(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",e=>n.Kr.getBundleMetadata(e,t.id)).then(e=>!!e&&0<=e.createTime.compareTo(r))}(t.localStore,i))return await n.close(),r._completeWith({taskState:"Success",documentsLoaded:i.totalDocuments,bytesLoaded:i.totalBytes,totalDocuments:i.totalDocuments,totalBytes:i.totalBytes}),Promise.resolve(new Set);r._updateProgress(Al(i));const a=new Cl(i,t.localStore,n.serializer);let e=await n.Ma();for(;e;){const t=await a.ea(e);t&&r._updateProgress(t),e=await n.Ma()}var s=await a.complete();return await Ql(t,s.ra,void 0),await function(e,t){const n=e;return n.persistence.runTransaction("Save bundle","readwrite",e=>n.Kr.saveBundleMetadata(e,t))}(t.localStore,i),r._completeWith(s.progress),Promise.resolve(s.na)}catch(t){return Or("SyncEngine",`Loading bundle failed with ${t}`),r._failWith(t),Promise.resolve(new Set)}}(r,t,n).then(e=>{r.sharedClientState.notifyBundleLoaded(e)})}(await yd(e),i,r)})}function Id(e){const t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}const Ed=new Map;function Td(e,t,n){if(!n)throw new qr(Br.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function Sd(e,t,n,r){if(!0===t&&!0===r)throw new qr(Br.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)}function xd(e){if(!ai.isDocumentKey(e))throw new qr(Br.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function Dd(e){if(ai.isDocumentKey(e))throw new qr(Br.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function Cd(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return 20<e.length&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"!=typeof e)return"function"==typeof e?"a function":Pr();if(e instanceof Array)return"an array";var t=(e=e).constructor?e.constructor.name:null;return t?`a custom ${t} object`:"an object"}function Ad(e,t){if((e="_delegate"in e?e._delegate:e)instanceof t)return e;if(t.name===e.constructor.name)throw new qr(Br.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");var n=Cd(e);throw new qr(Br.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}function Nd(e,t){if(t<=0)throw new qr(Br.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}class kd{constructor(e){var t;if(void 0===e.host){if(void 0!==e.ssl)throw new qr(Br.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new qr(Br.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}Sd("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=Id(null!==(t=e.experimentalLongPollingOptions)&&void 0!==t?t:{}),function(e){if(void 0!==e.timeoutSeconds){if(isNaN(e.timeoutSeconds))throw new qr(Br.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (must not be NaN)`);if(e.timeoutSeconds<5)throw new qr(Br.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (minimum allowed value is 5)`);if(30<e.timeoutSeconds)throw new qr(Br.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&(t=this.experimentalLongPollingOptions,n=e.experimentalLongPollingOptions,t.timeoutSeconds===n.timeoutSeconds)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams;var t,n}}class Rd{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new kd({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new qr(Br.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new qr(Br.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new kd(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new Gr;switch(e.type){case"firstParty":return new Qr(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new qr(Br.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const t=Ed.get(e);t&&(Mr("ComponentProvider","Removing Datastore"),Ed.delete(e),t.terminate())}(this),Promise.resolve()}}function Md(n,e,t,r={}){var i;const s=(n=Ad(n,Rd))._getSettings(),a=`${e}:${t}`;if("firestore.googleapis.com"!==s.host&&s.host!==a&&Or("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),n._setSettings(Object.assign(Object.assign({},s),{host:a,ssl:!1})),r.mockUserToken){let e,t;if("string"==typeof r.mockUserToken)e=r.mockUserToken,t=Ar.MOCK_USER;else{e=function(e,t){if(e.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');var n=t||"demo-project",r=e.iat||0,i=e.sub||e.user_id;if(!i)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");return i=Object.assign({iss:`https://securetoken.google.com/${n}`,aud:n,iat:r,exp:r+3600,auth_time:r,sub:i,user_id:i,firebase:{sign_in_provider:"custom",identities:{}}},e),[o(JSON.stringify({alg:"none",type:"JWT"})),o(JSON.stringify(i)),""].join(".")}(r.mockUserToken,null===(i=n._app)||void 0===i?void 0:i.options.projectId);const s=r.mockUserToken.sub||r.mockUserToken.user_id;if(!s)throw new qr(Br.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");t=new Ar(s)}n._authCredentials=new jr(new zr(e,t))}}class Ld{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new Ld(this.firestore,e,this._query)}}class Od{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Fd(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new Od(this.firestore,e,this._key)}}class Fd extends Ld{constructor(e,t,n){super(e,t,Da(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new Od(this.firestore,null,new ai(e))}withConverter(e){return new Fd(this.firestore,e,this._path)}}function Pd(e,t,...n){if(e=m(e),Td("collection","path",t),e instanceof Rd){var r=ri.fromString(t,...n);return Dd(r),new Fd(e,null,r)}if(!(e instanceof Od||e instanceof Fd))throw new qr(Br.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");r=e._path.child(ri.fromString(t,...n));return Dd(r),new Fd(e.firestore,null,r)}function Vd(e,t,...n){if(e=m(e),Td("doc","path",t=1===arguments.length?Yr.newId():t),e instanceof Rd){var r=ri.fromString(t,...n);return xd(r),new Od(e,null,new ai(r))}if(!(e instanceof Od||e instanceof Fd))throw new qr(Br.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");r=e._path.child(ri.fromString(t,...n));return xd(r),new Od(e.firestore,e instanceof Fd?e.converter:null,new ai(r))}function Bd(e,t){return e=m(e),t=m(t),(e instanceof Od||e instanceof Fd)&&(t instanceof Od||t instanceof Fd)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function qd(e,t){return e=m(e),t=m(t),e instanceof Ld&&t instanceof Ld&&e.firestore===t.firestore&&La(e._query,t._query)&&e.converter===t.converter}class Ud{constructor(){this.Ja=Promise.resolve(),this.Ya=[],this.Za=!1,this.Xa=[],this.eu=null,this.tu=!1,this.nu=!1,this.ru=[],this.zo=new zh(this,"async_queue_retry"),this.iu=()=>{var e=qh();e&&Mr("AsyncQueue","Visibility state changed to "+e.visibilityState),this.zo.Qo()};const e=qh();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.iu)}get isShuttingDown(){return this.Za}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.su(),this.ou(e)}enterRestrictedMode(e){if(!this.Za){this.Za=!0,this.nu=e||!1;const t=qh();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.iu)}}enqueue(e){if(this.su(),this.Za)return new Promise(()=>{});const t=new Ur;return this.ou(()=>this.Za&&this.nu?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Ya.push(e),this._u()))}async _u(){if(0!==this.Ya.length){try{await this.Ya[0](),this.Ya.shift(),this.zo.reset()}catch(e){if(!Ti(e))throw e;Mr("AsyncQueue","Operation failed with retryable error: "+e)}0<this.Ya.length&&this.zo.ko(()=>this._u())}}ou(e){var t=this.Ja.then(()=>(this.tu=!0,e().catch(e=>{throw this.eu=e,this.tu=!1,Lr("INTERNAL UNHANDLED ERROR: ",function(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e)),e}).then(e=>(this.tu=!1,e))));return this.Ja=t}enqueueAfterDelay(e,t,n){this.su(),-1<this.ru.indexOf(e)&&(t=0);var r=ml.createAndSchedule(this,e,t,n,e=>this.au(e));return this.Xa.push(r),r}su(){this.eu&&Pr()}verifyOperationInProgress(){}async uu(){for(var e;await(e=this.Ja),e!==this.Ja;);}cu(e){for(const t of this.Xa)if(t.timerId===e)return!0;return!1}lu(t){return this.uu().then(()=>{this.Xa.sort((e,t)=>e.targetTimeMs-t.targetTimeMs);for(const e of this.Xa)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.uu()})}hu(e){this.ru.push(e)}au(e){var t=this.Xa.indexOf(e);this.Xa.splice(t,1)}}function zd(e){return function(e,t){if("object"==typeof e&&null!==e){var n=e;for(const e of t)if(e in n&&"function"==typeof n[e])return 1}}(e,["next","error","complete"])}class Gd{constructor(){this._progressObserver={},this._taskCompletionResolver=new Ur,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}var jd,Kd,$d,Qd,Wd;class Hd extends Rd{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new Ud,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||Xd(this),this._firestoreClient.terminate()}}function Yd(e){return e._firestoreClient||Xd(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function Xd(e){var t,n,r,i,s,a=e._freezeSettings(),o=(n=e._databaseId,r=(null===(o=e._app)||void 0===o?void 0:o.options.appId)||"",i=e._persistenceKey,s=a,new Cs(n,r,i,s.host,s.ssl,s.experimentalForceLongPolling,s.experimentalAutoDetectLongPolling,Id(s.experimentalLongPollingOptions),s.useFetchStreams));e._firestoreClient=new ud(e._authCredentials,e._appCheckCredentials,e._queue,o),null!==(o=a.localCache)&&void 0!==o&&o._offlineComponentProvider&&null!==(t=a.localCache)&&void 0!==t&&t._onlineComponentProvider&&(e._firestoreClient._uninitializedComponentsProvider={_offlineKind:a.localCache.kind,_offline:a.localCache._offlineComponentProvider,_online:a.localCache._onlineComponentProvider})}function Jd(e,t,n){const r=new Ur;return e.asyncQueue.enqueue(async()=>{try{await cd(e,n),await hd(e,t),r.resolve()}catch(e){const t=e;if(!ld(t))throw t;Or("Error enabling indexeddb cache. Falling back to memory cache: "+t),r.reject(t)}}).then(()=>r.promise)}function Zd(e){return function(e){const t=new Ur;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t){const n=e;rl(n.remoteStore)||Mr("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function(e){const t=e;return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",e=>t.mutationQueue.getHighestUnacknowledgedBatchId(e))}(n.localStore);if(-1===e)return void t.resolve();const r=n.ba.get(e)||[];r.push(t),n.ba.set(e,r)}catch(e){const n=pl(e,"Initialization of waitForPendingWrites() operation failed");t.reject(n)}}(await yd(e),t)),t.promise}(Yd(e=Ad(e,Hd)))}function ef(e){return(n=Yd(e=Ad(e,Hd))).asyncQueue.enqueue(async()=>{const e=await gd(n),t=await pd(n);return e.setNetworkEnabled(!0),function(e){const t=e;return t.C_.delete(0),Hh(t)}(t)});var n}function tf(e){return(n=Yd(e=Ad(e,Hd))).asyncQueue.enqueue(async()=>{const e=await gd(n),t=await pd(n);return e.setNetworkEnabled(!1),async function(e){const t=e;t.C_.add(0),await Yh(t),t.M_.set("Offline")}(t)});var n}function nf(t,e){return n=Yd(t=Ad(t,Hd)),r=e,n.asyncQueue.enqueue(async()=>function(e,t){const n=e;return n.persistence.runTransaction("Get named query","readonly",e=>n.Kr.getNamedQuery(e,t))}(await md(n),r)).then(e=>e?new Ld(t,null,e.query):null);var n,r}function rf(e){if(e._initialized||e._terminated)throw new qr(Br.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class sf{constructor(e){this._byteString=e}static fromBase64String(e){try{return new sf(_s.fromBase64String(e))}catch(e){throw new qr(Br.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new sf(_s.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class af{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new qr(Br.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new si(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class of{constructor(e){this._methodName=e}}class uf{constructor(e,t){if(!isFinite(e)||e<-90||90<e)throw new qr(Br.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||180<t)throw new qr(Br.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return Xr(this._lat,e._lat)||Xr(this._long,e._long)}}const cf=/^__.*__$/;class hf{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new _o(e,this.data,this.fieldMask,t,this.fieldTransforms):new wo(e,this.data,t,this.fieldTransforms)}}class lf{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new _o(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function df(e){switch(e){case 0:case 2:case 1:return 1;case 3:case 4:return;default:throw Pr()}}class ff{constructor(e,t,n,r,i,s){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===i&&this.Pu(),this.fieldTransforms=i||[],this.fieldMask=s||[]}get path(){return this.settings.path}get Iu(){return this.settings.Iu}Tu(e){return new ff(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Eu(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.Tu({path:n,du:!1});return r.Au(e),r}Ru(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.Tu({path:n,du:!1});return r.Pu(),r}Vu(e){return this.Tu({path:void 0,du:!0})}mu(e){return Mf(e,this.settings.methodName,this.settings.fu||!1,this.path,this.settings.gu)}contains(t){return void 0!==this.fieldMask.find(e=>t.isPrefixOf(e))||void 0!==this.fieldTransforms.find(e=>t.isPrefixOf(e.field))}Pu(){if(this.path)for(let e=0;e<this.path.length;e++)this.Au(this.path.get(e))}Au(e){if(0===e.length)throw this.mu("Document fields must not be empty");if(df(this.Iu)&&cf.test(e))throw this.mu('Document fields cannot begin and end with "__"')}}class gf{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||Uh(e)}pu(e,t,n,r=!1){return new ff({Iu:e,methodName:t,gu:n,path:si.emptyPath(),du:!1,fu:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function mf(e){var t=e._freezeSettings(),n=Uh(e._databaseId);return new gf(e._databaseId,!!t.ignoreUndefinedProperties,n)}function pf(e,t,n,r,i,s={}){const a=e.pu(s.merge||s.mergeFields?2:0,t,n,i);Af("Data must be an object, but it was:",a,r);var o=Df(r,a);let u,c;if(s.merge)u=new vs(a.fieldMask),c=a.fieldTransforms;else if(s.mergeFields){const e=[];for(const r of s.mergeFields){const i=Nf(t,r,n);if(!a.contains(i))throw new qr(Br.INVALID_ARGUMENT,`Field '${i}' is specified in your field mask but missing from your input data.`);Lf(e,i)||e.push(i)}u=new vs(e),c=a.fieldTransforms.filter(e=>u.covers(e.field))}else u=null,c=a.fieldTransforms;return new hf(new Ws(o),u,c)}class yf extends of{_toFieldTransform(e){if(2!==e.Iu)throw 1===e.Iu?e.mu(`${this._methodName}() can only appear at the top level of your update data`):e.mu(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof yf}}function vf(e,t,n){return new ff({Iu:3,gu:t.settings.gu,methodName:e._methodName,du:n},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class wf extends of{_toFieldTransform(e){return new co(e.path,new to)}isEqual(e){return e instanceof wf}}class _f extends of{constructor(e,t){super(e),this.yu=t}_toFieldTransform(e){const t=vf(this,e,!0),n=this.yu.map(e=>xf(e,t)),r=new no(n);return new co(e.path,r)}isEqual(e){return this===e}}class bf extends of{constructor(e,t){super(e),this.yu=t}_toFieldTransform(e){const t=vf(this,e,!0),n=this.yu.map(e=>xf(e,t)),r=new io(n);return new co(e.path,r)}isEqual(e){return this===e}}class If extends of{constructor(e,t){super(e),this.wu=t}_toFieldTransform(e){var t=new ao(e.serializer,Ja(e.serializer,this.wu));return new co(e.path,t)}isEqual(e){return this===e}}function Ef(e,i,s,t){const a=e.pu(1,i,s);Af("Data must be an object, but it was:",a,t);const o=[],u=Ws.empty();hs(t,(e,t)=>{var n=Rf(i,e,s);t=m(t);var r=a.Ru(n);if(t instanceof yf)o.push(n);else{const e=xf(t,r);null!=e&&(o.push(n),u.set(n,e))}});var n=new vs(o);return new lf(u,n,a.fieldTransforms)}function Tf(e,t,n,r,i,s){const a=e.pu(1,t,n),o=[Nf(t,r,n)],u=[i];if(s.length%2!=0)throw new qr(Br.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let f=0;f<s.length;f+=2)o.push(Nf(t,s[f])),u.push(s[f+1]);const c=[],h=Ws.empty();for(let g=o.length-1;0<=g;--g)if(!Lf(c,o[g])){const t=o[g];var l=m(l=u[g]);const r=a.Ru(t);if(l instanceof yf)c.push(t);else{const e=xf(l,r);null!=e&&(c.push(t),h.set(t,e))}}var d=new vs(c);return new lf(h,d,a.fieldTransforms)}function Sf(e,t,n,r=!1){return xf(n,e.pu(r?4:3,t))}function xf(e,t){if(Cf(e=m(e)))return Af("Unsupported field value:",t,e),Df(e,t);if(e instanceof of)return function(e,t){if(!df(t.Iu))throw t.mu(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.mu(`${e._methodName}() is not currently supported inside arrays`);var n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.du&&4!==t.Iu)throw t.mu("Nested arrays are not supported");return function(e,t){const n=[];let r=0;for(const i of e){let e=xf(i,t.Vu(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(e,t)}return function(e,t){if(null===(e=m(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return Ja(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){var n=ei.fromDate(e);return{timestampValue:Jo(t.serializer,n)}}if(e instanceof ei){n=new ei(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:Jo(t.serializer,n)}}if(e instanceof uf)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof sf)return{bytesValue:Zo(t.serializer,e._byteString)};if(e instanceof Od){const r=t.databaseId,i=e.firestore._databaseId;if(!i.isEqual(r))throw t.mu(`Document reference is for database ${i.projectId}/${i.database} but should be for database ${r.projectId}/${r.database}`);return{referenceValue:tu(e.firestore._databaseId||t.databaseId,e._key.path)}}throw t.mu(`Unsupported field value: ${Cd(e)}`)}(e,t)}function Df(e,r){const i={};return ls(e)?r.path&&0<r.path.length&&r.fieldMask.push(r.path):hs(e,(e,t)=>{var n=xf(t,r.Eu(e));null!=n&&(i[e]=n)}),{mapValue:{fields:i}}}function Cf(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof ei||e instanceof uf||e instanceof sf||e instanceof Od||e instanceof of)}function Af(e,t,n){if(!Cf(n)||("object"!=typeof(i=n)||null===i||Object.getPrototypeOf(i)!==Object.prototype&&null!==Object.getPrototypeOf(i))){var r=Cd(n);throw"an object"===r?t.mu(e+" a custom object"):t.mu(e+" "+r)}var i}function Nf(e,t,n){if((t=m(t))instanceof af)return t._internalPath;if("string"==typeof t)return Rf(e,t);throw Mf("Field path arguments must be of type string or ",e,!1,void 0,n)}const kf=new RegExp("[~\\*/\\[\\]]");function Rf(t,n,r){if(0<=n.search(kf))throw Mf(`Invalid field path (${n}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,r);try{return new af(...n.split("."))._internalPath}catch(e){throw Mf(`Invalid field path (${n}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,r)}}function Mf(e,t,n,r,i){var s=r&&!r.isEmpty(),a=void 0!==i;let o=`Function ${t}() called with invalid data`;n&&(o+=" (via `toFirestore()`)"),o+=". ";let u="";return(s||a)&&(u+=" (found",s&&(u+=` in field ${r}`),a&&(u+=` in document ${i}`),u+=")"),new qr(Br.INVALID_ARGUMENT,o+e+u)}function Lf(e,t){return e.some(e=>e.isEqual(t))}class Of{constructor(e,t,n,r,i){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=i}get id(){return this._key.path.lastSegment()}get ref(){return new Od(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){var e=new Ff(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){var t=this._document.data.field(Pf("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class Ff extends Of{data(){return super.data()}}function Pf(e,t){return"string"==typeof t?Rf(e,t):(t instanceof af?t:t._delegate)._internalPath}function Vf(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new qr(Br.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Bf{}class qf extends Bf{}function Uf(e,t,...n){let r=[];t instanceof Bf&&r.push(t),r=r.concat(n),function(e){var t=e.filter(e=>e instanceof Gf).length,n=e.filter(e=>e instanceof zf).length;if(1<t||0<t&&0<n)throw new qr(Br.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r);for(const t of r)e=t._apply(e);return e}class zf extends qf{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new zf(e,t,n)}_apply(e){var t=this._parse(e);return Xf(e._query,t),new Ld(e.firestore,e.converter,Ra(e._query,t))}_parse(e){var t=mf(e.firestore);return function(e,t,n,r,i,s,a){let o;if(i.isKeyField()){if("array-contains"===s||"array-contains-any"===s)throw new qr(Br.INVALID_ARGUMENT,`Invalid Query. You can't perform '${s}' queries on documentId().`);if("in"===s||"not-in"===s){Yf(a,s);const t=[];for(const n of a)t.push(Hf(r,e,n));o={arrayValue:{values:t}}}else o=Hf(r,e,a)}else"in"!==s&&"not-in"!==s&&"array-contains-any"!==s||Yf(a,s),o=Sf(n,t,a,"in"===s||"not-in"===s);return ta.create(i,s,o)}(e._query,"where",t,e.firestore._databaseId,this._field,this._op,this._value)}}class Gf extends Bf{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new Gf(e,t)}_parse(t){var e=this._queryConstraints.map(e=>e._parse(t)).filter(e=>0<e.getFilters().length);return 1===e.length?e[0]:na.create(e,this._getOperator())}_apply(e){const t=this._parse(e);return 0===t.getFilters().length?e:(function(e,t){let n=e;for(const e of t.getFlattenedFilters())Xf(n,e),n=Ra(n,e)}(e._query,t),new Ld(e.firestore,e.converter,Ra(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}class jf extends qf{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new jf(e,t)}_apply(e){var t=function(e,t,n){if(null!==e.startAt)throw new qr(Br.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new qr(Br.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new Zs(t,n)}(e._query,this._field,this._direction);return new Ld(e.firestore,e.converter,(e=e._query,t=e.explicitOrderBy.concat([t]),new Sa(e.path,e.collectionGroup,t,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)))}}class Kf extends qf{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new Kf(e,t,n)}_apply(e){return new Ld(e.firestore,e.converter,Ma(e._query,this._limit,this._limitType))}}class $f extends qf{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new $f(e,t,n)}_apply(e){var t,n=Wf(e,this.type,this._docOrFields,this._inclusive);return new Ld(e.firestore,e.converter,(t=e._query,e=n,new Sa(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)))}}class Qf extends qf{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new Qf(e,t,n)}_apply(e){var t,n=Wf(e,this.type,this._docOrFields,this._inclusive);return new Ld(e.firestore,e.converter,(t=e._query,e=n,new Sa(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)))}}function Wf(e,t,n,r){if(n[0]=m(n[0]),n[0]instanceof Of)return function(e,t,n,r,i){if(!r)throw new qr(Br.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const s=[];for(const n of Na(e))if(n.field.isKeyField())s.push(Vs(t,r.key));else{const e=r.data.field(n.field);if(Ss(e))throw new qr(Br.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){const e=n.field.canonicalString();throw new qr(Br.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}s.push(e)}return new Ys(s,i)}(e._query,e.firestore._databaseId,t,n[0]._document,r);var i=mf(e.firestore);return function(e,t,n,r,i,s){const a=e.explicitOrderBy;if(i.length>a.length)throw new qr(Br.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const o=[];for(let u=0;u<i.length;u++){const c=i[u];if(a[u].field.isKeyField()){if("string"!=typeof c)throw new qr(Br.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof c}`);if(!Aa(e)&&-1!==c.indexOf("/"))throw new qr(Br.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${c}' contains a slash.`);const n=e.path.child(ri.fromString(c));if(!ai.isDocumentKey(n))throw new qr(Br.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const i=new ai(n);o.push(Vs(t,i))}else{const e=Sf(n,r,c);o.push(e)}}return new Ys(o,s)}(e._query,e.firestore._databaseId,i,t,n,r)}function Hf(e,t,n){if("string"==typeof(n=m(n))){if(""===n)throw new qr(Br.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!Aa(t)&&-1!==n.indexOf("/"))throw new qr(Br.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);var r=t.path.child(ri.fromString(n));if(!ai.isDocumentKey(r))throw new qr(Br.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return Vs(e,new ai(r))}if(n instanceof Od)return Vs(e,n._key);throw new qr(Br.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Cd(n)}.`)}function Yf(e,t){if(!Array.isArray(e)||0===e.length)throw new qr(Br.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function Xf(e,t){const n=function(e,t){for(const n of e)for(const e of n.getFlattenedFilters())if(0<=t.indexOf(e.op))return e.op;return null}(e.filters,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==n)throw n===t.op?new qr(Br.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new qr(Br.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${n.toString()}' filters.`)}class Jf{convertValue(e,t="none"){switch(Rs(e)){case 0:return null;case 1:return e.booleanValue;case 2:return Es(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(Ts(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw Pr()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,n="none"){const r={};return hs(e,(e,t)=>{r[e]=this.convertValue(t,n)}),r}convertGeoPoint(e){return new uf(Es(e.latitude),Es(e.longitude))}convertArray(e,t){return(e.values||[]).map(e=>this.convertValue(e,t))}convertServerTimestamp(e,t){switch(t){case"previous":var n=xs(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(Ds(e));default:return null}}convertTimestamp(e){var t=Is(e);return new ei(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=ri.fromString(e);Vr(_u(n));const r=new As(n.get(1),n.get(3)),i=new ai(n.popFirst(5));return r.isEqual(t)||Lr(`Document ${i} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),i}}function Zf(e,t,n){return e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t}class eg extends Jf{constructor(e){super(),this.firestore=e}convertBytes(e){return new sf(e)}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return new Od(this.firestore,null,t)}}class tg{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class ng extends Of{constructor(e,t,n,r,i,s){super(e,t,n,r,s),this._firestore=e,this._firestoreImpl=e,this.metadata=i}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){var t=new rg(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){var n=this._document.data.field(Pf("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class rg extends ng{data(e={}){return super.data(e)}}class ig{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new tg(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const t=[];return this.forEach(e=>t.push(e)),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,n){this._snapshot.docs.forEach(e=>{t.call(n,new rg(this._firestore,this._userDataWriter,e.key,e,new tg(this._snapshot.mutatedKeys.has(e.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){var t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new qr(Br.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(s,t){if(s._snapshot.oldDocs.isEmpty()){let n=0;return s._snapshot.docChanges.map(e=>{var t=new rg(s._firestore,s._userDataWriter,e.doc.key,e.doc,new tg(s._snapshot.mutatedKeys.has(e.doc.key),s._snapshot.fromCache),s.query.converter);return e.doc,{type:"added",doc:t,oldIndex:-1,newIndex:n++}})}{let i=s._snapshot.oldDocs;return s._snapshot.docChanges.filter(e=>t||3!==e.type).map(e=>{var t=new rg(s._firestore,s._userDataWriter,e.doc.key,e.doc,new tg(s._snapshot.mutatedKeys.has(e.doc.key),s._snapshot.fromCache),s.query.converter);let n=-1,r=-1;return 0!==e.type&&(n=i.indexOf(e.doc.key),i=i.delete(e.doc.key)),1!==e.type&&(i=i.add(e.doc),r=i.indexOf(e.doc.key)),{type:function(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return Pr()}}(e.type),doc:t,oldIndex:n,newIndex:r}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function sg(e,t){return e instanceof ng&&t instanceof ng?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof ig&&t instanceof ig&&e._firestore===t._firestore&&qd(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}class ag extends Jf{constructor(e){super(),this.firestore=e}convertBytes(e){return new sf(e)}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return new Od(this.firestore,null,t)}}function og(t){t=Ad(t,Od);const n=Ad(t.firestore,Hd),e=Yd(n),r=new ag(n);return function(e,t){const n=new Ur;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{const i=await function(e,t){const n=e;return n.persistence.runTransaction("read document","readonly",e=>n.localDocuments.getDocument(e,t))}(e,t);i.isFoundDocument()?n.resolve(i):i.isNoDocument()?n.resolve(null):n.reject(new qr(Br.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(e){var r=pl(e,`Failed to get document '${t} from cache`);n.reject(r)}}(await md(e),t,n)),n.promise}(e,t._key).then(e=>new ng(n,r,t._key,e,new tg(null!==e&&e.hasLocalMutations,!0),t.converter))}function ug(t){t=Ad(t,Ld);const n=Ad(t.firestore,Hd),e=Yd(n),r=new ag(n);return function(e,t){const n=new Ur;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{const i=await yh(e,t,!0),s=new Rl(t,i.ls),a=s.ca(i.documents),o=s.applyChanges(a,!1);n.resolve(o.snapshot)}catch(e){var r=pl(e,`Failed to execute query '${t} against cache`);n.reject(r)}}(await md(e),t,n)),n.promise}(e,t._query).then(e=>new ig(n,r,t,e))}function cg(e,t,n){e=Ad(e,Od);var r=Ad(e.firestore,Hd),i=Zf(e.converter,t,n);return fg(r,[pf(mf(r),"setDoc",e._key,i,null!==e.converter,n).toMutation(e._key,lo.none())])}function hg(e,t,n,...r){e=Ad(e,Od);var i=Ad(e.firestore,Hd),s=mf(i);let a;return a="string"==typeof(t=m(t))||t instanceof af?Tf(s,"updateDoc",e._key,t,n,r):Ef(s,"updateDoc",e._key,t),fg(i,[a.toMutation(e._key,lo.exists(!0))])}function lg(t,...n){var e;t=m(t);let r={includeMetadataChanges:!1},i=0;"object"!=typeof n[i]||zd(n[i])||(r=n[i],i++);var s={includeMetadataChanges:r.includeMetadataChanges};if(zd(n[i])){const t=n[i];n[i]=null===(e=t.next)||void 0===e?void 0:e.bind(t),n[i+1]=null===(e=t.error)||void 0===e?void 0:e.bind(t),n[i+2]=null===(e=t.complete)||void 0===e?void 0:e.bind(t)}let a,o,u;if(t instanceof Od)o=Ad(t.firestore,Hd),u=Da(t._key.path),a={next:e=>{n[i]&&n[i](gg(o,t,e))},error:n[i+1],complete:n[i+2]};else{const c=Ad(t,Ld);o=Ad(c.firestore,Hd),u=c._query;const h=new ag(o);a={next:e=>{n[i]&&n[i](new ig(o,h,c,e))},error:n[i+1],complete:n[i+2]},Vf(t._query)}return function(e,t,n,r){const i=new id(r),s=new Sl(t,i,n);return e.asyncQueue.enqueueAndForget(async()=>Il(await vd(e),s)),()=>{i.Na(),e.asyncQueue.enqueueAndForget(async()=>El(await vd(e),s))}}(Yd(o),u,s,a)}function dg(e,t){return function(e,t){const n=new id(t);return e.asyncQueue.enqueueAndForget(async()=>function(e,t){e.q_.add(t),t.next()}(await vd(e),n)),()=>{n.Na(),e.asyncQueue.enqueueAndForget(async()=>function(e,t){e.q_.delete(t)}(await vd(e),n))}}(Yd(e=Ad(e,Hd)),zd(t)?t:{next:t})}function fg(e,t){return function(e,t){const n=new Ur;return e.asyncQueue.enqueueAndForget(async()=>Pl(await yd(e),t,n)),n.promise}(Yd(e),t)}function gg(e,t,n){var r=n.docs.get(t._key),i=new ag(e);return new ng(e,i,t._key,r,new tg(n.hasPendingWrites,n.fromCache),t.converter)}const mg={maxAttempts:5};class pg{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=mf(e)}set(e,t,n){this._verifyNotCommitted();const r=yg(e,this._firestore),i=Zf(r.converter,t,n),s=pf(this._dataReader,"WriteBatch.set",r._key,i,null!==r.converter,n);return this._mutations.push(s.toMutation(r._key,lo.none())),this}update(e,t,n,...r){this._verifyNotCommitted();var i=yg(e,this._firestore);let s;return s="string"==typeof(t=m(t))||t instanceof af?Tf(this._dataReader,"WriteBatch.update",i._key,t,n,r):Ef(this._dataReader,"WriteBatch.update",i._key,t),this._mutations.push(s.toMutation(i._key,lo.exists(!0))),this}delete(e){this._verifyNotCommitted();var t=yg(e,this._firestore);return this._mutations=this._mutations.concat(new To(t._key,lo.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,0<this._mutations.length?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new qr(Br.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function yg(e,t){if((e=m(e)).firestore!==t)throw new qr(Br.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class vg extends class{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=mf(e)}get(e){const n=yg(e,this._firestore),r=new eg(this._firestore);return this._transaction.lookup([n._key]).then(e=>{if(!e||1!==e.length)return Pr();const t=e[0];if(t.isFoundDocument())return new Of(this._firestore,r,t.key,t,n.converter);if(t.isNoDocument())return new Of(this._firestore,r,n._key,null,n.converter);throw Pr()})}set(e,t,n){var r=yg(e,this._firestore),i=Zf(r.converter,t,n),i=pf(this._dataReader,"Transaction.set",r._key,i,null!==r.converter,n);return this._transaction.set(r._key,i),this}update(e,t,n,...r){var i=yg(e,this._firestore),s="string"==typeof(t=m(t))||t instanceof af?Tf(this._dataReader,"Transaction.update",i._key,t,n,r):Ef(this._dataReader,"Transaction.update",i._key,t);return this._transaction.update(i._key,s),this}delete(e){var t=yg(e,this._firestore);return this._transaction.delete(t._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=yg(e,this._firestore),n=new ag(this._firestore);return super.get(e).then(e=>new ng(this._firestore,n,t._key,e._document,new tg(!1,!1),t.converter))}}function wg(t,n,e){t=Ad(t,Hd);var r=Object.assign(Object.assign({},mg),e);return function(e){if(e.maxAttempts<1)throw new qr(Br.INVALID_ARGUMENT,"Max attempts must be at least 1")}(r),function(t,n,r){const i=new Ur;return t.asyncQueue.enqueueAndForget(async()=>{var e=await fd(t).then(e=>e.datastore);new od(t.asyncQueue,e,r,n,i).run()}),i.promise}(Yd(t),e=>n(new vg(t,e)),r)}Kd=!0,$d=$g.SDK_VERSION,Nr=$d,$g._registerComponent(new p("firestore",(e,{instanceIdentifier:t,options:n})=>{const r=e.getProvider("app").getImmediate(),i=new Hd(new Kr(e.getProvider("auth-internal")),new Hr(e.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new qr(Br.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new As(e.options.projectId,t)}(r,t),r);return n=Object.assign({useFetchStreams:Kd},n),i._setSettings(n),i},"PUBLIC").setMultipleInstances(!0)),$g.registerVersion(Cr,"4.4.0",jd),$g.registerVersion(Cr,"4.4.0","esm2017");function _g(e,t){if(void 0===t)return{merge:!1};if(void 0!==t.mergeFields&&void 0!==t.merge)throw new qr("invalid-argument",`Invalid options passed to function ${e}(): You cannot `+'specify both "merge" and "mergeFields".');return t}function bg(){if("undefined"==typeof Uint8Array)throw new qr("unimplemented","Uint8Arrays are not available in this environment.")}function Ig(){if("undefined"==typeof atob)throw new qr("unimplemented","Blobs are unavailable in Firestore in this environment.")}class Eg{constructor(e){this._delegate=e}static fromBase64String(e){return Ig(),new Eg(sf.fromBase64String(e))}static fromUint8Array(e){return bg(),new Eg(sf.fromUint8Array(e))}toBase64(){return Ig(),this._delegate.toBase64()}toUint8Array(){return bg(),this._delegate.toUint8Array()}isEqual(e){return this._delegate.isEqual(e._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}}function Tg(e){return function(e,t){if("object"!=typeof e||null===e)return;var n=e;for(const r of t)if(r in n&&"function"==typeof n[r])return 1;return}(e,["next","error","complete"])}class Sg{enableIndexedDbPersistence(e,t){return function(e,t){rf(e=Ad(e,Hd));var n=Yd(e);if(n._uninitializedComponentsProvider)throw new qr(Br.FAILED_PRECONDITION,"SDK cache is already specified.");Or("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");var r=e._freezeSettings(),i=new nd;return Jd(n,i,new ed(i,r.cacheSizeBytes,null==t?void 0:t.forceOwnership))}(e._delegate,{forceOwnership:t})}enableMultiTabIndexedDbPersistence(e){return function(e){rf(e=Ad(e,Hd));var t=Yd(e);if(t._uninitializedComponentsProvider)throw new qr(Br.FAILED_PRECONDITION,"SDK cache is already specified.");Or("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");var n=e._freezeSettings(),r=new nd;return Jd(t,r,new td(r,n.cacheSizeBytes))}(e._delegate)}clearIndexedDbPersistence(e){return function(e){if(e._initialized&&!e._terminated)throw new qr(Br.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const t=new Ur;return e._queue.enqueueAndForgetEvenWhileRestricted(async()=>{try{await async function(e){if(!bi.D())return Promise.resolve();var t=e+"main";await bi.delete(t)}(sh(e._databaseId,e._persistenceKey)),t.resolve()}catch(e){t.reject(e)}}),t.promise}(e._delegate)}}class xg{constructor(e,t,n){this._delegate=t,this._persistenceProvider=n,this.INTERNAL={delete:()=>this.terminate()},e instanceof As||(this._appCompat=e)}get _databaseId(){return this._delegate._databaseId}settings(e){var t=this._delegate._getSettings();e.merge||t.host===e.host||Or("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),e.merge&&delete(e=Object.assign(Object.assign({},t),e)).merge,this._delegate._setSettings(e)}useEmulator(e,t,n={}){Md(this._delegate,e,t,n)}enableNetwork(){return ef(this._delegate)}disableNetwork(){return tf(this._delegate)}enablePersistence(e){let t=!1,n=!1;return e&&(t=!!e.synchronizeTabs,n=!!e.experimentalForceOwningTab,Sd("synchronizeTabs",t,"experimentalForceOwningTab",n)),t?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,n)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){return Zd(this._delegate)}onSnapshotsInSync(e){return dg(this._delegate,e)}get app(){if(!this._appCompat)throw new qr("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._appCompat}collection(e){try{return new qg(this,Pd(this._delegate,e))}catch(e){throw Rg(e,"collection()","Firestore.collection()")}}doc(e){try{return new kg(this,Vd(this._delegate,e))}catch(e){throw Rg(e,"doc()","Firestore.doc()")}}collectionGroup(e){try{return new Pg(this,function(e,t){if(e=Ad(e,Rd),Td("collectionGroup","collection id",t),0<=t.indexOf("/"))throw new qr(Br.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new Ld(e,null,(t=t,new Sa(ri.emptyPath(),t)))}(this._delegate,e))}catch(e){throw Rg(e,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(t){return wg(this._delegate,e=>t(new Cg(this,e)))}batch(){return Yd(this._delegate),new Ag(new pg(this._delegate,e=>fg(this._delegate,e)))}loadBundle(e){return t=this._delegate,e=e,n=Yd(t=Ad(t,Hd)),r=new Gd,bd(n,t._databaseId,e,r),r;var t,n,r}namedQuery(e){return nf(this._delegate,e).then(e=>e?new Pg(this,e):null)}}class Dg extends Jf{constructor(e){super(),this.firestore=e}convertBytes(e){return new Eg(new sf(e))}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return kg.forKey(t,this.firestore,null)}}class Cg{constructor(e,t){this._firestore=e,this._delegate=t,this._userDataWriter=new Dg(e)}get(e){const t=Ug(e);return this._delegate.get(t).then(e=>new Og(this._firestore,new ng(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,t.converter)))}set(e,t,n){var r=Ug(e);return n?(_g("Transaction.set",n),this._delegate.set(r,t,n)):this._delegate.set(r,t),this}update(e,t,n,...r){var i=Ug(e);return 2===arguments.length?this._delegate.update(i,t):this._delegate.update(i,t,n,...r),this}delete(e){var t=Ug(e);return this._delegate.delete(t),this}}class Ag{constructor(e){this._delegate=e}set(e,t,n){var r=Ug(e);return n?(_g("WriteBatch.set",n),this._delegate.set(r,t,n)):this._delegate.set(r,t),this}update(e,t,n,...r){var i=Ug(e);return 2===arguments.length?this._delegate.update(i,t):this._delegate.update(i,t,n,...r),this}delete(e){var t=Ug(e);return this._delegate.delete(t),this}commit(){return this._delegate.commit()}}class Ng{constructor(e,t,n){this._firestore=e,this._userDataWriter=t,this._delegate=n}fromFirestore(e,t){var n=new rg(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,null);return this._delegate.fromFirestore(new Fg(this._firestore,n),null!=t?t:{})}toFirestore(e,t){return t?this._delegate.toFirestore(e,t):this._delegate.toFirestore(e)}static getInstance(e,t){const n=Ng.INSTANCES;let r=n.get(e);r||(r=new WeakMap,n.set(e,r));let i=r.get(t);return i||(i=new Ng(e,new Dg(e),t),r.set(t,i)),i}}Ng.INSTANCES=new WeakMap;class kg{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new Dg(e)}static forPath(e,t,n){if(e.length%2!=0)throw new qr("invalid-argument","Invalid document reference. Document references must have an even number of segments, but "+`${e.canonicalString()} has ${e.length}`);return new kg(t,new Od(t._delegate,n,new ai(e)))}static forKey(e,t,n){return new kg(t,new Od(t._delegate,n,e))}get id(){return this._delegate.id}get parent(){return new qg(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(e){try{return new qg(this.firestore,Pd(this._delegate,e))}catch(e){throw Rg(e,"collection()","DocumentReference.collection()")}}isEqual(e){return(e=m(e))instanceof Od&&Bd(this._delegate,e)}set(e,t){t=_g("DocumentReference.set",t);try{return t?cg(this._delegate,e,t):cg(this._delegate,e)}catch(e){throw Rg(e,"setDoc()","DocumentReference.set()")}}update(e,t,...n){try{return 1===arguments.length?hg(this._delegate,e):hg(this._delegate,e,t,...n)}catch(e){throw Rg(e,"updateDoc()","DocumentReference.update()")}}delete(){return fg(Ad((e=this._delegate).firestore,Hd),[new To(e._key,lo.none())]);var e}onSnapshot(...e){var t=Mg(e),n=Lg(e,e=>new Og(this.firestore,new ng(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter)));return lg(this._delegate,t,n)}get(e){let t;return t=("cache"===(null==e?void 0:e.source)?og:"server"===(null==e?void 0:e.source)?function(t){t=Ad(t,Od);const n=Ad(t.firestore,Hd);return wd(Yd(n),t._key,{source:"server"}).then(e=>gg(n,t,e))}:function(t){t=Ad(t,Od);const n=Ad(t.firestore,Hd);return wd(Yd(n),t._key).then(e=>gg(n,t,e))})(this._delegate),t.then(e=>new Og(this.firestore,new ng(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter)))}withConverter(e){return new kg(this.firestore,e?this._delegate.withConverter(Ng.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function Rg(e,t,n){return e.message=e.message.replace(t,n),e}function Mg(e){for(const t of e)if("object"==typeof t&&!Tg(t))return t;return{}}function Lg(e,t){var n;let r;return r=Tg(e[0])?e[0]:Tg(e[1])?e[1]:"function"==typeof e[0]?{next:e[0],error:e[1],complete:e[2]}:{next:e[1],error:e[2],complete:e[3]},{next:e=>{r.next&&r.next(t(e))},error:null===(n=r.error)||void 0===n?void 0:n.bind(r),complete:null===(n=r.complete)||void 0===n?void 0:n.bind(r)}}class Og{constructor(e,t){this._firestore=e,this._delegate=t}get ref(){return new kg(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(e){return this._delegate.data(e)}get(e,t){return this._delegate.get(e,t)}isEqual(e){return sg(this._delegate,e._delegate)}}class Fg extends Og{data(e){var t=this._delegate.data(e);return this._delegate._converter||void 0!==t||Pr(),t}}class Pg{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new Dg(e)}where(e,t,n){try{return new Pg(this.firestore,Uf(this._delegate,(r=n,i=t,s=Pf("where",e),zf._create(s,i,r))))}catch(e){throw Rg(e,/(orderBy|where)\(\)/,"Query.$1()")}var r,i,s}orderBy(e,t){try{return new Pg(this.firestore,Uf(this._delegate,([n,r="asc"]=[e,t],i=r,s=Pf("orderBy",n),jf._create(s,i))))}catch(e){throw Rg(e,/(orderBy|where)\(\)/,"Query.$1()")}var n,r,i,s}limit(e){try{return new Pg(this.firestore,Uf(this._delegate,(Nd("limit",t=e),Kf._create("limit",t,"F"))))}catch(e){throw Rg(e,"limit()","Query.limit()")}var t}limitToLast(e){try{return new Pg(this.firestore,Uf(this._delegate,(Nd("limitToLast",t=e),Kf._create("limitToLast",t,"L"))))}catch(e){throw Rg(e,"limitToLast()","Query.limitToLast()")}var t}startAt(...e){try{return new Pg(this.firestore,Uf(this._delegate,function(...e){return $f._create("startAt",e,!0)}(...e)))}catch(e){throw Rg(e,"startAt()","Query.startAt()")}}startAfter(...e){try{return new Pg(this.firestore,Uf(this._delegate,function(...e){return $f._create("startAfter",e,!1)}(...e)))}catch(e){throw Rg(e,"startAfter()","Query.startAfter()")}}endBefore(...e){try{return new Pg(this.firestore,Uf(this._delegate,function(...e){return Qf._create("endBefore",e,!1)}(...e)))}catch(e){throw Rg(e,"endBefore()","Query.endBefore()")}}endAt(...e){try{return new Pg(this.firestore,Uf(this._delegate,function(...e){return Qf._create("endAt",e,!0)}(...e)))}catch(e){throw Rg(e,"endAt()","Query.endAt()")}}isEqual(e){return qd(this._delegate,e._delegate)}get(e){let t;return t=("cache"===(null==e?void 0:e.source)?ug:"server"===(null==e?void 0:e.source)?function(t){t=Ad(t,Ld);const n=Ad(t.firestore,Hd),e=Yd(n),r=new ag(n);return _d(e,t._query,{source:"server"}).then(e=>new ig(n,r,t,e))}:function(t){t=Ad(t,Ld);const n=Ad(t.firestore,Hd),e=Yd(n),r=new ag(n);return Vf(t._query),_d(e,t._query).then(e=>new ig(n,r,t,e))})(this._delegate),t.then(e=>new Bg(this.firestore,new ig(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot)))}onSnapshot(...e){var t=Mg(e),n=Lg(e,e=>new Bg(this.firestore,new ig(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot)));return lg(this._delegate,t,n)}withConverter(e){return new Pg(this.firestore,e?this._delegate.withConverter(Ng.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}class Vg{constructor(e,t){this._firestore=e,this._delegate=t}get type(){return this._delegate.type}get doc(){return new Fg(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}}class Bg{constructor(e,t){this._firestore=e,this._delegate=t}get query(){return new Pg(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map(e=>new Fg(this._firestore,e))}docChanges(e){return this._delegate.docChanges(e).map(e=>new Vg(this._firestore,e))}forEach(t,n){this._delegate.forEach(e=>{t.call(n,new Fg(this._firestore,e))})}isEqual(e){return sg(this._delegate,e._delegate)}}class qg extends Pg{constructor(e,t){super(e,t),this.firestore=e,this._delegate=t}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){var e=this._delegate.parent;return e?new kg(this.firestore,e):null}doc(e){try{return void 0===e?new kg(this.firestore,Vd(this._delegate)):new kg(this.firestore,Vd(this._delegate,e))}catch(e){throw Rg(e,"doc()","CollectionReference.doc()")}}add(e){return function(e,t){const n=Ad(e.firestore,Hd),r=Vd(e),i=Zf(e.converter,t);return fg(n,[pf(mf(e.firestore),"addDoc",r._key,i,null!==e.converter,{}).toMutation(r._key,lo.exists(!1))]).then(()=>r)}(this._delegate,e).then(e=>new kg(this.firestore,e))}isEqual(e){return Bd(this._delegate,e._delegate)}withConverter(e){return new qg(this.firestore,e?this._delegate.withConverter(Ng.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function Ug(e){return Ad(e,Od)}const zg={Firestore:xg,GeoPoint:uf,Timestamp:ei,Blob:Eg,Transaction:Cg,WriteBatch:Ag,DocumentReference:kg,DocumentSnapshot:Og,Query:Pg,QueryDocumentSnapshot:Fg,QuerySnapshot:Bg,CollectionReference:qg,FieldPath:class Gg{constructor(...e){this._delegate=new af(...e)}static documentId(){return new Gg(si.keyField().canonicalString())}isEqual(e){return(e=m(e))instanceof af&&this._delegate._internalPath.isEqual(e._internalPath)}},FieldValue:class jg{constructor(e){this._delegate=e}static serverTimestamp(){const e=new wf("serverTimestamp");return e._methodName="FieldValue.serverTimestamp",new jg(e)}static delete(){const e=new yf("deleteField");return e._methodName="FieldValue.delete",new jg(e)}static arrayUnion(...e){const t=function(...e){return new _f("arrayUnion",e)}(...e);return t._methodName="FieldValue.arrayUnion",new jg(t)}static arrayRemove(...e){const t=function(...e){return new bf("arrayRemove",e)}(...e);return t._methodName="FieldValue.arrayRemove",new jg(t)}static increment(e){const t=new If("increment",e);return t._methodName="FieldValue.increment",new jg(t)}isEqual(e){return this._delegate.isEqual(e._delegate)}},setLogLevel:function(e){e=e,kr.setLogLevel(e)},CACHE_SIZE_UNLIMITED:-1};Qd=t.default,Wd=(e,t)=>new xg(e,t,new Sg),Qd.INTERNAL.registerComponent(new p("firestore-compat",e=>{var t=e.getProvider("app-compat").getImmediate(),n=e.getProvider("firestore").getImmediate();return Wd(t,n)},"PUBLIC").setServiceProps(Object.assign({},zg))),Qd.registerVersion("@firebase/firestore-compat","0.3.23")}).apply(this,arguments)}catch(e){throw console.error(e),new Error("Cannot instantiate firebase-firestore-compat.js - be sure to load firebase-app.js first.")}});
//# sourceMappingURL=firebase-firestore-compat.js.map
